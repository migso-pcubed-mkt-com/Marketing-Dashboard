<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIGSO-PCUBED Marketing Tracker V2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--primary:#2c2b64;--secondary:#3781ec;--green:#5cc29d;--red:#ff5338;--yellow:#f2cb13}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Plus Jakarta Sans',sans-serif}
        body.light{background:#f8f9fc;color:#1a1a2e}
        body.dark{background:#0f0f1a;color:#f0f0f5}
        ::-webkit-scrollbar{width:6px;height:6px}
        ::-webkit-scrollbar-thumb{background:#888;border-radius:3px}
        @keyframes slideIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
        @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        .animate-slide-in{animation:slideIn .3s ease-out}
        .animate-slide-up{animation:slideUp .3s ease-out}
        .card-hover{transition:all .2s ease}
        .card-hover:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,.15)}
        .dragging{opacity:0.5!important;cursor:grabbing!important;transform:rotate(2deg)}
        .touch-dragging{opacity:0.7;transform:scale(1.02);z-index:1000}
        [draggable=true]{cursor:grab}
        [draggable=true]:active{cursor:grabbing}
        @media(hover:none){.card-hover:active{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,.15)}}
        .kanban-column{min-height:400px}
        .modal-backdrop{backdrop-filter:blur(8px)}
        .line-clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
        .drag-over{border:2px dashed var(--secondary)!important;background:rgba(55,129,236,.1)!important;transition:all .2s}
        .timeline-bar{position:relative;cursor:move;transition:opacity .2s}
        .timeline-bar:hover .resize-handle{opacity:1}
        .resize-handle{position:absolute;top:0;bottom:0;width:8px;opacity:0;transition:opacity 0.2s;z-index:10;cursor:col-resize}
        .resize-handle:hover{background:rgba(255,255,255,0.3)}
        .resize-handle-left{left:0;border-left:2px solid rgba(255,255,255,0.5)}
        .resize-handle-right{right:0;border-right:2px solid rgba(255,255,255,0.5)}
        @media(max-width:768px){
            .kanban-column{min-width:280px}
            .resize-handle{width:16px;opacity:0.3}
            .timeline-bar{min-height:48px}
        }
        @media(hover:none)and(pointer:coarse){
            .resize-handle{opacity:0.4;width:20px}
            [draggable=true]{cursor:default}
            .card-hover{transition:transform 0.1s}
            .card-hover:active{transform:scale(0.98)}
        }
    </style>
    <script>tailwind.config={darkMode:'class',theme:{extend:{colors:{primary:'#2c2b64',secondary:'#3781ec',accent:{green:'#5cc29d',red:'#ff5338',yellow:'#f2cb13'}}}}}</script>
</head>
<body class="light">
<div id="root"></div>
<script type="text/babel">
const{useState,useEffect,useRef,createContext,useContext,useCallback,useMemo}=React;

// CONFIG
const CONFIG={
    MONTHS:['Jan','F√©v','Mar','Avr','Mai','Jun','Jul','Ao√ª','Sep','Oct','Nov','D√©c'],
    MONTHS_FULL:['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'],
    STATUSES:[
        {id:'todo',name:'√Ä faire',color:'#94a3b8',icon:'üìã'},
        {id:'creating',name:'En cr√©ation',color:'#f2cb13',icon:'‚úèÔ∏è'},
        {id:'inprogress',name:'En cours',color:'#3781ec',icon:'üîÑ'},
        {id:'review',name:'En revue',color:'#a855f7',icon:'üëÄ'},
        {id:'completed',name:'Termin√©',color:'#5cc29d',icon:'‚úÖ'},
        {id:'paused',name:'En pause',color:'#ff5338',icon:'‚è∏Ô∏è'}
    ],
    CATEGORIES:[
        {id:'brand-awareness',name:'Brand Awareness',color:'#3781ec',gradient:'from-blue-500 to-indigo-700'},
        {id:'consideration',name:'Consideration / Engagement',color:'#5cc29d',gradient:'from-emerald-400 to-cyan-500'},
        {id:'conversion',name:'Conversion',color:'#f2cb13',gradient:'from-yellow-400 to-orange-500'}
    ],
    CHANNELS:[{id:'social',name:'Social Media',color:'#3b82f6'},{id:'gads',name:'Google Ads',color:'#ea4335'},{id:'lads',name:'LinkedIn Ads',color:'#0077b5'},{id:'email',name:'Email',color:'#f59e0b'},{id:'press',name:'Press',color:'#8b5cf6'},{id:'events',name:'Events',color:'#ec4899'},{id:'seo',name:'Article/SEO',color:'#10b981'},{id:'web',name:'Website',color:'#6366f1'},{id:'video',name:'Video',color:'#ef4444'},{id:'lp',name:'Landing Page',color:'#14b8a6'},{id:'ia',name:'IA',color:'#a855f7'},{id:'auto',name:'Automation',color:'#f97316'},{id:'other',name:'Other',color:'#6b7280'}],PRIORITIES:[
        {id:'high',name:'Haute',color:'#ff5338',icon:'üî¥'},
        {id:'medium',name:'Moyenne',color:'#f2cb13',icon:'üü°'},
        {id:'low',name:'Basse',color:'#5cc29d',icon:'üü¢'}
    ]
};

// DEMO DATA - Synchronized with data.json
const ACTIONS=[
    {id:'a1',name:'Global MP Brand (Social Media)',categoryId:'brand-awareness',budget:0,priority:'high',tags:['social']},
    {id:'a2',name:'Employeur Brand',categoryId:'brand-awareness',budget:0,priority:'medium',tags:['social','video']},
    {id:'a3',name:'Google Ads - Brand',categoryId:'brand-awareness',budget:12000,priority:'high',tags:['gads']},
    {id:'a4',name:'LinkedIn Ads - Brand',categoryId:'brand-awareness',budget:18000,priority:'high',tags:['lads']},
    {id:'a5',name:'Press Relations',categoryId:'brand-awareness',budget:30000,priority:'medium',tags:['press']},
    {id:'a6',name:'On-Time-Delivery Campaign',categoryId:'consideration',budget:0,priority:'high',tags:['seo','social']},
    {id:'a7',name:'Time-To-Market Campaign',categoryId:'consideration',budget:0,priority:'medium',tags:['seo']},
    {id:'a8',name:'SEO Optimizations',categoryId:'consideration',budget:5000,priority:'medium',tags:['seo','web']},
    {id:'a9',name:'Google Ads - Lead Gen',categoryId:'conversion',budget:12000,priority:'high',tags:['gads','lp']},
    {id:'a10',name:'LinkedIn Ads - Lead Gen',categoryId:'conversion',budget:9000,priority:'high',tags:['lads','lp']},
    {id:'a11',name:'Business Events',categoryId:'conversion',budget:10000,priority:'high',tags:['events']},
    {id:'a12',name:'Event Participation',categoryId:'conversion',budget:5000,priority:'medium',tags:['events']}
];

const TASKS=[
    {id:'t1',actionId:'a1',month:0,startDate:'2026-01-01',title:'V≈ìux nouvel an',description:'Post LinkedIn + Instagram',status:'completed',priority:'high',dueDate:'2026-01-15',checklist:[{id:'c1',text:'Cr√©er visuel',done:true},{id:'c2',text:'R√©diger texte',done:true}],comments:[{id:'cm1',author:'Fabien',text:'Bon engagement!',date:'2026-01-16'}],attachments:[],channels:['social']},
    {id:'t2',actionId:'a1',month:9,startDate:'2026-10-01',title:'Pink October',description:'Campagne Octobre Rose',status:'todo',priority:'medium',dueDate:'2026-10-01',checklist:[],comments:[],attachments:[],channels:['social']},
    {id:'t3',actionId:'a1',month:10,startDate:'2026-11-01',title:'Movember',description:'Campagne Movember',status:'todo',priority:'medium',dueDate:'2026-11-01',checklist:[],comments:[],attachments:[],channels:['social']},
    {id:'t4',actionId:'a1',month:11,startDate:'2026-12-01',title:'V≈ìux + Video Recap',description:'Vid√©o r√©cap ann√©e',status:'todo',priority:'high',dueDate:'2026-12-20',checklist:[],comments:[],attachments:[],channels:['social']},
    {id:'t5',actionId:'a2',month:1,startDate:'2026-02-01',title:'Content F√©vrier',description:'Contenu marque employeur',status:'inprogress',priority:'medium',dueDate:'2026-02-28',checklist:[{id:'c3',text:'Brief',done:true},{id:'c4',text:'Production',done:false}],comments:[],attachments:[],channels:['social','video']},
    {id:'t6',actionId:'a2',month:3,startDate:'2026-04-01',title:'Content Avril',description:'Contenu marque employeur',status:'todo',priority:'medium',dueDate:'2026-04-30',checklist:[],comments:[],attachments:[],channels:['social','video']},
    {id:'t7',actionId:'a3',month:1,startDate:'2026-02-01',title:'Google Ads F√©v',description:'Budget 2000‚Ç¨',status:'inprogress',priority:'high',dueDate:'2026-02-28',budget:2000,checklist:[{id:'c5',text:'Setup',done:true}],comments:[],attachments:[],channels:['gads']},
    {id:'t8',actionId:'a3',month:2,startDate:'2026-03-01',title:'Google Ads Mar',description:'Budget 2000‚Ç¨',status:'creating',priority:'high',dueDate:'2026-03-31',budget:2000,checklist:[],comments:[],attachments:[],channels:['gads']},
    {id:'t9',actionId:'a3',month:3,startDate:'2026-04-01',title:'Google Ads Avr',description:'Budget 2000‚Ç¨',status:'todo',priority:'high',dueDate:'2026-04-30',budget:2000,checklist:[],comments:[],attachments:[],channels:['gads']},
    {id:'t10',actionId:'a4',month:1,startDate:'2026-02-01',title:'LinkedIn Ads F√©v',description:'Budget 3000‚Ç¨',status:'inprogress',priority:'high',dueDate:'2026-02-28',budget:3000,checklist:[],comments:[],attachments:[],channels:['lads']},
    {id:'t11',actionId:'a4',month:2,startDate:'2026-03-01',title:'LinkedIn Ads Mar',description:'Budget 3000‚Ç¨',status:'creating',priority:'high',dueDate:'2026-03-31',budget:3000,checklist:[],comments:[],attachments:[],channels:['lads']},
    {id:'t12',actionId:'a5',month:2,startDate:'2026-03-01',title:'PR Mars',description:'Relations presse Q1',status:'todo',priority:'medium',dueDate:'2026-03-31',budget:10000,checklist:[],comments:[],attachments:[],channels:['press']},
    {id:'t13',actionId:'a6',month:2,startDate:'2026-03-01',title:'OTD Content Mars',description:'Contenu OTD',status:'creating',priority:'high',dueDate:'2026-03-15',checklist:[{id:'c6',text:'Research',done:true},{id:'c7',text:'Writing',done:false}],comments:[],attachments:[],channels:['seo','social']},
    {id:'t14',actionId:'a6',month:3,startDate:'2026-04-01',title:'OTD Content Avril',description:'Contenu OTD',status:'todo',priority:'high',dueDate:'2026-04-15',checklist:[],comments:[],attachments:[],channels:['seo','social']},
    {id:'t15',actionId:'a7',month:8,startDate:'2026-09-01',title:'TTM Content Sep',description:'Contenu TTM',status:'todo',priority:'medium',dueDate:'2026-09-15',checklist:[],comments:[],attachments:[],channels:['seo']},
    {id:'t16',actionId:'a9',month:1,startDate:'2026-02-01',title:'Google Lead Gen F√©v',description:'Budget 2000‚Ç¨',status:'inprogress',priority:'high',dueDate:'2026-02-28',budget:2000,checklist:[],comments:[],attachments:[],channels:['gads','lp']},
    {id:'t17',actionId:'a10',month:2,startDate:'2026-03-01',title:'LinkedIn Lead Gen Mar',description:'Budget 3000‚Ç¨',status:'todo',priority:'high',dueDate:'2026-03-31',budget:3000,checklist:[],comments:[],attachments:[],channels:['lads','lp']},
    {id:'t18',actionId:'a11',month:3,startDate:'2026-04-01',title:'Event In-House Avril',description:'√âv√©nement interne',status:'todo',priority:'high',dueDate:'2026-04-15',budget:10000,checklist:[{id:'c8',text:'Lieu',done:false},{id:'c9',text:'Invitations',done:false}],comments:[],attachments:[],channels:['events']},
    {id:'t19',actionId:'a12',month:3,startDate:'2026-04-01',title:'Salon Avril',description:'Participation salon',status:'todo',priority:'medium',dueDate:'2026-04-10',checklist:[],comments:[],attachments:[],channels:['events']}
];

// Touch Drag Support
const useTouchDrag=(onDragEnd)=>{
    const[isDragging,setIsDragging]=useState(false);
    const dragDataRef=useRef(null);
    const startPosRef=useRef({x:0,y:0});
    const ghostRef=useRef(null);
    
    const handleTouchStart=(e,data)=>{
        const touch=e.touches[0];
        startPosRef.current={x:touch.clientX,y:touch.clientY};
        dragDataRef.current=data;
        
        // Cr√©er un ghost element apr√®s un d√©lai (pour distinguer du scroll)
        setTimeout(()=>{
            if(dragDataRef.current){
                setIsDragging(true);
                const ghost=e.target.cloneNode(true);
                ghost.style.cssText='position:fixed;pointer-events:none;opacity:0.8;z-index:9999;width:'+e.target.offsetWidth+'px;transform:translate(-50%,-50%);';
                ghost.style.left=touch.clientX+'px';
                ghost.style.top=touch.clientY+'px';
                document.body.appendChild(ghost);
                ghostRef.current=ghost;
            }
        },200);
    };
    
    const handleTouchMove=(e)=>{
        if(!isDragging||!ghostRef.current)return;
        const touch=e.touches[0];
        ghostRef.current.style.left=touch.clientX+'px';
        ghostRef.current.style.top=touch.clientY+'px';
    };
    
    const handleTouchEnd=(e)=>{
        if(ghostRef.current){
            ghostRef.current.remove();
            ghostRef.current=null;
        }
        if(isDragging&&dragDataRef.current){
            const touch=e.changedTouches[0];
            const dropTarget=document.elementFromPoint(touch.clientX,touch.clientY);
            if(dropTarget){
                const dropZone=dropTarget.closest('[data-drop-month]');
                if(dropZone&&onDragEnd){
                    const month=parseInt(dropZone.dataset.dropMonth);
                    onDragEnd(dragDataRef.current,month);
                }
            }
        }
        setIsDragging(false);
        dragDataRef.current=null;
    };
    
    return{isDragging,handleTouchStart,handleTouchMove,handleTouchEnd};
};

const AppContext=createContext();
const useApp=()=>useContext(AppContext);

// ICONS
const Icon={
    Menu:()=><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16"/></svg>,
    Close:()=><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12"/></svg>,
    Sun:()=><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>,
    Moon:()=><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>,
    Kanban:()=><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7"/></svg>,
    Timeline:()=><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>,
    Dashboard:()=><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6z"/></svg>,
    Filter:()=><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg>,
    Plus:()=><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4"/></svg>,
    Trash:()=><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>,
    Refresh:()=><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>,
    Check:()=><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7"/></svg>,
    Comment:()=><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>,
    Calendar:()=><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>,
    Folder:()=><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>,
    List:()=><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>,
    TrendUp:()=><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>,
    Dollar:()=><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>,
    Alert:()=><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>,
    Hand:()=><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 11.5V14m0-2.5v-6a1.5 1.5 0 113 0m-3 6a1.5 1.5 0 00-3 0v2a7.5 7.5 0 0015 0v-5a1.5 1.5 0 00-3 0m-6-3V11m0-5.5v-1a1.5 1.5 0 013 0v1m0 0V11m0-5.5a1.5 1.5 0 013 0v3m0 0V11"/></svg>,
    External:()=><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>,
    Settings:()=><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>,
    Github:()=><svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>,
    Download:()=><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
};

// ‚ö†Ô∏è GITHUB SETTINGS MODAL - SUPPRIM√â
// Le token GitHub est maintenant int√©gr√© directement dans GITHUB_CONFIG (voir ligne ~1375-1381)
// Plus besoin de modal de configuration pour un usage multi-device transparent

// CATEGORIES MANAGEMENT MODAL
const CategoriesManagementModal=({categories,onClose,onUpdate,onAdd,onDelete,onReorder,darkMode})=>{
    const[editingId,setEditingId]=useState(null);
    const[form,setForm]=useState({});
    const[isAdding,setIsAdding]=useState(false);
    const[newCategory,setNewCategory]=useState({name:'',color:'#3781ec',gradient:'from-blue-500 to-indigo-700'});
    const[draggedIndex,setDraggedIndex]=useState(null);
    const[touchStartY,setTouchStartY]=useState(null);
    const[touchCurrentY,setTouchCurrentY]=useState(null);

    const gradientPresets=[
        {name:'Bleu',gradient:'from-blue-500 to-indigo-700'},
        {name:'Vert',gradient:'from-emerald-400 to-cyan-500'},
        {name:'Orange',gradient:'from-yellow-400 to-orange-500'},
        {name:'Violet',gradient:'from-purple-500 to-pink-600'},
        {name:'Rouge',gradient:'from-red-500 to-pink-500'}
    ];

    const startEdit=(cat)=>{setEditingId(cat.id);setForm({...cat});};
    const cancelEdit=()=>{setEditingId(null);setForm({});};
    const saveEdit=()=>{onUpdate(editingId,form);cancelEdit();};
    const handleAdd=()=>{
        if(!newCategory.name.trim())return;
        onAdd({...newCategory,id:`cat${Date.now()}`});
        setNewCategory({name:'',color:'#3781ec',gradient:'from-blue-500 to-indigo-700'});
        setIsAdding(false);
    };

    // Mouse drag handlers
    const handleDragStart=(index)=>{
        setDraggedIndex(index);
    };

    const handleDragOver=(e,index)=>{
        e.preventDefault();
        if(draggedIndex===null||draggedIndex===index)return;
        const newCategories=[...categories];
        const draggedItem=newCategories[draggedIndex];
        newCategories.splice(draggedIndex,1);
        newCategories.splice(index,0,draggedItem);
        onReorder(newCategories);
        setDraggedIndex(index);
    };

    const handleDragEnd=()=>{
        setDraggedIndex(null);
    };

    // Touch handlers for mobile
    const handleTouchStart=(e,index)=>{
        if(editingId)return; // Don't allow drag while editing
        const touch=e.touches[0];
        setTouchStartY(touch.clientY);
        setTouchCurrentY(touch.clientY);
        setDraggedIndex(index);
    };

    const handleTouchMove=(e,index)=>{
        if(draggedIndex===null||editingId)return;
        const touch=e.touches[0];
        setTouchCurrentY(touch.clientY);

        // Calculate which item we're hovering over
        const element=document.elementFromPoint(touch.clientX,touch.clientY);
        if(!element)return;

        // Find the category item
        const categoryItem=element.closest('[data-category-index]');
        if(!categoryItem)return;

        const targetIndex=parseInt(categoryItem.getAttribute('data-category-index'));
        if(targetIndex!==draggedIndex&&targetIndex>=0&&targetIndex<categories.length){
            const newCategories=[...categories];
            const draggedItem=newCategories[draggedIndex];
            newCategories.splice(draggedIndex,1);
            newCategories.splice(targetIndex,0,draggedItem);
            onReorder(newCategories);
            setDraggedIndex(targetIndex);
        }
    };

    const handleTouchEnd=()=>{
        setDraggedIndex(null);
        setTouchStartY(null);
        setTouchCurrentY(null);
    };

    return(
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60" onClick={onClose}>
            <div className={`${darkMode?'bg-gray-900':'bg-white'} rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto animate-slide-up`} onClick={e=>e.stopPropagation()}>
                <div className="bg-gradient-to-r from-primary to-secondary h-2 rounded-t-2xl"/>
                <div className="p-6">
                    <div className="flex items-center justify-between mb-6">
                        <h2 className="text-xl font-bold">üìÇ Gestion des Cat√©gories</h2>
                        <button onClick={onClose} className="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg"><Icon.Close/></button>
                    </div>
                    <div className="space-y-3 mb-4">
                        {categories.map((cat,index)=>(
                            <div key={cat.id} data-category-index={index} draggable={editingId!==cat.id} onDragStart={()=>handleDragStart(index)} onDragOver={(e)=>handleDragOver(e,index)} onDragEnd={handleDragEnd} onTouchStart={(e)=>handleTouchStart(e,index)} onTouchMove={(e)=>handleTouchMove(e,index)} onTouchEnd={handleTouchEnd} className={`p-4 rounded-lg border ${darkMode?'border-gray-700 bg-gray-800':'border-gray-200 bg-gray-50'} ${draggedIndex===index?'opacity-50':''} ${editingId===cat.id?'':'cursor-move touch-none'}`}>
                                {editingId===cat.id?(
                                    <div className="space-y-3">
                                        <input type="text" value={form.name} onChange={e=>setForm({...form,name:e.target.value})} className={`w-full px-3 py-2 rounded-lg border ${darkMode?'bg-gray-700 border-gray-600':'bg-white border-gray-300'}`}/>
                                        <div><label className="block text-xs text-gray-500 mb-2">Gradient:</label><div className="flex gap-2">{gradientPresets.map(g=>(<button key={g.name} onClick={()=>setForm({...form,gradient:g.gradient})} className={`flex-1 h-8 rounded-lg bg-gradient-to-r ${g.gradient} ${form.gradient===g.gradient?'ring-2 ring-secondary':''}`}/>))}</div></div>
                                        <div className="flex gap-2"><button onClick={saveEdit} className="px-4 py-2 bg-primary text-white rounded-lg text-sm">Sauvegarder</button><button onClick={cancelEdit} className={`px-4 py-2 rounded-lg text-sm ${darkMode?'hover:bg-gray-700':'hover:bg-gray-200'}`}>Annuler</button></div>
                                    </div>
                                ):(
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center space-x-3"><div className="cursor-move text-gray-400" title="Glisser pour r√©organiser">‚ãÆ‚ãÆ</div><div className={`w-12 h-8 rounded-lg bg-gradient-to-r ${cat.gradient}`}/><span className="font-medium">{cat.name}</span></div>
                                        <div className="flex gap-2"><button onClick={()=>startEdit(cat)} className="px-3 py-1 text-sm text-secondary hover:bg-secondary/10 rounded-lg">Modifier</button><button onClick={()=>onDelete(cat.id)} className="px-3 py-1 text-sm text-accent-red hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg">Supprimer</button></div>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                    {isAdding?(
                        <div className={`p-4 rounded-lg border-2 border-dashed ${darkMode?'border-gray-600':'border-gray-300'} space-y-3`}>
                            <input type="text" value={newCategory.name} onChange={e=>setNewCategory({...newCategory,name:e.target.value})} placeholder="Nom de la cat√©gorie" className={`w-full px-3 py-2 rounded-lg border ${darkMode?'bg-gray-800 border-gray-700':'bg-gray-50 border-gray-200'}`}/>
                            <div><label className="block text-xs text-gray-500 mb-2">Gradient:</label><div className="flex gap-2">{gradientPresets.map(g=>(<button key={g.name} onClick={()=>setNewCategory({...newCategory,gradient:g.gradient})} className={`flex-1 h-8 rounded-lg bg-gradient-to-r ${g.gradient} ${newCategory.gradient===g.gradient?'ring-2 ring-secondary':''}`}/>))}</div></div>
                            <div className="flex gap-2"><button onClick={handleAdd} className="px-4 py-2 bg-primary text-white rounded-lg text-sm">Ajouter</button><button onClick={()=>setIsAdding(false)} className={`px-4 py-2 rounded-lg text-sm ${darkMode?'hover:bg-gray-800':'hover:bg-gray-100'}`}>Annuler</button></div>
                        </div>
                    ):(
                        <button onClick={()=>setIsAdding(true)} className="w-full px-4 py-3 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg text-gray-500 hover:border-secondary hover:text-secondary flex items-center justify-center space-x-2"><Icon.Plus/><span>Nouvelle Cat√©gorie</span></button>
                    )}
                </div>
            </div>
        </div>
    );
};

// NEW ACTION MODAL
const NewActionModal=({categories,onClose,onAdd,darkMode})=>{
    const[form,setForm]=useState({name:'',categoryId:categories[0]?.id||'',budget:0,priority:'medium',tags:[]});
    const handleAdd=()=>{
        if(!form.name.trim()||!form.categoryId)return;
        onAdd({...form,id:`a${Date.now()}`});
        onClose();
    };
    return(
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60" onClick={onClose}>
            <div className={`${darkMode?'bg-gray-900':'bg-white'} rounded-2xl shadow-2xl w-full max-w-lg animate-slide-up`} onClick={e=>e.stopPropagation()}>
                <div className="bg-gradient-to-r from-primary to-secondary h-2 rounded-t-2xl"/>
                <div className="p-6">
                    <div className="flex items-center justify-between mb-6">
                        <h2 className="text-xl font-bold">üìÅ Nouvelle Action</h2>
                        <button onClick={onClose} className="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg"><Icon.Close/></button>
                    </div>
                    <div className="space-y-4">
                        <div><label className="block text-sm font-medium mb-2">Nom de l'action</label><input type="text" value={form.name} onChange={e=>setForm({...form,name:e.target.value})} placeholder="Ex: Google Ads - Brand" className={`w-full px-4 py-3 rounded-lg border ${darkMode?'bg-gray-800 border-gray-700':'bg-gray-50 border-gray-200'}`}/></div>
                        <div><label className="block text-sm font-medium mb-2">Cat√©gorie</label><select value={form.categoryId} onChange={e=>setForm({...form,categoryId:e.target.value})} className={`w-full px-4 py-3 rounded-lg border ${darkMode?'bg-gray-800 border-gray-700':'bg-gray-50 border-gray-200'}`}>{categories.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
                        <div className="flex gap-4">
                            <div className="flex-1"><label className="block text-sm font-medium mb-2">Budget (‚Ç¨)</label><input type="number" value={form.budget} onChange={e=>setForm({...form,budget:parseInt(e.target.value)||0})} className={`w-full px-4 py-3 rounded-lg border ${darkMode?'bg-gray-800 border-gray-700':'bg-gray-50 border-gray-200'}`}/></div>
                            <div className="flex-1"><label className="block text-sm font-medium mb-2">Priorit√©</label><select value={form.priority} onChange={e=>setForm({...form,priority:e.target.value})} className={`w-full px-4 py-3 rounded-lg border ${darkMode?'bg-gray-800 border-gray-700':'bg-gray-50 border-gray-200'}`}>{CONFIG.PRIORITIES.map(p=><option key={p.id} value={p.id}>{p.icon} {p.name}</option>)}</select></div>
                        </div>
                        <div><label className="block text-sm font-medium mb-2">Tags Canal</label><ChannelTags channels={form.tags} onAdd={id=>setForm({...form,tags:[...form.tags,id]})} onRemove={id=>setForm({...form,tags:form.tags.filter(t=>t!==id)})}/></div>
                    </div>
                    <div className="flex justify-end gap-2 mt-6"><button onClick={onClose} className={`px-4 py-2 rounded-lg ${darkMode?'hover:bg-gray-800':'hover:bg-gray-100'}`}>Annuler</button><button onClick={handleAdd} className="px-6 py-2 bg-primary text-white rounded-lg font-medium">Cr√©er l'action</button></div>
                </div>
            </div>
        </div>
    );
};

// NEW TASK MODAL
const NewTaskModal=({actions,categories,onClose,onAdd,onCreateAction,darkMode})=>{
    const[form,setForm]=useState({title:'',actionId:actions[0]?.id||'',startDate:new Date().toISOString().split('T')[0],dueDate:'',priority:'medium',status:'todo',description:'',budget:0});
    const handleAdd=()=>{
        if(!form.title.trim()||!form.actionId)return;
        const action=actions.find(a=>a.id===form.actionId);
        const month=form.startDate?new Date(form.startDate).getMonth():new Date().getMonth();
        onAdd({...form,id:`t${Date.now()}`,month,channels:action?.tags||[],checklist:[],comments:[],attachments:[]});
        onClose();
    };
    const selectedAction=actions.find(a=>a.id===form.actionId);
    const actionCategory=categories.find(c=>c.id===selectedAction?.categoryId);
    return(
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60" onClick={onClose}>
            <div className={`${darkMode?'bg-gray-900':'bg-white'} rounded-2xl shadow-2xl w-full max-w-lg animate-slide-up`} onClick={e=>e.stopPropagation()}>
                <div className={`h-2 rounded-t-2xl bg-gradient-to-r ${actionCategory?.gradient||'from-gray-400 to-gray-500'}`}/>
                <div className="p-6">
                    <div className="flex items-center justify-between mb-6">
                        <h2 className="text-xl font-bold">‚ú® Nouvelle T√¢che</h2>
                        <button onClick={onClose} className="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg"><Icon.Close/></button>
                    </div>
                    <div className="space-y-4">
                        <div><label className="block text-sm font-medium mb-2">Titre</label><input type="text" value={form.title} onChange={e=>setForm({...form,title:e.target.value})} placeholder="Ex: Post LinkedIn Janvier" className={`w-full px-4 py-3 rounded-lg border ${darkMode?'bg-gray-800 border-gray-700':'bg-gray-50 border-gray-200'}`}/></div>
                        <div>
                            <div className="flex items-center justify-between mb-2"><label className="block text-sm font-medium">Action</label><button onClick={onCreateAction} className="text-xs text-secondary hover:underline flex items-center gap-1"><Icon.Plus/>Cr√©er une action</button></div>
                            <select value={form.actionId} onChange={e=>setForm({...form,actionId:e.target.value})} className={`w-full px-4 py-3 rounded-lg border ${darkMode?'bg-gray-800 border-gray-700':'bg-gray-50 border-gray-200'}`}>{actions.map(a=>{const cat=categories.find(c=>c.id===a.categoryId);return<option key={a.id} value={a.id}>{a.name} ({cat?.name})</option>;})}</select>
                        </div>
                        <div className="flex gap-4">
                            <div className="flex-1"><label className="block text-sm font-medium mb-2">Date d√©but</label><input type="date" value={form.startDate} onChange={e=>setForm({...form,startDate:e.target.value})} className={`w-full px-4 py-3 rounded-lg border ${darkMode?'bg-gray-800 border-gray-700':'bg-gray-50 border-gray-200'}`}/></div>
                            <div className="flex-1"><label className="block text-sm font-medium mb-2">Date fin</label><input type="date" value={form.dueDate} onChange={e=>setForm({...form,dueDate:e.target.value})} className={`w-full px-4 py-3 rounded-lg border ${darkMode?'bg-gray-800 border-gray-700':'bg-gray-50 border-gray-200'}`}/></div>
                        </div>
                        <div className="flex gap-4">
                            <div className="flex-1"><label className="block text-sm font-medium mb-2">Priorit√©</label><select value={form.priority} onChange={e=>setForm({...form,priority:e.target.value})} className={`w-full px-4 py-3 rounded-lg border ${darkMode?'bg-gray-800 border-gray-700':'bg-gray-50 border-gray-200'}`}>{CONFIG.PRIORITIES.map(p=><option key={p.id} value={p.id}>{p.icon} {p.name}</option>)}</select></div>
                            <div className="flex-1"><label className="block text-sm font-medium mb-2">Budget (‚Ç¨)</label><input type="number" value={form.budget} onChange={e=>setForm({...form,budget:parseInt(e.target.value)||0})} className={`w-full px-4 py-3 rounded-lg border ${darkMode?'bg-gray-800 border-gray-700':'bg-gray-50 border-gray-200'}`}/></div>
                        </div>
                        <div><label className="block text-sm font-medium mb-2">Description</label><textarea value={form.description} onChange={e=>setForm({...form,description:e.target.value})} rows={3} className={`w-full px-4 py-3 rounded-lg border ${darkMode?'bg-gray-800 border-gray-700':'bg-gray-50 border-gray-200'} resize-none`}/></div>
                    </div>
                    <div className="flex justify-end gap-2 mt-6"><button onClick={onClose} className={`px-4 py-2 rounded-lg ${darkMode?'hover:bg-gray-800':'hover:bg-gray-100'}`}>Annuler</button><button onClick={handleAdd} className="px-6 py-2 bg-primary text-white rounded-lg font-medium">Cr√©er la t√¢che</button></div>
                </div>
            </div>
        </div>
    );
};

// HEADER
const Header=({darkMode,setDarkMode,currentView,setCurrentView,onSync,syncing,githubConnected,savingStatus})=>{
    const[mobileMenu,setMobileMenu]=useState(false);
    const navItems=[{id:'kanban',icon:Icon.Kanban,label:'Kanban'},{id:'timeline',icon:Icon.Timeline,label:'Timeline'},{id:'dashboard',icon:Icon.Dashboard,label:'KPIs'}];
    return(
        <header className={`sticky top-0 z-50 ${darkMode?'bg-gray-900/95':'bg-white/95'} backdrop-blur-sm border-b ${darkMode?'border-gray-800':'border-gray-200'}`}>
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div className="flex items-center justify-between h-16">
                    <div className="flex items-center space-x-3">
                        <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-primary to-secondary flex items-center justify-center shadow-lg"><span className="text-white font-bold text-lg">M</span></div>
                        <div><h1 className="font-bold text-lg text-primary dark:text-white">Marketing Tracker</h1><p className="text-xs text-gray-500">MIGSO-PCUBED ‚Ä¢ V2.2</p></div>
                    </div>
                    <nav className="hidden md:flex items-center space-x-1">
                        {navItems.map(({id,icon:I,label})=>(
                            <button key={id} onClick={()=>setCurrentView(id)} className={`flex items-center space-x-2 px-4 py-2 rounded-lg transition-all ${currentView===id?'bg-primary text-white shadow-md':darkMode?'text-gray-300 hover:bg-gray-800':'text-gray-600 hover:bg-gray-100'}`}><I/><span className="font-medium">{label}</span></button>
                        ))}
                    </nav>
                    <div className="flex items-center space-x-2">
                        {savingStatus&&<span className={`text-xs px-2 py-1 rounded-full flex items-center gap-1 ${savingStatus==='error'?'bg-red-500/10 text-red-500':'bg-secondary/10 text-secondary'}`}>{savingStatus==='saving'?'üíæ Sauvegarde...':savingStatus==='error'?'‚ùå Erreur':'‚úÖ Sauvegard√©'}</span>}
                        <button onClick={onSync} disabled={syncing} className={`p-2 rounded-lg ${darkMode?'hover:bg-gray-800':'hover:bg-gray-100'} ${syncing?'animate-spin':''} relative`} title="Synchroniser avec GitHub">
                            <Icon.Refresh/>
                            {githubConnected&&<span className="absolute top-1 right-1 w-2 h-2 bg-green-500 rounded-full"/>}
                        </button>
                        <button onClick={()=>setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode?'hover:bg-gray-800 text-yellow-400':'hover:bg-gray-100'}`}>{darkMode?<Icon.Sun/>:<Icon.Moon/>}</button>
                        <button onClick={()=>setMobileMenu(!mobileMenu)} className="md:hidden p-2 rounded-lg">{mobileMenu?<Icon.Close/>:<Icon.Menu/>}</button>
                    </div>
                </div>
                {mobileMenu&&(<div className="md:hidden py-4 border-t border-gray-200 dark:border-gray-800 animate-slide-in">{navItems.map(({id,icon:I,label})=>(<button key={id} onClick={()=>{setCurrentView(id);setMobileMenu(false);}} className={`flex items-center space-x-3 w-full px-4 py-3 rounded-lg ${currentView===id?'bg-primary text-white':''}`}><I/><span>{label}</span></button>))}</div>)}
            </div>
        </header>
    );
};

// TASK CARD
const ChannelTags=({channels=[],onAdd,onRemove,editable=true})=>{
    const{darkMode}=useApp();
    const[showPicker,setShowPicker]=useState(false);
    const available=CONFIG.CHANNELS.filter(c=>!channels.includes(c.id));
    return(
        <div className="flex flex-wrap gap-1 items-center">
            {channels.map(chId=>{const ch=CONFIG.CHANNELS.find(c=>c.id===chId);return ch?(<span key={chId} className="px-2 py-0.5 rounded-full text-xs text-white flex items-center" style={{backgroundColor:ch.color}}>{ch.name}{editable&&<button onClick={()=>onRemove(chId)} className="ml-1 hover:bg-white/20 rounded-full w-4 h-4 flex items-center justify-center text-xs">√ó</button>}</span>):null;})}
            {editable&&available.length>0&&(<div className="relative"><button onClick={()=>setShowPicker(!showPicker)} className={`px-2 py-0.5 rounded-full text-xs ${darkMode?"bg-gray-700 hover:bg-gray-600":"bg-gray-200 hover:bg-gray-300"} flex items-center space-x-1`}><Icon.Plus/><span>Tag</span></button>{showPicker&&(<div className={`absolute top-full left-0 mt-1 ${darkMode?"bg-gray-800":"bg-white"} rounded-lg shadow-xl border ${darkMode?"border-gray-700":"border-gray-200"} p-2 z-50 min-w-[150px] max-h-48 overflow-y-auto`}>{available.map(ch=>(<button key={ch.id} onClick={()=>{onAdd(ch.id);setShowPicker(false);}} className={`w-full text-left px-2 py-1.5 rounded text-xs ${darkMode?"hover:bg-gray-700":"hover:bg-gray-100"} flex items-center space-x-2`}><span className="w-2 h-2 rounded-full flex-shrink-0" style={{backgroundColor:ch.color}}/><span>{ch.name}</span></button>))}</div>)}</div>)}
        </div>
    );
};

const TaskCard=({task,action,onOpen,showAction=false,onTouchDrag,categories})=>{
    const{darkMode}=useApp();
    const[touching,setTouching]=useState(false);
    const touchTimeout=useRef(null);
    
    const handleTouchStart=(e)=>{
        touchTimeout.current=setTimeout(()=>{
            setTouching(true);
            if(navigator.vibrate)navigator.vibrate(50);
        },300);
    };
    const handleTouchEnd=()=>{
        if(touchTimeout.current)clearTimeout(touchTimeout.current);
        setTouching(false);
    };
    const handleTouchMove=(e)=>{
        if(touching&&onTouchDrag){
            const touch=e.touches[0];
            const el=document.elementFromPoint(touch.clientX,touch.clientY);
            if(el){
                const dropZone=el.closest('[data-drop-month]');
                if(dropZone){
                    dropZone.classList.add('drag-over');
                }
            }
        }
    };
    const status=CONFIG.STATUSES.find(s=>s.id===task.status);
    const priority=CONFIG.PRIORITIES.find(p=>p.id===task.priority);
    const category=categories?.find(c=>c.id===action?.categoryId);
    const checklistPct=task.checklist?.length>0?Math.round((task.checklist.filter(c=>c.done).length/task.checklist.length)*100):null;

    return(
        <div 
            draggable 
            onDragStart={(e)=>{e.dataTransfer.setData('taskId',task.id);e.dataTransfer.setData('type','task');e.target.classList.add('dragging');}}
            onDragEnd={(e)=>e.target.classList.remove('dragging')}
            onTouchStart={handleTouchStart}
            onTouchMove={handleTouchMove}
            onTouchEnd={handleTouchEnd}
            onClick={()=>onOpen(task)} 
            className={`${darkMode?'bg-gray-800':'bg-white'} rounded-xl p-4 shadow-sm border ${darkMode?'border-gray-700':'border-gray-200'} cursor-pointer card-hover transition-all ${touching?'touch-dragging':''}`}>
            {showAction&&category&&<div className={`h-1 w-full rounded-full mb-3 bg-gradient-to-r ${category.gradient}`}/>}
            <div className="flex items-start justify-between mb-2">
                <span className="px-2 py-1 rounded-lg text-xs font-medium text-white" style={{backgroundColor:status?.color}}>{status?.icon} {status?.name}</span>
                <span className="text-sm">{priority?.icon}</span>
            </div>
            <h4 className="font-semibold text-sm mb-2 line-clamp-2">{task.title}</h4>
            {showAction&&action&&<p className="text-xs text-gray-500 mb-2 truncate">üìÅ {action.name}</p>}
            {task.description&&<p className="text-xs text-gray-500 mb-2 line-clamp-2">{task.description}</p>}
            {task.channels&&task.channels.length>0&&<div className="mb-2"><ChannelTags channels={task.channels} editable={false}/></div>}
            {checklistPct!==null&&(<div className="mb-3"><div className="flex items-center justify-between text-xs text-gray-500 mb-1"><span>Checklist</span><span>{checklistPct}%</span></div><div className="h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full"><div className="h-full bg-accent-green rounded-full" style={{width:`${checklistPct}%`}}/></div></div>)}
            <div className="flex items-center justify-between text-xs text-gray-500">
                <div className="flex items-center space-x-3">
                    {task.comments?.length>0&&<span className="flex items-center space-x-1"><Icon.Comment/><span>{task.comments.length}</span></span>}
                    {task.checklist?.length>0&&<span className="flex items-center space-x-1"><Icon.Check/><span>{task.checklist.filter(c=>c.done).length}/{task.checklist.length}</span></span>}
                </div>
                {task.dueDate&&<span className="flex items-center space-x-1"><Icon.Calendar/><span>{new Date(task.dueDate).toLocaleDateString('fr-FR',{day:'numeric',month:'short'})}</span></span>}
            </div>
            {task.budget&&<div className="mt-2 pt-2 border-t border-gray-200 dark:border-gray-700"><span className="text-sm font-semibold text-secondary">{task.budget.toLocaleString()}‚Ç¨</span></div>}
        </div>
    );
};

// TASK DETAIL MODAL
const TaskDetailModal=({categories,task,action,actions,onClose,onUpdate,onDelete,onBackToAction})=>{
    const{darkMode}=useApp();
    const[form,setForm]=useState({...task});
    const[newComment,setNewComment]=useState('');
    const[newChecklistItem,setNewChecklistItem]=useState('');
    const currentAction=actions?.find(a=>a.id===form.actionId)||action;
    const category=categories?.find(c=>c.id===currentAction?.categoryId);

    const handleSave=()=>{onUpdate(task.id,form);onClose();};
    const addComment=()=>{if(!newComment.trim())return;setForm({...form,comments:[...(form.comments||[]),{id:`cm${Date.now()}`,author:'Vous',text:newComment,date:new Date().toISOString()}]});setNewComment('');};
    const addChecklistItem=()=>{if(!newChecklistItem.trim())return;setForm({...form,checklist:[...(form.checklist||[]),{id:`cl${Date.now()}`,text:newChecklistItem,done:false}]});setNewChecklistItem('');};
    const toggleChecklistItem=(id)=>setForm({...form,checklist:form.checklist.map(i=>i.id===id?{...i,done:!i.done}:i)});
    const removeChecklistItem=(id)=>setForm({...form,checklist:form.checklist.filter(i=>i.id!==id)});
    const addChannel=(id)=>setForm({...form,channels:[...(form.channels||[]),id]});
    const removeChannel=(id)=>setForm({...form,channels:(form.channels||[]).filter(c=>c!==id)});
    const checklistPct=form.checklist?.length>0?Math.round((form.checklist.filter(c=>c.done).length/form.checklist.length)*100):0;

    return(
        <div className="fixed inset-0 z-50 flex items-start justify-center p-4 pt-16 modal-backdrop bg-black/60 overflow-y-auto" onClick={onClose}>
            <div className={`${darkMode?'bg-gray-900':'bg-white'} rounded-2xl shadow-2xl w-full max-w-2xl animate-slide-up mb-8`} onClick={e=>e.stopPropagation()}>
                <div className={`h-2 rounded-t-2xl bg-gradient-to-r ${category?.gradient||'from-gray-400 to-gray-500'}`}/>
                <div className="p-6">
                    <div className="flex items-start justify-between mb-4">
                        <div className="flex-1">
                            <input type="text" value={form.title} onChange={e=>setForm({...form,title:e.target.value})} className={`w-full text-xl font-bold px-3 py-2 rounded-lg border ${darkMode?'bg-gray-800 border-gray-700':'bg-gray-50 border-gray-200'}`}/>
                            <div className="flex items-center gap-2 mt-1">
                                <p className="text-sm text-gray-500">üìÅ {action?.name} ‚Ä¢ {CONFIG.MONTHS_FULL[task.month]}</p>
                                {onBackToAction&&<button onClick={onBackToAction} className="text-xs text-secondary hover:underline flex items-center gap-1">‚Üê Retour √† l'action</button>}
                            </div>
                        </div>
                        <button onClick={onClose} className="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg"><Icon.Close/></button>
                    </div>
                    <div className="flex flex-wrap gap-3 mb-6">
                        {actions&&<div className="w-full"><label className="block text-xs text-gray-500 mb-1">üìã Action</label><select value={form.actionId} onChange={e=>{const newAction=actions.find(a=>a.id===e.target.value);setForm({...form,actionId:e.target.value,channels:newAction?.tags||form.channels});}} className={`w-full px-3 py-2 rounded-lg border text-sm ${darkMode?'bg-gray-800 border-gray-700':'bg-gray-50 border-gray-200'}`}>{actions.map(a=><option key={a.id} value={a.id}>{a.name}</option>)}</select></div>}
                        <div><label className="block text-xs text-gray-500 mb-1">Statut</label><select value={form.status} onChange={e=>setForm({...form,status:e.target.value})} className={`px-3 py-2 rounded-lg border text-sm ${darkMode?'bg-gray-800 border-gray-700':'bg-gray-50 border-gray-200'}`}>{CONFIG.STATUSES.map(s=><option key={s.id} value={s.id}>{s.icon} {s.name}</option>)}</select></div>
                        <div><label className="block text-xs text-gray-500 mb-1">Priorit√©</label><select value={form.priority} onChange={e=>setForm({...form,priority:e.target.value})} className={`px-3 py-2 rounded-lg border text-sm ${darkMode?'bg-gray-800 border-gray-700':'bg-gray-50 border-gray-200'}`}>{CONFIG.PRIORITIES.map(p=><option key={p.id} value={p.id}>{p.icon} {p.name}</option>)}</select></div>
                        <div><label className="block text-xs text-gray-500 mb-1">D√©but</label><input type="date" value={form.startDate||''} onChange={e=>setForm({...form,startDate:e.target.value})} className={`px-3 py-2 rounded-lg border text-sm ${darkMode?'bg-gray-800 border-gray-700':'bg-gray-50 border-gray-200'}`}/></div>
                        <div><label className="block text-xs text-gray-500 mb-1">Fin</label><input type="date" value={form.dueDate||''} onChange={e=>setForm({...form,dueDate:e.target.value})} className={`px-3 py-2 rounded-lg border text-sm ${darkMode?'bg-gray-800 border-gray-700':'bg-gray-50 border-gray-200'}`}/></div>
                        <div><label className="block text-xs text-gray-500 mb-1">Budget ‚Ç¨</label><input type="number" value={form.budget||0} onChange={e=>setForm({...form,budget:parseInt(e.target.value)||0})} className={`px-3 py-2 rounded-lg border text-sm w-24 ${darkMode?'bg-gray-800 border-gray-700':'bg-gray-50 border-gray-200'}`}/></div>
                    </div>
                    <div className="mb-4"><label className="block text-xs text-gray-500 mb-2">üè∑Ô∏è Tags Canal</label><ChannelTags channels={form.channels||[]} onAdd={addChannel} onRemove={removeChannel}/></div>
                    <div className="mb-6"><label className="block text-sm font-medium mb-2">üìù Description</label><textarea value={form.description||''} onChange={e=>setForm({...form,description:e.target.value})} placeholder="Description..." rows={3} className={`w-full px-4 py-3 rounded-lg border ${darkMode?'bg-gray-800 border-gray-700':'bg-gray-50 border-gray-200'} resize-none`}/></div>
                    <div className="mb-6">
                        <div className="flex items-center justify-between mb-2"><label className="text-sm font-medium">‚úÖ Checklist</label>{form.checklist?.length>0&&<span className="text-sm text-gray-500">{checklistPct}%</span>}</div>
                        {form.checklist?.length>0&&<div className="h-2 bg-gray-200 dark:bg-gray-700 rounded-full mb-3"><div className="h-full bg-accent-green rounded-full" style={{width:`${checklistPct}%`}}/></div>}
                        <div className="space-y-2 mb-3">{form.checklist?.map(item=>(<div key={item.id} className={`flex items-center space-x-3 p-2 rounded-lg ${darkMode?'bg-gray-800':'bg-gray-50'}`}><button onClick={()=>toggleChecklistItem(item.id)} className={`w-5 h-5 rounded border-2 flex items-center justify-center ${item.done?'bg-accent-green border-accent-green text-white':'border-gray-400'}`}>{item.done&&<Icon.Check/>}</button><span className={`flex-1 text-sm ${item.done?'line-through text-gray-400':''}`}>{item.text}</span><button onClick={()=>removeChecklistItem(item.id)} className="text-gray-400 hover:text-accent-red"><Icon.Trash/></button></div>))}</div>
                        <div className="flex space-x-2"><input type="text" value={newChecklistItem} onChange={e=>setNewChecklistItem(e.target.value)} onKeyPress={e=>e.key==='Enter'&&addChecklistItem()} placeholder="Ajouter..." className={`flex-1 px-3 py-2 rounded-lg border text-sm ${darkMode?'bg-gray-800 border-gray-700':'bg-gray-50 border-gray-200'}`}/><button onClick={addChecklistItem} className="px-3 py-2 bg-secondary text-white rounded-lg"><Icon.Plus/></button></div>
                    </div>
                    <div className="mb-6">
                        <label className="block text-sm font-medium mb-2">üí¨ Commentaires ({form.comments?.length||0})</label>
                        <div className="space-y-2 mb-3 max-h-40 overflow-y-auto">{form.comments?.map(c=>(<div key={c.id} className={`p-3 rounded-lg ${darkMode?'bg-gray-800':'bg-gray-50'}`}><div className="flex justify-between mb-1"><span className="font-medium text-sm">{c.author}</span><span className="text-xs text-gray-500">{new Date(c.date).toLocaleDateString('fr-FR')}</span></div><p className="text-sm text-gray-600 dark:text-gray-300">{c.text}</p></div>))}</div>
                        <div className="flex space-x-2"><input type="text" value={newComment} onChange={e=>setNewComment(e.target.value)} onKeyPress={e=>e.key==='Enter'&&addComment()} placeholder="√âcrire..." className={`flex-1 px-3 py-2 rounded-lg border text-sm ${darkMode?'bg-gray-800 border-gray-700':'bg-gray-50 border-gray-200'}`}/><button onClick={addComment} className="px-4 py-2 bg-secondary text-white rounded-lg text-sm">Envoyer</button></div>
                    </div>
                    <div className="mb-6"><label className="block text-sm font-medium mb-2">üìé Pi√®ces jointes</label><div className={`border-2 border-dashed ${darkMode?'border-gray-700':'border-gray-300'} rounded-lg p-6 text-center`}><p className="text-sm text-gray-500">Glissez des fichiers ici</p><p className="text-xs text-gray-400">(Disponible avec Google Drive)</p></div></div>
                    <div className="flex items-center justify-between pt-4 border-t border-gray-200 dark:border-gray-700">
                        <button onClick={()=>{onDelete(task.id);onClose();}} className="px-4 py-2 text-accent-red hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg text-sm flex items-center space-x-2"><Icon.Trash/><span>Supprimer</span></button>
                        <div className="flex space-x-2"><button onClick={onClose} className={`px-4 py-2 rounded-lg text-sm ${darkMode?'hover:bg-gray-800':'hover:bg-gray-100'}`}>Annuler</button><button onClick={handleSave} className="px-6 py-2 bg-primary text-white rounded-lg text-sm font-medium">Sauvegarder</button></div>
                    </div>
                </div>
            </div>
        </div>
    );
};

const ActionDetailModal=({categories,action,tasks,onClose,onUpdateAction,onUpdateTask,onOpenTask,onAddTask,onDeleteAction})=>{
    const{darkMode}=useApp();
    const[form,setForm]=useState({...action});
    const[showConfirmDelete,setShowConfirmDelete]=useState(false);
    const actionTasks=tasks.filter(t=>t.actionId===action.id);
    const completedTasks=actionTasks.filter(t=>t.status==='completed').length;
    const progressPct=actionTasks.length>0?Math.round((completedTasks/actionTasks.length)*100):0;
    const category=categories?.find(c=>c.id===form.categoryId);
    const totalBudget=actionTasks.reduce((s,t)=>s+(t.budget||0),0);

    const handleSave=()=>{onUpdateAction(action.id,form);onClose();};
    const handleDelete=()=>{if(onDeleteAction){onDeleteAction(action.id);onClose();}};
    const handleStatusChange=(taskId,newStatus)=>{onUpdateTask(taskId,{status:newStatus});};
    const addChannel=(id)=>setForm({...form,tags:[...(form.tags||[]),id]});
    const removeChannel=(id)=>setForm({...form,tags:(form.tags||[]).filter(c=>c!==id)});

    return(
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60" onClick={onClose}>
            <div className={`${darkMode?'bg-gray-900':'bg-white'} rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto animate-slide-up`} onClick={e=>e.stopPropagation()}>
                <div className={`h-2 rounded-t-2xl bg-gradient-to-r ${category?.gradient||'from-gray-400 to-gray-500'}`}/>
                <div className="p-6">
                    <div className="flex items-start justify-between mb-4">
                        <div className="flex-1">
                            <span className="text-xs text-gray-500">üìÅ ACTION</span>
                            <input type="text" value={form.name} onChange={e=>setForm({...form,name:e.target.value})} className={`w-full text-xl font-bold px-3 py-2 rounded-lg border mt-1 ${darkMode?'bg-gray-800 border-gray-700':'bg-gray-50 border-gray-200'}`}/>
                        </div>
                        <button onClick={onClose} className="ml-2 p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg"><Icon.Close/></button>
                    </div>
                    <div className="flex flex-wrap gap-3 mb-4">
                        <div><label className="block text-xs text-gray-500 mb-1">Cat√©gorie</label><select value={form.categoryId} onChange={e=>setForm({...form,categoryId:e.target.value})} className={`px-3 py-2 rounded-lg border text-sm ${darkMode?'bg-gray-800 border-gray-700':'bg-gray-50 border-gray-200'}`}>{categories.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
                        <div><label className="block text-xs text-gray-500 mb-1">Priorit√©</label><select value={form.priority} onChange={e=>setForm({...form,priority:e.target.value})} className={`px-3 py-2 rounded-lg border text-sm ${darkMode?'bg-gray-800 border-gray-700':'bg-gray-50 border-gray-200'}`}>{CONFIG.PRIORITIES.map(p=><option key={p.id} value={p.id}>{p.icon} {p.name}</option>)}</select></div>
                        <div><label className="block text-xs text-gray-500 mb-1">Budget ‚Ç¨</label><input type="number" value={form.budget||0} onChange={e=>setForm({...form,budget:parseInt(e.target.value)||0})} className={`px-3 py-2 rounded-lg border text-sm w-32 ${darkMode?'bg-gray-800 border-gray-700':'bg-gray-50 border-gray-200'}`}/></div>
                    </div>
                    <div className={`${darkMode?'bg-gray-800':'bg-gray-50'} rounded-xl p-4 mb-4`}>
                        <div className="flex justify-between mb-3">
                            <div><span className="text-xs text-gray-500">üí∞ Budget Total T√¢ches</span><p className="text-lg font-bold text-secondary">{totalBudget.toLocaleString()}‚Ç¨</p></div>
                            <div><span className="text-xs text-gray-500">üìä Progression</span><p className="text-lg font-bold">{progressPct}%</p></div>
                            <div><span className="text-xs text-gray-500">üìã T√¢ches</span><p className="text-lg font-bold">{completedTasks}/{actionTasks.length}</p></div>
                        </div>
                        <div className="h-3 bg-gray-200 dark:bg-gray-700 rounded-full"><div className={`h-full rounded-full bg-gradient-to-r ${category?.gradient}`} style={{width:`${progressPct}%`}}/></div>
                    </div>
                    <div className="mb-4"><label className="block text-xs text-gray-500 mb-2">üè∑Ô∏è Tags Canal</label><ChannelTags channels={form.tags||[]} onAdd={addChannel} onRemove={removeChannel}/></div>
                    <div className="mb-4">
                        <div className="flex items-center justify-between mb-3">
                            <label className="text-sm font-medium">üìã T√ÇCHES ({actionTasks.length})</label>
                            <button onClick={()=>onAddTask(action.id)} className="px-3 py-1 bg-secondary text-white rounded-lg text-xs flex items-center space-x-1"><Icon.Plus/><span>Ajouter</span></button>
                        </div>
                        <div className="space-y-2 max-h-48 overflow-y-auto">
                            {actionTasks.length>0?actionTasks.map(task=>{
                                const status=CONFIG.STATUSES.find(s=>s.id===task.status);
                                return(
                                    <div key={task.id} className={`${darkMode?'bg-gray-800':'bg-gray-50'} rounded-lg p-3 border ${darkMode?'border-gray-700':'border-gray-200'}`}>
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center space-x-3 flex-1 min-w-0">
                                                <select value={task.status} onChange={e=>handleStatusChange(task.id,e.target.value)} className="px-2 py-1 rounded text-xs text-white border-0 cursor-pointer" style={{backgroundColor:status?.color}}>
                                                    {CONFIG.STATUSES.map(s=><option key={s.id} value={s.id}>{s.icon} {s.name}</option>)}
                                                </select>
                                                <div className="flex-1 min-w-0">
                                                    <p className="font-medium text-sm truncate">{task.title}</p>
                                                    <p className="text-xs text-gray-500">üìÖ {task.startDate?new Date(task.startDate).toLocaleDateString('fr-FR',{day:'numeric',month:'short'}):'?'} ‚Üí {task.dueDate?new Date(task.dueDate).toLocaleDateString('fr-FR',{day:'numeric',month:'short'}):'?'}</p>
                                                </div>
                                            </div>
                                            <div className="flex items-center space-x-2">
                                                {task.budget>0&&<span className="text-xs font-semibold text-secondary">{task.budget}‚Ç¨</span>}
                                                <button onClick={()=>onOpenTask(task)} className="p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded text-gray-500"><Icon.External/></button>
                                            </div>
                                        </div>
                                    </div>
                                );
                            }):<p className="text-center text-gray-500 py-4 text-sm">Aucune t√¢che</p>}
                        </div>
                    </div>
                    {showConfirmDelete&&(
                        <div className="mb-4 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
                            <p className="text-sm font-medium text-red-800 dark:text-red-300 mb-2">‚ö†Ô∏è Confirmer la suppression ?</p>
                            <p className="text-xs text-red-600 dark:text-red-400 mb-3">Cette action et ses {actionTasks.length} t√¢che(s) seront d√©finitivement supprim√©es.</p>
                            <div className="flex space-x-2">
                                <button onClick={handleDelete} className="px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium">Confirmer</button>
                                <button onClick={()=>setShowConfirmDelete(false)} className="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg text-sm">Annuler</button>
                            </div>
                        </div>
                    )}
                    <div className="flex items-center justify-between pt-4 border-t border-gray-200 dark:border-gray-700">
                        <button onClick={()=>setShowConfirmDelete(true)} className="px-4 py-2 text-accent-red hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg text-sm flex items-center space-x-2"><Icon.Trash/><span>Supprimer</span></button>
                        <div className="flex space-x-2">
                            <button onClick={onClose} className={`px-4 py-2 rounded-lg text-sm ${darkMode?'hover:bg-gray-800':'hover:bg-gray-100'}`}>Annuler</button>
                            <button onClick={handleSave} className="px-6 py-2 bg-primary text-white rounded-lg text-sm font-medium">Sauvegarder</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};

// KANBAN VIEW
const KanbanView=({categories,actions,tasks,onOpenTask,onOpenAction,onUpdateTask,onUpdateAction,onAddTask,onAddAction,filters,setFilters})=>{
    const{darkMode}=useApp();
    const[viewMode,setViewMode]=useState('month');
    const[selectedAction,setSelectedAction]=useState(null);
    const[actionFilters,setActionFilters]=useState([]);

    const filteredTasks=tasks.filter(t=>{
        const action=actions.find(a=>a.id===t.actionId);
        if(filters.search&&!t.title.toLowerCase().includes(filters.search.toLowerCase()))return false;
        if(filters.status.length>0&&!filters.status.includes(t.status))return false;
        if(filters.category.length>0&&!filters.category.includes(action?.categoryId))return false;
        if(filters.priority.length>0&&!filters.priority.includes(t.priority))return false;
        if(filters.channel&&filters.channel.length>0&&!(t.channels||[]).some(c=>filters.channel.includes(c)))return false;
        if(actionFilters.length>0&&!actionFilters.includes(t.actionId))return false;
        return true;
    });

    const handleActionDrop=(e,categoryId)=>{
        e.preventDefault();e.currentTarget.classList.remove('drag-over');
        const actionId=e.dataTransfer.getData('actionId');
        if(actionId&&onUpdateAction){
            onUpdateAction(actionId,{categoryId});
        }
    };
    const handleDragOver=(e)=>{e.preventDefault();e.currentTarget.classList.add('drag-over');};
    const handleDragLeave=(e)=>{e.currentTarget.classList.remove('drag-over');};

    const getColumns=()=>{
        if(viewMode==='month')return CONFIG.MONTHS_FULL.map((name,idx)=>({key:idx,name,items:filteredTasks.filter(t=>t.month===idx)}));
        if(viewMode==='category')return categories.map(cat=>({key:cat.id,name:cat.name,gradient:cat.gradient,items:actions.filter(a=>a.categoryId===cat.id)}));
        if(viewMode==='action'){
            if(selectedAction){
                return CONFIG.STATUSES.map(s=>({key:s.id,name:s.name,color:s.color,icon:s.icon,items:filteredTasks.filter(t=>t.actionId===selectedAction&&t.status===s.id)}));
            }else{
                return CONFIG.STATUSES.map(s=>({key:s.id,name:s.name,color:s.color,icon:s.icon,items:filteredTasks.filter(t=>t.status===s.id)}));
            }
        }
        return[];
    };

    return(
        <div className="animate-slide-in">
            <div className={`${darkMode?'bg-gray-900':'bg-white'} rounded-xl p-4 border ${darkMode?'border-gray-800':'border-gray-200'} mb-4`}>
                <div className="flex flex-wrap items-center justify-between gap-4 mb-4">
                    <div className="flex items-center space-x-2">
                        <span className="text-sm text-gray-500">Vue:</span>
                        <div className="flex rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700">
                            {[{id:'month',label:'Par Mois',icon:Icon.Calendar},{id:'category',label:'Par Cat√©gorie',icon:Icon.Folder},{id:'action',label:'Par Action',icon:Icon.List}].map(v=>(
                                <button key={v.id} onClick={()=>{setViewMode(v.id);if(v.id!=='action')setSelectedAction(null);}} className={`px-4 py-2 text-sm flex items-center space-x-2 ${viewMode===v.id?'bg-primary text-white':darkMode?'hover:bg-gray-800':'hover:bg-gray-100'}`}><v.icon/><span className="hidden sm:inline">{v.label}</span></button>
                            ))}
                        </div>
                    </div>
                </div>
                {(viewMode==='month'||viewMode==='action')&&(
                    <div>
                        <label className="block text-xs text-gray-500 mb-2">Filtrer par action:</label>
                        <div className="flex flex-wrap gap-2">
                            <button onClick={()=>setActionFilters([])} className={`px-3 py-1.5 rounded-full text-xs ${actionFilters.length===0?'bg-primary text-white':darkMode?'bg-gray-800':'bg-gray-100'}`}>Toutes</button>
                            {actions.map(a=>(
                                <button key={a.id} onClick={()=>{
                                    if(viewMode==='action')setSelectedAction(a.id===selectedAction?null:a.id);
                                    const idx=actionFilters.indexOf(a.id);
                                    if(idx>=0)setActionFilters(actionFilters.filter(id=>id!==a.id));
                                    else setActionFilters([...actionFilters,a.id]);
                                }} className={`px-3 py-1.5 rounded-full text-xs truncate max-w-[160px] ${(viewMode==='action'&&selectedAction===a.id)||(viewMode==='month'&&actionFilters.includes(a.id))?'bg-secondary text-white':darkMode?'bg-gray-800':'bg-gray-100'}`} title={a.name}>
                                    {a.name.length>20?a.name.substring(0,20)+'...':a.name}
                                </button>
                            ))}
                        </div>
                    </div>
                )}
            </div>
            <div className="overflow-x-auto pb-4">
                <div className="flex gap-4" style={{minWidth:viewMode==='month'?'2800px':'1200px'}}>
                    {getColumns().map(col=>(
                        <div
                            key={col.key}
                            data-drop-month={viewMode==='month'?col.key:null}
                            onDragOver={(e)=>{e.preventDefault();if(viewMode==='month'||viewMode==='category')e.currentTarget.classList.add('drag-over');}}
                            onDragLeave={(e)=>e.currentTarget.classList.remove('drag-over')}
                            onDrop={(e)=>{
                                e.preventDefault();
                                e.currentTarget.classList.remove('drag-over');
                                if(viewMode==='month'){
                                    const taskId=e.dataTransfer.getData('taskId');
                                    if(taskId){
                                        const monthIdx=col.key;
                                        const year=2026;
                                        const startDate=year+'-'+String(monthIdx+1).padStart(2,'0')+'-01';
                                        const lastDay=new Date(year,monthIdx+1,0).getDate();
                                        const dueDate=year+'-'+String(monthIdx+1).padStart(2,'0')+'-'+lastDay;
                                        onUpdateTask(taskId,{startDate,dueDate,month:monthIdx});
                                    }
                                }else if(viewMode==='category'){
                                    const actionId=e.dataTransfer.getData('actionId');
                                    if(actionId&&onUpdateAction){
                                        onUpdateAction(actionId,{categoryId:col.key});
                                    }
                                }else if(viewMode==='action'){
                                    const taskId=e.dataTransfer.getData('taskId');
                                    if(taskId){
                                        onUpdateTask(taskId,{status:col.key});
                                    }
                                }
                            }}
                            className={`kanban-column flex-shrink-0 ${viewMode==='category'?'w-80':'w-64'} ${darkMode?'bg-gray-900/50':'bg-gray-100/50'} rounded-xl p-3 min-h-[200px]`}>
                            <div className="mb-3">
                                {col.gradient&&<div className={`h-1 rounded-full bg-gradient-to-r ${col.gradient} mb-2`}/>}
                                <div className="flex items-center justify-between"><h3 className="font-semibold text-sm">{col.icon&&<span className="mr-1">{col.icon}</span>}{col.name}</h3><span className={`px-2 py-0.5 rounded-full text-xs ${darkMode?'bg-gray-800':'bg-gray-200'}`}>{col.items.length}</span></div>
                            </div>
                            <div className="space-y-3">
                                {viewMode==='category'?col.items.map(action=>{
                                    const actionTasks=tasks.filter(t=>t.actionId===action.id);
                                    const completed=actionTasks.filter(t=>t.status==='completed').length;
                                    const pct=actionTasks.length>0?Math.round((completed/actionTasks.length)*100):0;
                                    const cat=categories.find(c=>c.id===action.categoryId);
                                    return(
                                        <div key={action.id} draggable onDragStart={(e)=>{e.dataTransfer.setData('actionId',action.id);e.target.classList.add('dragging');}} onDragEnd={(e)=>e.target.classList.remove('dragging')} onClick={(e)=>{if(!e.defaultPrevented)onOpenAction(action);}} className={`${darkMode?'bg-gray-800':'bg-white'} rounded-xl p-4 shadow-sm border ${darkMode?'border-gray-700':'border-gray-200'} cursor-move card-hover`}>
                                            <div className={`h-1 w-full rounded-full mb-3 bg-gradient-to-r ${cat?.gradient}`}/>
                                            <h4 className="font-semibold text-sm mb-2">{action.name}</h4>
                                            <div className="mb-2"><div className="flex justify-between text-xs text-gray-500 mb-1"><span>{completed}/{actionTasks.length} t√¢ches</span><span>{pct}%</span></div><div className="h-2 bg-gray-200 dark:bg-gray-700 rounded-full"><div className={`h-full rounded-full bg-gradient-to-r ${cat?.gradient}`} style={{width:`${pct}%`}}/></div></div>
                                            {action.tags?.length>0&&<div className="flex flex-wrap gap-1">{action.tags.slice(0,3).map(t=><span key={t} className={`px-2 py-0.5 rounded-full text-xs ${darkMode?'bg-gray-700':'bg-gray-100'}`}>{t}</span>)}</div>}
                                        </div>
                                    );
                                }):col.items.map(task=><TaskCard key={task.id} task={task} action={actions.find(a=>a.id===task.actionId)} onOpen={onOpenTask} showAction={viewMode==='month'} categories={categories}/>)}
                                {col.items.length===0&&<div className={`text-center py-8 border-2 border-dashed ${darkMode?'border-gray-700':'border-gray-300'} rounded-lg`}><p className="text-xs text-gray-400">Aucune t√¢che</p></div>}
                                <button onClick={()=>{
                                    if(viewMode==='month'){
                                        const monthIdx=col.key;
                                        const year=2026;
                                        const startDate=year+'-'+String(monthIdx+1).padStart(2,'0')+'-01';
                                        const lastDay=new Date(year,monthIdx+1,0).getDate();
                                        const dueDate=year+'-'+String(monthIdx+1).padStart(2,'0')+'-'+lastDay;
                                        const newTask={id:`t${Date.now()}`,title:'Nouvelle t√¢che',actionId:actions[0]?.id||'',month:monthIdx,startDate,dueDate,status:'todo',priority:'medium',description:'',checklist:[],comments:[],attachments:[],channels:actions[0]?.tags||[]};
                                        onAddTask(newTask);
                                        setTimeout(()=>onOpenTask(newTask),100);
                                    }else if(viewMode==='category'){
                                        const newAction={id:`a${Date.now()}`,name:'Nouvelle action',categoryId:col.key,budget:0,priority:'medium',tags:[]};
                                        onAddAction(newAction);
                                        setTimeout(()=>onOpenAction(newAction),100);
                                    }else if(viewMode==='action'){
                                        const newTask={id:`t${Date.now()}`,title:'Nouvelle t√¢che',actionId:selectedAction||actions[0]?.id||'',month:new Date().getMonth(),startDate:new Date().toISOString().split('T')[0],dueDate:new Date().toISOString().split('T')[0],status:col.key,priority:'medium',description:'',checklist:[],comments:[],attachments:[],channels:actions.find(a=>a.id===(selectedAction||actions[0]?.id))?.tags||[]};
                                        onAddTask(newTask);
                                        setTimeout(()=>onOpenTask(newTask),100);
                                    }
                                }} className={`w-full mt-3 px-3 py-2 rounded-lg text-sm flex items-center justify-center gap-1 ${darkMode?'bg-gray-800 hover:bg-gray-700 text-gray-300':'bg-gray-100 hover:bg-gray-200 text-gray-600'} transition-colors`}>
                                    <Icon.Plus size={16}/>
                                    <span>Ajouter une carte</span>
                                </button>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
};

// TIMELINE VIEW
const TimelineView=({categories,actions,tasks,onOpenTask,onOpenAction,onUpdateTask,filters,setFilters})=>{
    const{darkMode}=useApp();
    const timelineRef=useRef(null);
    const[zoom,setZoom]=useState('month');
    const[isPanning,setIsPanning]=useState(false);
    const[startX,setStartX]=useState(0);
    const[scrollLeft,setScrollLeft]=useState(0);
    const[spacePressed,setSpacePressed]=useState(false);
    const[resizing,setResizing]=useState(null); // {taskId, handle: 'left'|'right', startX, originalStart, originalEnd}
    const currentMonth=new Date().getMonth();
    const currentWeek=Math.floor((new Date().getTime()-new Date(2026,0,1).getTime())/(7*24*60*60*1000));

    useEffect(()=>{
        const handleKeyDown=(e)=>{if(e.code==='Space'&&!e.target.tagName.match(/INPUT|TEXTAREA/)){e.preventDefault();setSpacePressed(true);}};
        const handleKeyUp=(e)=>{if(e.code==='Space')setSpacePressed(false);};
        window.addEventListener('keydown',handleKeyDown);
        window.addEventListener('keyup',handleKeyUp);
        return()=>{window.removeEventListener('keydown',handleKeyDown);window.removeEventListener('keyup',handleKeyUp);};
    },[]);

    const handleMouseDown=(e)=>{if(!spacePressed)return;setIsPanning(true);setStartX(e.pageX-timelineRef.current.offsetLeft);setScrollLeft(timelineRef.current.scrollLeft);};
    const handleMouseMove=(e)=>{if(!isPanning)return;e.preventDefault();const x=e.pageX-timelineRef.current.offsetLeft;timelineRef.current.scrollLeft=scrollLeft-(x-startX)*2;};
    const handleMouseUp=()=>setIsPanning(false);

    const colWidth=zoom==='quarter'?280:zoom==='week'?40:100;

    // Resize handlers with useCallback to avoid recreating on every render
    const startResize=useCallback((taskId,handle,clientX,task)=>{
        setResizing({
            taskId,
            handle,
            startX:clientX,
            originalStart:task.startDate,
            originalEnd:task.dueDate
        });
    },[]);

    const endResize=useCallback(()=>{
        setResizing(null);
    },[]);

    useEffect(()=>{
        if(!resizing)return;

        const handleGlobalMouseMove=(e)=>{
            e.preventDefault();
            const deltaX=e.clientX-resizing.startX;
            const task=tasks.find(t=>t.id===resizing.taskId);
            if(!task)return;

            const pixelsPerDay=zoom==='month'?3.33:zoom==='week'?5.7:1;
            const daysMoved=Math.round(deltaX/pixelsPerDay);
            if(daysMoved===0)return;

            const originalStart=new Date(resizing.originalStart);
            const originalEnd=new Date(resizing.originalEnd);
            let newStart=resizing.originalStart;
            let newEnd=resizing.originalEnd;

            if(resizing.handle==='left'){
                const newStartDate=new Date(originalStart);
                newStartDate.setDate(newStartDate.getDate()+daysMoved);
                if(newStartDate.getTime()<originalEnd.getTime()){
                    newStart=newStartDate.toISOString().split('T')[0];
                }
            }else{
                const newEndDate=new Date(originalEnd);
                newEndDate.setDate(newEndDate.getDate()+daysMoved);
                if(newEndDate.getTime()>originalStart.getTime()){
                    newEnd=newEndDate.toISOString().split('T')[0];
                }
            }

            if(newStart!==task.startDate||newEnd!==task.dueDate){
                onUpdateTask(resizing.taskId,{startDate:newStart,dueDate:newEnd});
            }
        };

        const handleGlobalMouseUp=()=>{
            endResize();
        };

        const handleGlobalTouchMove=(e)=>{
            e.preventDefault();
            const deltaX=e.touches[0].clientX-resizing.startX;
            const task=tasks.find(t=>t.id===resizing.taskId);
            if(!task)return;

            const pixelsPerDay=zoom==='month'?3.33:zoom==='week'?5.7:1;
            const daysMoved=Math.round(deltaX/pixelsPerDay);
            if(daysMoved===0)return;

            const originalStart=new Date(resizing.originalStart);
            const originalEnd=new Date(resizing.originalEnd);
            let newStart=resizing.originalStart;
            let newEnd=resizing.originalEnd;

            if(resizing.handle==='left'){
                const newStartDate=new Date(originalStart);
                newStartDate.setDate(newStartDate.getDate()+daysMoved);
                if(newStartDate.getTime()<originalEnd.getTime()){
                    newStart=newStartDate.toISOString().split('T')[0];
                }
            }else{
                const newEndDate=new Date(originalEnd);
                newEndDate.setDate(newEndDate.getDate()+daysMoved);
                if(newEndDate.getTime()>originalStart.getTime()){
                    newEnd=newEndDate.toISOString().split('T')[0];
                }
            }

            if(newStart!==task.startDate||newEnd!==task.dueDate){
                onUpdateTask(resizing.taskId,{startDate:newStart,dueDate:newEnd});
            }
        };

        const handleGlobalTouchEnd=()=>{
            endResize();
        };

        document.addEventListener('mousemove',handleGlobalMouseMove);
        document.addEventListener('mouseup',handleGlobalMouseUp);
        document.addEventListener('touchmove',handleGlobalTouchMove,{passive:false});
        document.addEventListener('touchend',handleGlobalTouchEnd);

        return()=>{
            document.removeEventListener('mousemove',handleGlobalMouseMove);
            document.removeEventListener('mouseup',handleGlobalMouseUp);
            document.removeEventListener('touchmove',handleGlobalTouchMove);
            document.removeEventListener('touchend',handleGlobalTouchEnd);
        };
    },[resizing,tasks,onUpdateTask,zoom,endResize]);

    const getWeekNumber=(date)=>{
        const startOfYear=new Date(2026,0,1);
        const diff=date-startOfYear;
        return Math.floor(diff/(7*24*60*60*1000));
    };

    const getTaskPosition=(task)=>{
        if(!task.startDate||!task.dueDate)return null;
        const start=new Date(task.startDate);
        const end=new Date(task.dueDate);
        const startMonth=start.getMonth();
        const endMonth=end.getMonth();
        const startDay=start.getDate();
        const endDay=end.getDate();
        const daysInStartMonth=new Date(2026,startMonth+1,0).getDate();
        const daysInEndMonth=new Date(2026,endMonth+1,0).getDate();

        if(zoom==='week'){
            const startWeek=getWeekNumber(start);
            const endWeek=getWeekNumber(end);
            const startDayOfWeek=start.getDay();
            const endDayOfWeek=end.getDay();
            const startOffset=(startDayOfWeek/7)*colWidth;
            const totalWeeks=endWeek-startWeek;
            const endOffset=((6-endDayOfWeek)/7)*colWidth;
            const width=(totalWeeks+1)*colWidth-startOffset-endOffset;
            return{left:startWeek*colWidth+startOffset,width:Math.max(width,20)};
        }
        if(zoom==='month'){
            const startOffset=(startDay/daysInStartMonth)*colWidth;
            const totalMonths=endMonth-startMonth;
            const endOffset=((daysInEndMonth-endDay)/daysInEndMonth)*colWidth;
            const width=(totalMonths+1)*colWidth-startOffset-endOffset;
            return{left:startMonth*colWidth+startOffset,width:Math.max(width,30)};
        }
        return{left:startMonth*colWidth,width:colWidth};
    };

    const getWeekHeaders=()=>{
        const weeks=[];
        const months=[];
        let currentMonth=-1;
        for(let w=0;w<52;w++){
            const weekDate=new Date(2026,0,1+w*7);
            const month=weekDate.getMonth();
            if(month!==currentMonth){
                if(currentMonth!==-1){
                    months.push({month:currentMonth,label:CONFIG.MONTHS[currentMonth],startWeek:months.length>0?months[months.length-1].endWeek:0,endWeek:w});
                }else{
                    months.push({month,label:CONFIG.MONTHS[month],startWeek:0,endWeek:w});
                }
                currentMonth=month;
            }
            weeks.push({week:w,label:(w+1).toString()});
        }
        if(currentMonth!==-1){
            months[months.length-1].endWeek=52;
        }
        return{weeks,months};
    };

    const headers=zoom==='quarter'?[{q:1,label:'Q1',months:[0,1,2]},{q:2,label:'Q2',months:[3,4,5]},{q:3,label:'Q3',months:[6,7,8]},{q:4,label:'Q4',months:[9,10,11]}]:zoom==='week'?getWeekHeaders().weeks:CONFIG.MONTHS.map((m,i)=>({month:i,label:m}));
    const monthHeaders=zoom==='week'?getWeekHeaders().months:null;

    const filteredTasks=tasks.filter(t=>{
        const action=actions.find(a=>a.id===t.actionId);
        if(filters?.search&&!t.title.toLowerCase().includes(filters.search.toLowerCase()))return false;
        if(filters?.status.length>0&&!filters.status.includes(t.status))return false;
        if(filters?.priority.length>0&&!filters.priority.includes(t.priority))return false;
        if(filters?.category.length>0&&action&&!filters.category.includes(action.categoryId))return false;
        if(filters?.channel.length>0){
            const taskChannels=t.channels||action?.tags||[];
            if(!filters.channel.some(c=>taskChannels.includes(c)))return false;
        }
        return true;
    });

    const groupedByCategory=categories.map(cat=>({category:cat,actions:actions.filter(a=>a.categoryId===cat.id).map(action=>({action,tasks:filteredTasks.filter(t=>t.actionId===action.id)}))}));
    const scrollToQuarter=(q)=>{if(timelineRef.current)timelineRef.current.scrollLeft=(q-1)*3*colWidth;};

    const handleDrop=(e,monthIdx)=>{
        e.preventDefault();e.currentTarget.classList.remove('drag-over');
        const taskId=e.dataTransfer.getData('taskId');
        if(taskId&&onUpdateTask){
            const year=2026;
            const startDate=year+'-'+String(monthIdx+1).padStart(2,'0')+'-01';
            const lastDay=new Date(year,monthIdx+1,0).getDate();
            const dueDate=year+'-'+String(monthIdx+1).padStart(2,'0')+'-'+lastDay;
            onUpdateTask(taskId,{startDate,dueDate,month:monthIdx});
        }
    };
    const handleDragOver=(e)=>{e.preventDefault();e.currentTarget.classList.add('drag-over');};
    const handleDragLeave=(e)=>{e.currentTarget.classList.remove('drag-over');};

    return(
        <div className="animate-slide-in">
            <div className={`${darkMode?'bg-gray-900':'bg-white'} rounded-xl p-4 border ${darkMode?'border-gray-800':'border-gray-200'} mb-4`}>
                <div className="flex flex-wrap items-center justify-between gap-4">
                    <div className="flex items-center space-x-4">
                        <div className="flex items-center space-x-2">
                            <span className="text-sm text-gray-500">Zoom:</span>
                            <div className="flex rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700">
                                {[{id:'week',label:'Semaine'},{id:'month',label:'Mois'},{id:'quarter',label:'Trimestre'}].map(z=>(
                                    <button key={z.id} onClick={()=>setZoom(z.id)} className={`px-3 py-1.5 text-sm ${zoom===z.id?'bg-primary text-white':darkMode?'hover:bg-gray-800':'hover:bg-gray-100'}`}>{z.label}</button>
                                ))}
                            </div>
                        </div>
                        <div className="flex items-center space-x-1">
                            {[1,2,3,4].map(q=>(<button key={q} onClick={()=>scrollToQuarter(q)} className={`px-3 py-1.5 text-sm rounded ${darkMode?'bg-gray-800 hover:bg-gray-700':'bg-gray-100 hover:bg-gray-200'}`}>Q{q}</button>))}
                        </div>
                    </div>
                    <div className="flex items-center space-x-2 text-sm text-gray-500"><Icon.Hand/><span>Espace+Clic pour naviguer</span></div>
                </div>
            </div>
            <div className={`${darkMode?'bg-gray-900':'bg-white'} rounded-xl border ${darkMode?'border-gray-800':'border-gray-200'} overflow-hidden`}>
                <div ref={timelineRef} className={`overflow-x-auto ${spacePressed?'cursor-grab':''} ${isPanning?'cursor-grabbing':''}`} onMouseDown={handleMouseDown} onMouseMove={handleMouseMove} onMouseUp={handleMouseUp} onMouseLeave={handleMouseUp}>
                    <div style={{minWidth:`${headers.length*colWidth+250}px`}}>
                        {zoom==='week'&&monthHeaders&&(
                            <div className={`flex border-b ${darkMode?'border-gray-800':'border-gray-200'} sticky top-0 z-20 ${darkMode?'bg-gray-900':'bg-white'}`}>
                                <div className="w-[250px] flex-shrink-0"/>
                                {monthHeaders.map((m,idx)=>(
                                    <div key={idx} className={`flex-shrink-0 p-2 text-center font-semibold border-l ${darkMode?'border-gray-800':'border-gray-200'} ${m.month===currentMonth?'bg-secondary/10 text-secondary':''}`} style={{width:(m.endWeek-m.startWeek)*colWidth}}>
                                        {m.label}
                                    </div>
                                ))}
                            </div>
                        )}
                        <div className={`flex border-b ${darkMode?'border-gray-800':'border-gray-200'} ${zoom==='week'?'':'sticky top-0 z-10'} ${darkMode?'bg-gray-900':'bg-white'}`}>
                            <div className="w-[250px] flex-shrink-0 p-3 font-semibold text-sm">Actions</div>
                            {zoom==='quarter'?headers.map(h=>(
                                <div key={h.q} className={`flex-shrink-0 p-3 text-center font-semibold border-l ${darkMode?'border-gray-800':'border-gray-200'}`} style={{width:colWidth}}>
                                    <div>{h.label}</div>
                                    <div className="flex justify-around text-xs text-gray-500 mt-1">{h.months.map(m=><span key={m}>{CONFIG.MONTHS[m]}</span>)}</div>
                                </div>
                            )):zoom==='week'?headers.map((h,i)=>(
                                <div key={i} className={`flex-shrink-0 p-1 text-center text-xs font-medium border-l ${darkMode?'border-gray-800':'border-gray-200'} ${h.week===currentWeek?'bg-secondary/10 text-secondary':''}`} style={{width:colWidth}}>{h.label}</div>
                            )):headers.map((h,i)=>(
                                <div key={i} className={`flex-shrink-0 p-2 text-center text-xs font-medium border-l ${darkMode?'border-gray-800':'border-gray-200'} ${h.month===currentMonth?'bg-secondary/10 text-secondary':''}`} style={{width:colWidth}}>{h.label}</div>
                            ))}
                        </div>
                        {groupedByCategory.map(({category,actions:catActions})=>(
                            <div key={category.id}>
                                <div className={`flex border-b ${darkMode?'border-gray-800':'border-gray-200'}`}>
                                    <div className={`w-[250px] flex-shrink-0 p-3 font-bold text-white text-sm bg-gradient-to-r ${category.gradient}`}>{category.name}</div>
                                    <div className="flex-1" style={{background:darkMode?'rgba(55,65,81,0.3)':'rgba(243,244,246,0.5)'}}/>
                                </div>
                                {catActions.map(({action,tasks:actionTasks})=>(
                                    <div key={action.id} className={`flex border-b ${darkMode?'border-gray-800':'border-gray-200'} hover:bg-gray-50 dark:hover:bg-gray-800/30`}>
                                        <div className="w-[250px] flex-shrink-0 p-2 cursor-pointer" onClick={()=>onOpenAction&&onOpenAction(action)}>
                                            <p className="text-sm font-medium truncate hover:text-secondary">{action.name}</p>
                                            <p className="text-xs text-gray-500">{actionTasks.length} t√¢ches</p>
                                        </div>
                                        <div className="flex-1 relative" style={{height:'60px'}}>
                                            <div className="absolute inset-0 flex">
                                                {headers.map((_,i)=>(
                                                    <div key={i} className={`border-l ${darkMode?'border-gray-800':'border-gray-200'}`} style={{width:colWidth}} onDrop={(e)=>handleDrop(e,zoom==='month'?i:zoom==='quarter'?i*3:Math.floor(i/4))} onDragOver={handleDragOver} onDragLeave={handleDragLeave}/>
                                                ))}
                                            </div>
                                            {(zoom==='month'||zoom==='week')&&actionTasks.map(task=>{
                                                const pos=getTaskPosition(task);
                                                if(!pos)return null;
                                                const status=CONFIG.STATUSES.find(s=>s.id===task.status);
                                                return(
                                                    <div key={task.id} onClick={()=>onOpenTask(task)} draggable onDragStart={(e)=>{e.dataTransfer.setData('taskId',task.id);e.dataTransfer.setData('type','task');}} className="timeline-bar absolute top-2 h-10 rounded-lg flex items-center px-2 text-white text-xs shadow-sm overflow-hidden hover:brightness-110 transition-all" style={{left:pos.left,width:pos.width,backgroundColor:status?.color}} title={`${task.title}\n${status?.name}\n${task.startDate} ‚Üí ${task.dueDate}${task.description?'\n'+task.description:''}${task.budget?'\nBudget: '+task.budget+'‚Ç¨':''}`}>
                                                        <div className="resize-handle resize-handle-left" onMouseDown={(e)=>{e.stopPropagation();startResize(task.id,'left',e.clientX,task);}} onTouchStart={(e)=>{e.stopPropagation();startResize(task.id,'left',e.touches[0].clientX,task);}} title="Redimensionner d√©but"/>
                                                        <span className="truncate flex-1 px-1">{task.title}</span>
                                                        {task.budget>0&&zoom==='month'&&<span className="ml-1 opacity-75">({(task.budget/1000).toFixed(0)}k)</span>}
                                                        <div className="resize-handle resize-handle-right" onMouseDown={(e)=>{e.stopPropagation();startResize(task.id,'right',e.clientX,task);}} onTouchStart={(e)=>{e.stopPropagation();startResize(task.id,'right',e.touches[0].clientX,task);}} title="Redimensionner fin"/>
                                                    </div>
                                                );
                                            })}
                                            {zoom==='quarter'&&actionTasks.map(task=>{
                                                const month=task.month;
                                                const status=CONFIG.STATUSES.find(s=>s.id===task.status);
                                                const left=Math.floor(month/3)*colWidth+(month%3)*(colWidth/3);
                                                return(
                                                    <div key={task.id} onClick={()=>onOpenTask(task)} className="absolute top-2 h-10 rounded flex items-center justify-center text-white text-xs cursor-pointer hover:brightness-110" style={{left,width:colWidth/3-4,backgroundColor:status?.color}} title={task.title}>{status?.icon}</div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ))}
                    </div>
                </div>
            </div>
            <div className={`mt-4 ${darkMode?'bg-gray-900':'bg-white'} rounded-xl p-4 border ${darkMode?'border-gray-800':'border-gray-200'}`}>
                <p className="text-sm text-gray-500 mb-2">L√©gende:</p>
                <div className="flex flex-wrap gap-4">{CONFIG.STATUSES.map(s=><div key={s.id} className="flex items-center space-x-2"><div className="w-4 h-4 rounded" style={{backgroundColor:s.color}}/><span className="text-sm">{s.icon} {s.name}</span></div>)}</div>
            </div>
        </div>
    );
};

// DASHBOARD VIEW// DASHBOARD VIEW
const DashboardView=({categories,actions,tasks})=>{
    const{darkMode}=useApp();
    const totalTasks=tasks.length;
    const completedTasks=tasks.filter(t=>t.status==='completed').length;
    const totalBudget=tasks.reduce((s,t)=>s+(t.budget||0),0);
    const spentBudget=tasks.filter(t=>['completed','inprogress'].includes(t.status)).reduce((s,t)=>s+(t.budget||0),0);
    const progressPct=totalTasks>0?Math.round((completedTasks/totalTasks)*100):0;
    const currentMonth=new Date().getMonth();
    const currentTasks=tasks.filter(t=>t.month===currentMonth);
    const overdueTasks=tasks.filter(t=>t.status!=='completed'&&(t.month<currentMonth||(t.dueDate&&new Date(t.dueDate)<new Date())));

    const KPICard=({title,value,subtitle,icon:I,color})=>(
        <div className={`${darkMode?'bg-gray-900':'bg-white'} rounded-xl p-6 border ${darkMode?'border-gray-800':'border-gray-200'} shadow-sm`}>
            <div className="flex items-start justify-between"><div><p className="text-sm text-gray-500 mb-1">{title}</p><p className="text-3xl font-bold" style={{color}}>{value}</p>{subtitle&&<p className="text-sm text-gray-400 mt-1">{subtitle}</p>}</div><div className="p-3 rounded-xl" style={{backgroundColor:`${color}20`}}><I/></div></div>
        </div>
    );

    return(
        <div className="space-y-6 animate-slide-in">
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <KPICard title="Avancement" value={`${progressPct}%`} subtitle={`${completedTasks}/${totalTasks} t√¢ches`} icon={Icon.TrendUp} color="#5cc29d"/>
                <KPICard title="Budget" value={`${(spentBudget/1000).toFixed(0)}k‚Ç¨`} subtitle={`sur ${(totalBudget/1000).toFixed(0)}k‚Ç¨`} icon={Icon.Dollar} color="#3781ec"/>
                <KPICard title="Ce mois" value={currentTasks.length} subtitle="t√¢ches actives" icon={Icon.Calendar} color="#f2cb13"/>
                <KPICard title="En retard" value={overdueTasks.length} subtitle={overdueTasks.length>0?'√† traiter':'Tout OK!'} icon={Icon.Alert} color={overdueTasks.length>0?'#ff5338':'#5cc29d'}/>
            </div>
            <div className={`${darkMode?'bg-gray-900':'bg-white'} rounded-xl p-6 border ${darkMode?'border-gray-800':'border-gray-200'}`}>
                <h3 className="font-semibold mb-4">Progression par cat√©gorie</h3>
                <div className="space-y-4">
                    {categories.map(cat=>{
                        const catActions=actions.filter(a=>a.categoryId===cat.id);
                        const catTasks=tasks.filter(t=>catActions.some(a=>a.id===t.actionId));
                        const catCompleted=catTasks.filter(t=>t.status==='completed').length;
                        const catPct=catTasks.length>0?Math.round((catCompleted/catTasks.length)*100):0;
                        const catBudget=catTasks.reduce((s,t)=>s+(t.budget||0),0);
                        return(
                            <div key={cat.id}>
                                <div className="flex items-center justify-between mb-2"><div className="flex items-center space-x-3"><div className={`w-3 h-3 rounded-full bg-gradient-to-r ${cat.gradient}`}/><span className="font-medium text-sm">{cat.name}</span></div><div className="flex items-center space-x-4 text-sm"><span className="text-gray-500">{catCompleted}/{catTasks.length}</span><span className="font-semibold text-secondary">{(catBudget/1000).toFixed(0)}k‚Ç¨</span><span className="font-bold">{catPct}%</span></div></div>
                                <div className="h-3 bg-gray-200 dark:bg-gray-700 rounded-full"><div className={`h-full rounded-full bg-gradient-to-r ${cat.gradient}`} style={{width:`${catPct}%`}}/></div>
                            </div>
                        );
                    })}
                </div>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div className={`${darkMode?'bg-gray-900':'bg-white'} rounded-xl p-6 border ${darkMode?'border-gray-800':'border-gray-200'}`}>
                    <h3 className="font-semibold mb-4">Par statut</h3>
                    <div className="space-y-3">
                        {CONFIG.STATUSES.map(s=>{const count=tasks.filter(t=>t.status===s.id).length;const pct=totalTasks>0?Math.round((count/totalTasks)*100):0;return(<div key={s.id} className="flex items-center"><div className="w-28 flex items-center space-x-2"><span>{s.icon}</span><span className="text-sm">{s.name}</span></div><div className="flex-1 h-4 bg-gray-200 dark:bg-gray-700 rounded-full mx-3"><div className="h-full rounded-full" style={{width:`${pct}%`,backgroundColor:s.color}}/></div><span className="w-8 text-right text-sm font-medium">{count}</span></div>);})}
                    </div>
                </div>
                <div className={`${darkMode?'bg-gray-900':'bg-white'} rounded-xl p-6 border ${overdueTasks.length>0?'border-accent-red':darkMode?'border-gray-800':'border-gray-200'}`}>
                    <h3 className="font-semibold mb-4">üö® En retard</h3>
                    <div className="space-y-2 max-h-64 overflow-y-auto">
                        {overdueTasks.length>0?overdueTasks.slice(0,8).map(t=>{const action=actions.find(a=>a.id===t.actionId);return<div key={t.id} className="p-3 rounded-lg bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800"><p className="font-medium text-sm">{t.title}</p><p className="text-xs text-red-600">{action?.name} ‚Ä¢ {CONFIG.MONTHS_FULL[t.month]}</p></div>;}):<div className="text-center py-8"><span className="text-4xl">‚úÖ</span><p className="text-gray-500 text-sm mt-2">Tout est √† jour!</p></div>}
                    </div>
                </div>
            </div>
            <div className={`${darkMode?'bg-gray-900':'bg-white'} rounded-xl p-6 border ${darkMode?'border-gray-800':'border-gray-200'}`}>
                <h3 className="font-semibold mb-4">üì¢ Par canal</h3>
                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                    {CONFIG.CHANNELS.map(ch=>{
                        const chTasks=tasks.filter(t=>(t.channels||[]).includes(ch.id));
                        const chCompleted=chTasks.filter(t=>t.status==='completed').length;
                        return(
                            <div key={ch.id} className={`p-3 rounded-lg border ${darkMode?'border-gray-700 bg-gray-800/50':'border-gray-200 bg-gray-50'}`}>
                                <div className="flex items-center space-x-2 mb-2">
                                    <div className="w-3 h-3 rounded-full" style={{backgroundColor:ch.color}}/>
                                    <span className="text-sm font-medium truncate">{ch.name}</span>
                                </div>
                                <div className="text-2xl font-bold">{chTasks.length}</div>
                                <div className="text-xs text-gray-500">{chCompleted} termin√©es</div>
                            </div>
                        );
                    })}
                </div>
            </div>
        </div>
    );
};

// FILTER BAR
const FilterBar=({filters,setFilters,actions,categories})=>{
    const{darkMode}=useApp();
    const[showFilters,setShowFilters]=useState(false);
    const activeCount=Object.values(filters).filter(v=>Array.isArray(v)?v.length>0:v).length;

    return(
        <div className={`${darkMode?'bg-gray-900':'bg-white'} rounded-xl shadow-sm border ${darkMode?'border-gray-800':'border-gray-200'} p-4 mb-4`}>
            <div className="flex flex-wrap items-center gap-3">
                <div className="flex-1 min-w-[200px]"><input type="text" placeholder="Rechercher..." value={filters.search} onChange={e=>setFilters({...filters,search:e.target.value})} className={`w-full px-4 py-2 rounded-lg border ${darkMode?'bg-gray-800 border-gray-700 text-white':'bg-gray-50 border-gray-200'} focus:outline-none focus:ring-2 focus:ring-secondary`}/></div>
                <button onClick={()=>setShowFilters(!showFilters)} className={`flex items-center space-x-2 px-4 py-2 rounded-lg border ${showFilters||activeCount>0?'bg-secondary text-white border-secondary':darkMode?'border-gray-700':'border-gray-200'}`}><Icon.Filter/><span>Filtres</span>{activeCount>0&&<span className="bg-white text-secondary px-2 py-0.5 rounded-full text-xs font-bold">{activeCount}</span>}</button>
                {activeCount>0&&<button onClick={()=>setFilters({search:'',status:[],category:[],priority:[],action:[],channel:[]})} className="text-accent-red text-sm">Effacer</button>}
            </div>
            {showFilters&&(
                <div className="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 grid grid-cols-1 sm:grid-cols-3 gap-4 animate-slide-in">
                    <div><label className="block text-xs text-gray-500 mb-2">Statut</label><div className="flex flex-wrap gap-1">{CONFIG.STATUSES.map(s=>(<button key={s.id} onClick={()=>{const n=filters.status.includes(s.id)?filters.status.filter(x=>x!==s.id):[...filters.status,s.id];setFilters({...filters,status:n});}} className={`px-2 py-1 rounded text-xs ${filters.status.includes(s.id)?'text-white':darkMode?'bg-gray-800':'bg-gray-100'}`} style={filters.status.includes(s.id)?{backgroundColor:s.color}:{}}>{s.icon}</button>))}</div></div>
                    <div><label className="block text-xs text-gray-500 mb-2">Cat√©gorie</label><div className="flex flex-wrap gap-1">{categories.map(c=>(<button key={c.id} onClick={()=>{const n=filters.category.includes(c.id)?filters.category.filter(x=>x!==c.id):[...filters.category,c.id];setFilters({...filters,category:n});}} className={`px-2 py-1 rounded text-xs ${filters.category.includes(c.id)?'text-white bg-gradient-to-r '+c.gradient:darkMode?'bg-gray-800':'bg-gray-100'}`}>{c.name.split(' ')[0]}</button>))}</div></div>
                    <div><label className="block text-xs text-gray-500 mb-2">Priorit√©</label><div className="flex gap-1">{CONFIG.PRIORITIES.map(p=>(<button key={p.id} onClick={()=>{const n=filters.priority.includes(p.id)?filters.priority.filter(x=>x!==p.id):[...filters.priority,p.id];setFilters({...filters,priority:n});}} className={`px-2 py-1 rounded text-xs ${filters.priority.includes(p.id)?'text-white':darkMode?'bg-gray-800':'bg-gray-100'}`} style={filters.priority.includes(p.id)?{backgroundColor:p.color}:{}}>{p.icon}</button>))}</div></div>
                    <div className="sm:col-span-3"><label className="block text-xs text-gray-500 mb-2">Canal</label><div className="flex flex-wrap gap-1"><button onClick={()=>setFilters({...filters,channel:[]})} className={`px-2 py-1 rounded text-xs ${!filters.channel||filters.channel.length===0?'bg-primary text-white':darkMode?'bg-gray-800':'bg-gray-100'}`}>Tous</button>{CONFIG.CHANNELS.map(ch=>(<button key={ch.id} onClick={()=>{const n=filters.channel?.includes(ch.id)?filters.channel.filter(x=>x!==ch.id):[...(filters.channel||[]),ch.id];setFilters({...filters,channel:n});}} className={`px-2 py-1 rounded text-xs ${filters.channel?.includes(ch.id)?'text-white':darkMode?'bg-gray-800':'bg-gray-100'}`} style={filters.channel?.includes(ch.id)?{backgroundColor:ch.color}:{}}>{ch.name}</button>))}</div></div>
                </div>
            )}
        </div>
    );
};

// MAIN APP
const App=()=>{
    const[darkMode,setDarkMode]=useState(()=>{
        const saved=localStorage.getItem('darkMode');
        return saved?saved==='true':false;
    });
    const[currentView,setCurrentView]=useState('kanban');
    const[categories,setCategories]=useState(CONFIG.CATEGORIES);
    const[actions,setActions]=useState(ACTIONS);
    const[tasks,setTasks]=useState(TASKS);
    const[filters,setFilters]=useState({search:'',status:[],category:[],priority:[],channel:[]});
    const[syncing,setSyncing]=useState(false);
    const[savingStatus,setSavingStatus]=useState(null);
    const[selectedTask,setSelectedTask]=useState(null);
    const[selectedAction,setSelectedAction]=useState(null);
    const[notification,setNotification]=useState(null);
    const[githubToken,setGithubToken]=useState('');
    const[showCategoriesModal,setShowCategoriesModal]=useState(false);
    const[showNewActionModal,setShowNewActionModal]=useState(false);
    const[showNewTaskModal,setShowNewTaskModal]=useState(false);
    const[dataLoaded,setDataLoaded]=useState(false);
    const[fileSha,setFileSha]=useState(()=>{
        // CRITICAL FIX: Restore SHA from localStorage on init
        return localStorage.getItem('github_file_sha')||'';
    });
    const saveQueueRef=useRef([]);
    const isSavingRef=useRef(false);

    // ‚ö†Ô∏è CONFIGURATION GITHUB - MODIFIEZ VOTRE TOKEN ICI
    // Pour obtenir un token: https://github.com/settings/tokens
    // Permissions requises: repo (Full control of private repositories)
    const GITHUB_CONFIG={
        owner:'FbnCrr',
        repo:'Dashboard-marketing',
        branch:'main',
        path:'data.json',
        token:'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' // ‚Üê Remplacez par votre token GitHub Personnel
    };

    // UTF-8 safe Base64 encoding/decoding
    const base64EncodeUnicode=(str)=>{
        return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,(match,p1)=>String.fromCharCode('0x'+p1)));
    };
    const base64DecodeUnicode=(str)=>{
        return decodeURIComponent(atob(str).split('').map(c=>'%'+('00'+c.charCodeAt(0).toString(16)).slice(-2)).join(''));
    };

    // CRITICAL HELPER: Fetch GitHub API with consistent cache busting
    const fetchGitHubAPI=(url,options={})=>{
        const timestamp=Date.now();
        const random=Math.random().toString(36).substring(7);
        const cacheBustedUrl=`${url}${url.includes('?')?'&':'?'}_=${timestamp}&r=${random}`;

        return fetch(cacheBustedUrl,{
            ...options,
            headers:{
                ...options.headers,
                'Cache-Control':'no-store, no-cache, must-revalidate, proxy-revalidate',
                'Pragma':'no-cache',
                'Expires':'0'
            },
            cache:'no-store'
        });
    };

    useEffect(()=>{document.body.className=darkMode?'dark':'light';},[darkMode]);

    // Keyboard shortcuts
    useEffect(()=>{
        const handleKeyPress=(e)=>{
            if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA')return;
            if(e.key==='Escape'){
                if(selectedTask)setSelectedTask(null);
                else if(selectedAction)setSelectedAction(null);
                else if(showCategoriesModal)setShowCategoriesModal(false);
                else if(showNewActionModal)setShowNewActionModal(false);
                else if(showNewTaskModal)setShowNewTaskModal(false);
            }
            if(e.key==='n'&&!e.ctrlKey&&!e.metaKey)handleCreateNewTask();
            if((e.key==='1'||e.key==='&')&&!e.ctrlKey&&!e.metaKey)setCurrentView('kanban');
            if((e.key==='2'||e.key==='√©')&&!e.ctrlKey&&!e.metaKey)setCurrentView('timeline');
            if((e.key==='3'||e.key==='"')&&!e.ctrlKey&&!e.metaKey)setCurrentView('dashboard');
        };
        document.addEventListener('keydown',handleKeyPress);
        return()=>document.removeEventListener('keydown',handleKeyPress);
    },[selectedTask,selectedAction,showCategoriesModal,showNewActionModal,showNewTaskModal]);

    useEffect(()=>{
        // Use integrated token from GITHUB_CONFIG
        const token=GITHUB_CONFIG.token;
        if(token&&token!=='VOTRE_TOKEN_ICI'){
            setGithubToken(token);
            loadDataFromGitHub(token);
        }else{
            console.warn('‚ö†Ô∏è Token GitHub non configur√©. Veuillez ajouter votre token dans GITHUB_CONFIG');
            loadFromLocalStorage();
            setDataLoaded(true);
        }
    },[]);

    // Persist dark mode preference
    useEffect(()=>{
        localStorage.setItem('darkMode',darkMode);
    },[darkMode]);

    // CRITICAL FIX: Persist SHA to localStorage whenever it changes
    useEffect(()=>{
        if(fileSha){
            localStorage.setItem('github_file_sha',fileSha);
            console.log('üìå SHA persist√©:',fileSha.substring(0,8)+'...');
        }else{
            localStorage.removeItem('github_file_sha');
        }
    },[fileSha]);

    const loadDataFromGitHub=async(token)=>{
        if(!token){
            loadFromLocalStorage();
            setDataLoaded(true);
            return;
        }
        try{
            console.log('üì• Loading from GitHub...');
            const url=`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}?ref=${GITHUB_CONFIG.branch}`;
            const response=await fetchGitHubAPI(url,{
                method:'GET',
                headers:{
                    Authorization:`Bearer ${token}`,
                    Accept:'application/vnd.github.v3+json'
                }
            });
            if(response.ok){
                const data=await response.json();
                console.log('üì• Loaded from GitHub. SHA:',data.sha,'Size:',data.size,'Last modified:',data.sha.substring(0,8));
                const decodedContent=base64DecodeUnicode(data.content.replace(/\n/g,'').replace(/\s/g,''));
                const content=JSON.parse(decodedContent);

                // Validate loaded data structure
                const isValidCategories=Array.isArray(content.categories)&&content.categories.every(c=>c.id&&c.name);
                const isValidActions=Array.isArray(content.actions)&&content.actions.every(a=>a.id&&a.name);
                const isValidTasks=Array.isArray(content.tasks)&&content.tasks.every(t=>t.id&&t.title);

                if(!isValidCategories||!isValidActions||!isValidTasks){
                    console.error('‚ö†Ô∏è Invalid data structure from GitHub',{
                        categories:isValidCategories,
                        actions:isValidActions,
                        tasks:isValidTasks
                    });
                    showNotification('‚ö†Ô∏è Donn√©es GitHub invalides, backup local charg√©');
                    loadFromLocalStorage();
                    setDataLoaded(true);
                    return;
                }

                // Update state with loaded data
                setCategories(content.categories||CONFIG.CATEGORIES);
                setActions(content.actions||ACTIONS);
                setTasks(content.tasks||TASKS);
                setFileSha(data.sha);

                // Save to localStorage as backup
                saveToLocalStorage();

                console.log('‚úÖ GitHub loaded successfully. Categories:',content.categories?.length,'Actions:',content.actions?.length,'Tasks:',content.tasks?.length);
                showNotification('‚úÖ Donn√©es charg√©es depuis GitHub');
            }else if(response.status===404){
                console.warn('‚ö†Ô∏è File not found on GitHub, will create on first save');
                showNotification('‚ö†Ô∏è Fichier data.json non trouv√© - cr√©ation au premier save');
                loadFromLocalStorage();
                setFileSha(''); // Clear SHA for new file
            }else{
                const errorText=await response.text();
                console.error('GitHub load error:',response.status,errorText);
                showNotification(`‚ùå Erreur GitHub: ${response.status} ${response.statusText}`);
                loadFromLocalStorage();
            }
        }catch(e){
            console.error('Erreur chargement GitHub:',e);
            showNotification('‚ö†Ô∏è Erreur chargement GitHub, backup local charg√©');
            loadFromLocalStorage();
        }finally{
            setDataLoaded(true);
        }
    };

    const loadFromLocalStorage=()=>{
        try{
            const backup=localStorage.getItem('marketing_tracker_backup');
            if(backup){
                const data=JSON.parse(backup);
                setCategories(data.categories||CONFIG.CATEGORIES);
                setActions(data.actions||ACTIONS);
                setTasks(data.tasks||TASKS);
                showNotification('üì¶ Backup local charg√©');
            }
        }catch(e){
            console.error('LocalStorage load error:',e);
        }
    };

    const saveToGitHub=async()=>{
        if(!githubToken){showNotification('‚ö†Ô∏è Token GitHub manquant');return;}
        setSyncing(true);
        try{
            // First, try to get current file SHA if we don't have it
            let currentSha=fileSha;
            if(!currentSha){
                console.log('‚ö†Ô∏è No SHA found, fetching current file...');
                try{
                    const url=`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}?ref=${GITHUB_CONFIG.branch}`;
                    const checkResponse=await fetchGitHubAPI(url,{
                        headers:{
                            Authorization:`Bearer ${githubToken}`,
                            Accept:'application/vnd.github.v3+json'
                        }
                    });
                    if(checkResponse.ok){
                        const existingFile=await checkResponse.json();
                        currentSha=existingFile.sha;
                        setFileSha(currentSha);
                        console.log('‚úÖ Retrieved existing SHA:',currentSha.substring(0,8)+'...');
                    }else if(checkResponse.status===404){
                        console.log('‚ÑπÔ∏è File does not exist yet, will create new file');
                    }
                }catch(e){
                    console.warn('Could not check existing file:',e);
                }
            }

            const jsonString=JSON.stringify({categories,actions,tasks},null,2);
            const content=base64EncodeUnicode(jsonString);

            // Build body
            const body={
                message:`Update data from Marketing Tracker V2.2 - ${new Date().toISOString()}`,
                content:content,
                branch:GITHUB_CONFIG.branch
            };

            // Only add sha if it exists (file exists on GitHub)
            if(currentSha){
                body.sha=currentSha;
            }

            console.log('üíæ Saving to GitHub...',{
                owner:GITHUB_CONFIG.owner,
                repo:GITHUB_CONFIG.repo,
                path:GITHUB_CONFIG.path,
                branch:GITHUB_CONFIG.branch,
                hasSha:!!currentSha,
                sha:currentSha?currentSha.substring(0,8)+'...':'none',
                contentLength:content.length,
                jsonLength:jsonString.length
            });

            const response=await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`,{
                method:'PUT',
                headers:{
                    Authorization:`Bearer ${githubToken}`,
                    Accept:'application/vnd.github.v3+json',
                    'Content-Type':'application/json'
                },
                body:JSON.stringify(body)
            });

            if(response.ok){
                const data=await response.json();
                setFileSha(data.content.sha);
                console.log('‚úÖ GitHub save successful. New SHA:',data.content.sha);
                showNotification('‚úÖ Sauvegarde GitHub r√©ussie');
                // Force localStorage update
                saveToLocalStorage();
                return true;
            }else{
                const errorText=await response.text();
                let errorDetails;
                try{
                    errorDetails=JSON.parse(errorText);
                }catch(e){
                    errorDetails={message:errorText};
                }

                // Handle SHA conflict (409)
                if(response.status===409||errorDetails.message?.includes('does not match')){
                    console.warn('‚ö†Ô∏è SHA conflict detected, trying to re-fetch and retry...');
                    showNotification('‚ö†Ô∏è Conflit d√©tect√©, synchronisation...');

                    // Re-fetch the current file to get the latest SHA WITH cache busting
                    try{
                        const url=`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}?ref=${GITHUB_CONFIG.branch}`;
                        const refetchResponse=await fetchGitHubAPI(url,{
                            headers:{
                                Authorization:`Bearer ${githubToken}`,
                                Accept:'application/vnd.github.v3+json'
                            }
                        });

                        if(refetchResponse.ok){
                            const latestFile=await refetchResponse.json();
                            const latestSha=latestFile.sha;
                            setFileSha(latestSha);
                            console.log('‚úÖ Retrieved latest SHA:',latestSha.substring(0,8)+'...');

                            // Ask user if they want to overwrite
                            if(confirm('Le fichier a √©t√© modifi√© ailleurs. Voulez-vous √©craser avec vos modifications locales ?')){
                                // Retry with new SHA
                                body.sha=latestSha;
                                const retryResponse=await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`,{
                                    method:'PUT',
                                    headers:{
                                        Authorization:`Bearer ${githubToken}`,
                                        Accept:'application/vnd.github.v3+json',
                                        'Content-Type':'application/json'
                                    },
                                    body:JSON.stringify(body)
                                });

                                if(retryResponse.ok){
                                    const retryData=await retryResponse.json();
                                    setFileSha(retryData.content.sha);
                                    console.log('‚úÖ Retry successful. New SHA:',retryData.content.sha);
                                    showNotification('‚úÖ Sauvegarde GitHub r√©ussie apr√®s conflit');
                                    saveToLocalStorage();
                                    return true;
                                }else{
                                    showNotification('‚ùå √âchec de la sauvegarde apr√®s retry');
                                    return false;
                                }
                            }else{
                                showNotification('‚ö†Ô∏è Sauvegarde annul√©e - rechargez pour voir les modifications distantes');
                                return false;
                            }
                        }else{
                            showNotification('‚ùå Impossible de r√©cup√©rer le SHA distant');
                            return false;
                        }
                    }catch(retryError){
                        console.error('Error during retry:',retryError);
                        showNotification('‚ùå Erreur lors de la r√©solution du conflit');
                        return false;
                    }
                }

                console.error('GitHub API error:',{
                    status:response.status,
                    statusText:response.statusText,
                    error:errorDetails,
                    bodyPreview:JSON.stringify(body).substring(0,200)
                });
                showNotification(`‚ùå Erreur ${response.status}: ${errorDetails.message||response.statusText}`);
                return false;
            }
        }catch(e){
            console.error('Erreur sauvegarde GitHub:',e);
            showNotification(`‚ùå Erreur: ${e.message}`);
            return false;
        }finally{
            setSyncing(false);
        }
    };

    const autoSaveTimeoutRef=useRef(null);

    const saveToLocalStorage=()=>{
        try{
            const data={categories,actions,tasks,timestamp:Date.now()};
            localStorage.setItem('marketing_tracker_backup',JSON.stringify(data));
        }catch(e){
            console.error('LocalStorage save error:',e);
        }
    };

    const autoSave=()=>{
        setSavingStatus('saving');
        if(autoSaveTimeoutRef.current)clearTimeout(autoSaveTimeoutRef.current);
        autoSaveTimeoutRef.current=setTimeout(async()=>{
            // CRITICAL FIX: Save to GitHub FIRST, then localStorage
            if(githubToken){
                const success=await saveToGitHub();
                // saveToGitHub already calls saveToLocalStorage() on success
                setSavingStatus(success?'saved':'error');
                if(!success){
                    // If GitHub failed, at least save locally as backup
                    saveToLocalStorage();
                }
            }else{
                // No GitHub token: only save locally
                saveToLocalStorage();
                setSavingStatus('saved');
            }
            setTimeout(()=>setSavingStatus(null),2000);
        },2000); // Reduced from 5000ms to 2000ms for faster saves
    };

    const handleSync=()=>saveToGitHub();

    const handleUpdateTask=(taskId,updates)=>{
        setTasks(prev=>prev.map(t=>{
            if(t.id!==taskId)return t;
            const newTask={...t,...updates};
            if(updates.dueDate){
                const d=new Date(updates.dueDate);
                newTask.month=d.getMonth();
            }
            return newTask;
        }));
        showNotification('‚úÖ T√¢che mise √† jour');
        autoSave();
    };

    const handleUpdateAction=(actionId,updates)=>{
        setActions(prev=>prev.map(a=>a.id===actionId?{...a,...updates}:a));
        showNotification('‚úÖ Action mise √† jour');
        autoSave();
    };

    const handleDeleteAction=(actionId)=>{
        const action=actions.find(a=>a.id===actionId);
        const affectedTasks=tasks.filter(t=>t.actionId===actionId).length;
        const confirmMessage=affectedTasks>0
            ?`Voulez-vous vraiment supprimer l'action "${action?.name}" ?\n\nCela supprimera √©galement ${affectedTasks} t√¢che(s) associ√©e(s).`
            :`Voulez-vous vraiment supprimer l'action "${action?.name}" ?`;

        if(!confirm(confirmMessage))return;

        setActions(prev=>prev.filter(a=>a.id!==actionId));
        setTasks(prev=>prev.filter(t=>t.actionId!==actionId));
        showNotification('üóëÔ∏è Action supprim√©e');
        autoSave();
    };

    const handleAddTask=(actionId)=>{
        const action=actions.find(a=>a.id===actionId);
        const month=new Date().getMonth();
        const startDate=new Date().toISOString().split('T')[0];
        const endOfMonth=new Date(2026,month+1,0).getDate();
        const dueDate=`2026-${String(month+1).padStart(2,'0')}-${endOfMonth}`;
        const newTask={id:`t${Date.now()}`,actionId,month,startDate,title:'Nouvelle t√¢che',description:'',status:'todo',priority:'medium',dueDate,budget:0,channels:action?.tags||[],checklist:[],comments:[],attachments:[]};
        setTasks(prev=>[...prev,newTask]);
        setSelectedTask(newTask);
        showNotification('‚úÖ T√¢che cr√©√©e');
        autoSave();
    };

    const handleDeleteTask=(taskId)=>{
        setTasks(prev=>prev.filter(t=>t.id!==taskId));
        showNotification('üóëÔ∏è T√¢che supprim√©e');
        autoSave();
    };

    const handleCreateNewTask=()=>setShowNewTaskModal(true);

    const handleUpdateCategory=(catId,updates)=>{
        setCategories(prev=>prev.map(c=>c.id===catId?{...c,...updates}:c));
        showNotification('‚úÖ Cat√©gorie mise √† jour');
        autoSave();
    };

    const handleAddCategory=(newCat)=>{
        setCategories(prev=>[...prev,newCat]);
        showNotification('‚úÖ Cat√©gorie cr√©√©e');
        autoSave();
    };

    const handleDeleteCategory=(catId)=>{
        const category=categories.find(c=>c.id===catId);
        const affectedActions=actions.filter(a=>a.categoryId===catId).length;
        const confirmMessage=affectedActions>0
            ?`Voulez-vous vraiment supprimer la cat√©gorie "${category?.name}" ?\n\nCela supprimera √©galement ${affectedActions} action(s) associ√©e(s).`
            :`Voulez-vous vraiment supprimer la cat√©gorie "${category?.name}" ?`;

        if(!confirm(confirmMessage))return;

        setCategories(prev=>prev.filter(c=>c.id!==catId));
        setActions(prev=>prev.filter(a=>a.categoryId!==catId));
        showNotification('üóëÔ∏è Cat√©gorie supprim√©e');
        autoSave();
    };

    const handleReorderCategories=(reorderedCategories)=>{
        setCategories(reorderedCategories);
        showNotification('‚úÖ Ordre des cat√©gories mis √† jour');
        autoSave();
    };

    const handleAddAction=(newAction)=>{
        setActions(prev=>[...prev,newAction]);
        showNotification('‚úÖ Action cr√©√©e');
        autoSave();
    };

    const handleAddNewTask=(newTask)=>{
        setTasks(prev=>[...prev,newTask]);
        showNotification('‚úÖ T√¢che cr√©√©e');
        autoSave();
    };

    const showNotification=(msg)=>{setNotification(msg);setTimeout(()=>setNotification(null),3000);};

    const exportToJSON=()=>{
        const data={categories,actions,tasks,exportDate:new Date().toISOString()};
        const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url;
        a.download=`marketing-tracker-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showNotification('üì• Export JSON t√©l√©charg√©');
    };

    const exportToCSV=()=>{
        const headers=['ID','Titre','Action','Cat√©gorie','Statut','Priorit√©','Date d√©but','Date fin','Budget','Channels','Description'];
        const rows=tasks.map(t=>{
            const action=actions.find(a=>a.id===t.actionId);
            const category=categories.find(c=>c.id===action?.categoryId);
            return[
                t.id,
                t.title,
                action?.name||'',
                category?.name||'',
                CONFIG.STATUSES.find(s=>s.id===t.status)?.name||t.status,
                CONFIG.PRIORITIES.find(p=>p.id===t.priority)?.name||t.priority,
                t.startDate||'',
                t.dueDate||'',
                t.budget||0,
                (t.channels||[]).join(';'),
                (t.description||'').replace(/"/g,'""')
            ].map(v=>`"${v}"`).join(',');
        });
        const csv=[headers.join(','),...rows].join('\n');
        const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url;
        a.download=`marketing-tracker-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        showNotification('üìä Export CSV t√©l√©charg√©');
    };

    const totalBudget=tasks.reduce((s,t)=>s+(t.budget||0),0);
    const completedCount=tasks.filter(t=>t.status==='completed').length;

    if(!dataLoaded)return(<div className="min-h-screen flex items-center justify-center bg-gray-950"><div className="text-white text-center"><div className="animate-spin w-12 h-12 border-4 border-secondary border-t-transparent rounded-full mx-auto mb-4"/><p>Chargement des donn√©es...</p></div></div>);

    return(
        <AppContext.Provider value={{darkMode}}>
            <div className={`min-h-screen ${darkMode?'bg-gray-950':'bg-gray-50'}`}>
                <Header darkMode={darkMode} setDarkMode={setDarkMode} currentView={currentView} setCurrentView={setCurrentView} onSync={handleSync} syncing={syncing} githubConnected={!!githubToken} savingStatus={savingStatus}/>
                <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                    <div className="flex flex-wrap items-center justify-between gap-4 mb-6">
                        <div><h2 className="text-2xl font-bold">{currentView==='kanban'?'üìã Kanban':currentView==='timeline'?'üìÖ Timeline':'üìä KPIs'}</h2><p className="text-gray-500 text-sm">{tasks.length} t√¢ches ‚Ä¢ {completedCount} termin√©es ‚Ä¢ Budget: {(totalBudget/1000).toFixed(0)}k‚Ç¨</p><p className="text-xs text-gray-400 mt-1">Raccourcis: N=Nouvelle t√¢che ‚Ä¢ 1/2/3=Vues ‚Ä¢ ESC=Fermer</p></div>
                        <div className="flex gap-2">
                            <div className="relative group">
                                <button className={`px-4 py-2 rounded-lg flex items-center space-x-2 ${darkMode?'bg-gray-800 hover:bg-gray-700':'bg-gray-200 hover:bg-gray-300'}`}><Icon.Download/><span className="hidden sm:inline">Export</span></button>
                                <div className={`absolute right-0 mt-1 w-40 rounded-lg shadow-lg ${darkMode?'bg-gray-800 border border-gray-700':'bg-white border border-gray-200'} hidden group-hover:block z-50`}>
                                    <button onClick={exportToJSON} className={`w-full px-4 py-2 text-left text-sm hover:bg-secondary/10 rounded-t-lg`}>üìÑ Export JSON</button>
                                    <button onClick={exportToCSV} className={`w-full px-4 py-2 text-left text-sm hover:bg-secondary/10 rounded-b-lg`}>üìä Export CSV</button>
                                </div>
                            </div>
                            <button onClick={()=>setShowCategoriesModal(true)} className={`px-4 py-2 rounded-lg flex items-center space-x-2 ${darkMode?'bg-gray-800 hover:bg-gray-700':'bg-gray-200 hover:bg-gray-300'}`}><Icon.Folder/><span className="hidden sm:inline">Cat√©gories</span></button>
                            <button onClick={()=>setShowNewActionModal(true)} className={`px-4 py-2 rounded-lg flex items-center space-x-2 ${darkMode?'bg-gray-800 hover:bg-gray-700':'bg-gray-200 hover:bg-gray-300'}`}><Icon.List/><span className="hidden sm:inline">Nouvelle action</span></button>
                            <button onClick={handleCreateNewTask} className="px-4 py-2 bg-primary text-white rounded-lg flex items-center space-x-2 hover:bg-primary/90 shadow-md"><Icon.Plus/><span>Nouvelle t√¢che</span></button>
                        </div>
                    </div>
                    <FilterBar filters={filters} setFilters={setFilters} actions={actions} categories={categories}/>
                    {(filters.search||filters.status.length>0||filters.category.length>0||filters.priority.length>0||filters.channel.length>0)&&(
                        <div className={`mb-4 px-4 py-2 rounded-lg flex items-center justify-between ${darkMode?'bg-secondary/10 border border-secondary/20':'bg-blue-50 border border-blue-200'}`}>
                            <span className="text-sm text-secondary">üîç Filtres actifs ‚Ä¢ {tasks.filter(t=>{
                                const action=actions.find(a=>a.id===t.actionId);
                                if(filters.search&&!t.title.toLowerCase().includes(filters.search.toLowerCase()))return false;
                                if(filters.status.length>0&&!filters.status.includes(t.status))return false;
                                if(filters.priority.length>0&&!filters.priority.includes(t.priority))return false;
                                if(filters.category.length>0&&action&&!filters.category.includes(action.categoryId))return false;
                                if(filters.channel.length>0){const taskChannels=t.channels||action?.tags||[];if(!filters.channel.some(c=>taskChannels.includes(c)))return false;}
                                return true;
                            }).length} t√¢ches trouv√©es</span>
                            <button onClick={()=>setFilters({search:'',status:[],category:[],priority:[],channel:[]})} className="text-xs text-secondary hover:underline">Effacer filtres</button>
                        </div>
                    )}
                    {currentView==='kanban'&&<KanbanView categories={categories} actions={actions} tasks={tasks} onOpenTask={setSelectedTask} onOpenAction={setSelectedAction} onUpdateTask={handleUpdateTask} onUpdateAction={handleUpdateAction} onAddTask={handleAddNewTask} onAddAction={handleAddAction} filters={filters} setFilters={setFilters}/>}
                    {currentView==='timeline'&&<TimelineView categories={categories} actions={actions} tasks={tasks} onOpenTask={setSelectedTask} onOpenAction={setSelectedAction} onUpdateTask={handleUpdateTask} filters={filters} setFilters={setFilters}/>}
                    {currentView==='dashboard'&&<DashboardView categories={categories} actions={actions} tasks={tasks}/>}
                </main>
                {selectedTask&&<TaskDetailModal categories={categories} task={selectedTask} action={actions.find(a=>a.id===selectedTask.actionId)} actions={actions} onClose={()=>setSelectedTask(null)} onUpdate={handleUpdateTask} onDelete={handleDeleteTask} onBackToAction={selectedAction?()=>{setSelectedTask(null);setSelectedAction(actions.find(a=>a.id===selectedTask.actionId));}:null}/>}
                {selectedAction&&!selectedTask&&<ActionDetailModal categories={categories} action={selectedAction} tasks={tasks} onClose={()=>setSelectedAction(null)} onUpdateAction={handleUpdateAction} onUpdateTask={handleUpdateTask} onOpenTask={t=>{setSelectedTask(t);}} onAddTask={handleAddTask} onDeleteAction={handleDeleteAction}/>}
                {/* GitHubSettingsModal supprim√© - Token int√©gr√© directement dans GITHUB_CONFIG */}
                {showCategoriesModal&&<CategoriesManagementModal categories={categories} onClose={()=>setShowCategoriesModal(false)} onUpdate={handleUpdateCategory} onAdd={handleAddCategory} onDelete={handleDeleteCategory} onReorder={handleReorderCategories} darkMode={darkMode}/>}
                {showNewActionModal&&<NewActionModal categories={categories} onClose={()=>setShowNewActionModal(false)} onAdd={handleAddAction} darkMode={darkMode}/>}
                {showNewTaskModal&&<NewTaskModal actions={actions} categories={categories} onClose={()=>setShowNewTaskModal(false)} onAdd={handleAddNewTask} onCreateAction={()=>{setShowNewTaskModal(false);setShowNewActionModal(true);}} darkMode={darkMode}/>}
                {notification&&<div className="fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg bg-primary text-white animate-slide-in">{notification}</div>}
            </div>
        </AppContext.Provider>
    );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
