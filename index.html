<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketing Project Tracker V3.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root{--primary:#6366f1;--secondary:#6366f1;--green:#22c55e;--red:#ef4444;--yellow:#f59e0b;--bg-page:#fafafa;--bg-primary:#ffffff;--bg-secondary:#f4f4f5;--bg-tertiary:#e8eaed;--text-primary:#18181b;--text-secondary:#52525b;--text-muted:#a1a1aa;--accent:#6366f1;--accent-light:#eef2ff;--accent-hover:#4f46e5;--success:#22c55e;--success-light:#dcfce7;--warning:#f59e0b;--warning-light:#fef3c7;--error:#ef4444;--error-light:#fee2e2;--border:#e4e4e7;--border-light:#f0f0f1;--border-strong:#d4d4d8;--shadow-sm:0 1px 2px rgba(0,0,0,0.04);--shadow-md:0 4px 12px rgba(0,0,0,0.06);--shadow-lg:0 12px 40px rgba(0,0,0,0.1);--radius-sm:6px;--radius-md:10px;--radius-lg:14px;--transition:0.2s cubic-bezier(0.4,0,0.2,1);--font-sans:'DM Sans',-apple-system,BlinkMacSystemFont,sans-serif;--font-mono:'JetBrains Mono',monospace;--space-1:4px;--space-2:8px;--space-3:12px;--space-4:16px;--space-5:20px;--space-6:24px;--header-height:56px;--sidebar-width:220px;--kanban-column-width:280px}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:var(--font-sans);background:var(--bg-page);color:var(--text-primary);line-height:1.5;font-size:14px;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
        ::-webkit-scrollbar{width:6px;height:6px}
        ::-webkit-scrollbar-thumb{background:#888;border-radius:3px}
        @keyframes slideIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
        @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        .animate-slide-in{animation:slideIn .3s ease-out}
        .animate-slide-up{animation:slideUp .3s ease-out}
        .card-hover{transition:all .2s ease}
        .card-hover:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,.15)}
        .dragging{opacity:0.6!important;cursor:grabbing!important;transform:rotate(3deg) scale(1.05)!important;box-shadow:0 8px 30px rgba(0,0,0,.3)!important;z-index:1000!important}
        .touch-dragging{opacity:0.7;transform:scale(1.02);z-index:1000}
        [draggable=true]{cursor:grab}
        [draggable=true]:active{cursor:grabbing}
        @media(hover:none){.card-hover:active{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,.15)}}
        .kanban-column{min-height:200px;max-height:calc(100vh - 250px);overflow-y:auto}
        .modal-backdrop{backdrop-filter:blur(8px)}
        .line-clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
        .drag-over{border:3px dashed var(--accent)!important;background:rgba(99,102,241,.15)!important;transition:all .2s;box-shadow:inset 0 0 30px rgba(99,102,241,.2)!important;animation:pulse-border .8s ease-in-out infinite;position:relative}
        .drag-over::before{content:'';position:absolute;inset:0;border:2px solid rgba(99,102,241,.4);border-radius:4px;pointer-events:none}
        @keyframes pulse-border{0%,100%{border-color:rgba(99,102,241,.9);box-shadow:inset 0 0 30px rgba(99,102,241,.3)}50%{border-color:rgba(99,102,241,.5);box-shadow:inset 0 0 20px rgba(99,102,241,.15)}}
        .drop-indicator-before{border-top:4px solid var(--accent)!important;box-shadow:0 -2px 8px rgba(99,102,241,0.4)!important}
        .drop-indicator-after{border-bottom:4px solid var(--accent)!important;box-shadow:0 2px 8px rgba(99,102,241,0.4)!important}
        .timeline-bar{position:absolute;cursor:grab;transition:opacity .2s,transform .1s;user-select:none;pointer-events:auto;padding:0 8px}
        .timeline-bar.dragging{opacity:0.15!important;cursor:grabbing!important;z-index:1!important;transform:none!important;box-shadow:none!important}
        .timeline-bar:hover{cursor:grab;box-shadow:0 4px 12px rgba(0,0,0,0.2)}
        .timeline-bar:active{cursor:grabbing}
        .timeline-bar:hover .resize-handle{pointer-events:auto;opacity:1}
        .timeline-bar .resize-handle{pointer-events:auto}
        .timeline-bar .resize-handle:hover{cursor:col-resize!important}
        .timeline-bar .resize-handle:active{cursor:col-resize!important}
        body.resizing{cursor:col-resize!important;user-select:none}
        body.resizing *{cursor:col-resize!important}
        .resize-handle{position:absolute;top:0;bottom:0;width:8px;opacity:0;transition:opacity 0.2s;z-index:30;cursor:col-resize!important;display:flex;align-items:center;justify-content:center}
        .timeline-bar:hover .resize-handle{opacity:1}
        .resize-handle:hover{opacity:1!important;cursor:col-resize!important}
        .resize-handle::after{content:'';width:3px;height:16px;background:rgba(255,255,255,0.9);border-radius:2px;box-shadow:0 0 4px rgba(0,0,0,0.3)}
        .resize-handle-left{left:0}
        .resize-handle-right{right:0}
        .drag-ghost{position:fixed;pointer-events:none;z-index:10000;opacity:0.85;box-shadow:0 4px 12px rgba(0,0,0,0.3);border-radius:5px;padding:0 8px;color:white;font-size:10px;font-weight:500;height:26px;display:flex;align-items:center}
        .drag-preview-line{position:absolute;height:26px;opacity:0.55;top:8px;border-radius:5px;z-index:15;pointer-events:none;transition:left 0.08s ease-out,width 0.08s ease-out}
        @keyframes pulse-glow{0%,100%{opacity:0.9;box-shadow:0 0 12px rgba(99,102,241,0.6)}50%{opacity:1;box-shadow:0 0 20px rgba(99,102,241,0.8)}}
        .action-row-drag-over{background:rgba(99,102,241,0.04)!important;position:relative}
        .drop-zone-indicator{position:absolute;top:0;bottom:0;width:4px;background:linear-gradient(180deg,var(--accent),var(--success));border-radius:2px;box-shadow:0 0 12px rgba(99,102,241,0.7),0 0 24px rgba(99,102,241,0.3);z-index:25;pointer-events:none;animation:pulse-drop 0.8s ease-in-out infinite}
        .drop-zone-indicator::before{content:'';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:12px;height:12px;background:var(--accent);border-radius:50%;box-shadow:0 0 8px rgba(99,102,241,0.7)}
        @keyframes pulse-drop{0%,100%{opacity:1;transform:scaleY(1)}50%{opacity:0.8;transform:scaleY(0.98)}}
        @media(max-width:768px){
            .kanban-column{min-width:280px}
            .resize-handle{width:30px!important;opacity:0.7!important}
            .timeline-bar{min-height:32px;padding:0 12px!important}
        }
        @media(hover:none)and(pointer:coarse){
            .resize-handle{opacity:0.8!important;width:32px!important;background:rgba(255,255,255,0.3)!important}
            .resize-handle::before{width:4px!important;height:80%!important}
            [draggable=true]{cursor:default}
            .card-hover{transition:transform 0.1s}
            .card-hover:active{transform:scale(0.98)}
            .timeline-bar{padding:0 14px!important}
        }
        /* ===== V11 DESIGN SYSTEM ===== */
        .v11-header{background:var(--bg-primary);border-bottom:1px solid var(--border);padding:0 var(--space-6);position:sticky;top:0;z-index:100;height:var(--header-height)}
        .v11-header-inner{max-width:1600px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;height:100%;gap:var(--space-4)}
        .v11-logo{width:32px;height:32px;background:linear-gradient(135deg,var(--accent),#8b5cf6);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:13px}
        .v11-view-tabs{display:flex;background:var(--bg-secondary);padding:3px;border-radius:var(--radius-md);gap:2px}
        .v11-view-tab{padding:6px 14px;border-radius:var(--radius-sm);font-size:12px;font-weight:500;color:var(--text-secondary);cursor:pointer;transition:var(--transition);display:flex;align-items:center;gap:6px;border:none;background:transparent}
        .v11-view-tab:hover{color:var(--text-primary)}
        .v11-view-tab.active{background:var(--bg-primary);color:var(--text-primary);box-shadow:var(--shadow-sm)}
        .v11-icon-btn{width:34px;height:34px;border-radius:var(--radius-sm);border:none;background:transparent;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text-secondary);transition:var(--transition)}
        .v11-icon-btn:hover{background:var(--bg-secondary);color:var(--text-primary)}
        .v11-btn-primary{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;border:none;border-radius:var(--radius-md);background:var(--accent);color:white;font-size:12px;font-weight:600;font-family:inherit;cursor:pointer;transition:var(--transition)}
        .v11-btn-primary:hover{background:var(--accent-hover)}
        .v11-btn-primary svg{width:13px;height:13px}
        .v11-btn-primary .chevron{margin-left:2px;transition:var(--transition)}
        .v11-btn-primary.open .chevron{transform:rotate(180deg)}
        .v11-btn-secondary{display:inline-flex;align-items:center;gap:6px;padding:7px 12px;border:1px solid var(--border);border-radius:var(--radius-md);background:var(--bg-primary);color:var(--text-secondary);font-size:12px;font-weight:500;font-family:inherit;cursor:pointer;transition:var(--transition)}
        .v11-btn-secondary:hover{border-color:var(--border-strong);background:var(--bg-secondary)}
        .v11-btn-secondary svg{width:13px;height:13px}
        /* Toolbar */
        .toolbar{display:flex;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap}
        .filter-btn{display:flex;align-items:center;gap:6px;padding:7px 12px;border:1px solid var(--border);border-radius:var(--radius-md);background:var(--bg-primary);font-size:12px;font-weight:500;cursor:pointer;transition:var(--transition);font-family:inherit;color:var(--text-secondary)}
        .filter-btn:hover{border-color:var(--border-strong)}
        .filter-btn.active{background:var(--accent);color:white;border-color:var(--accent)}
        .filter-btn svg{width:13px;height:13px}
        .filter-count{background:var(--accent-light);color:var(--accent);font-size:10px;font-weight:600;padding:2px 6px;border-radius:10px}
        .filter-btn.active .filter-count{background:rgba(255,255,255,0.2);color:white}
        .stats-pills{display:flex;gap:16px;font-size:12px;color:var(--text-muted)}
        .stat-pill strong{color:var(--text-primary);font-weight:600}
        .toolbar-spacer{flex:1}
        /* Dropdown */
        .new-btn-container{position:relative}
        .dropdown-menu{position:absolute;top:calc(100% + 6px);right:0;background:var(--bg-primary);border:1px solid var(--border);border-radius:var(--radius-md);box-shadow:var(--shadow-lg);min-width:260px;opacity:0;visibility:hidden;transform:translateY(-8px);transition:var(--transition);z-index:50;overflow:hidden}
        .dropdown-menu.open{opacity:1;visibility:visible;transform:translateY(0)}
        .dropdown-item{display:flex;align-items:center;gap:10px;padding:10px 12px;font-size:12px;color:var(--text-primary);cursor:pointer;transition:var(--transition);border:none;background:transparent;width:100%;text-align:left;font-family:inherit}
        .dropdown-item:hover{background:var(--bg-secondary)}
        .dropdown-item.default{background:var(--accent-light)}
        .dropdown-item.default:hover{background:#ddd6fe}
        .dropdown-item-icon{width:28px;height:28px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center}
        .dropdown-item-icon svg{width:14px;height:14px}
        .dropdown-item-icon.task{background:#dbeafe;color:#2563eb}
        .dropdown-item-icon.action{background:#fef3c7;color:#d97706}
        .dropdown-item-icon.category{background:#f3e8ff;color:#7c3aed}
        .dropdown-item-content{flex:1}
        .dropdown-item-title{font-weight:500}
        .dropdown-item-desc{font-size:10px;color:var(--text-muted)}
        .dropdown-item-shortcut{font-size:9px;font-family:'JetBrains Mono',monospace;color:var(--text-muted);background:var(--bg-secondary);padding:2px 6px;border-radius:4px}
        .dropdown-divider{height:1px;background:var(--border);margin:4px 0}
        /* Active Filters */
        .active-filters{display:flex;align-items:center;gap:8px;margin-bottom:16px;flex-wrap:wrap}
        .active-filters-label{font-size:11px;color:var(--text-muted);font-weight:500;text-transform:uppercase;letter-spacing:0.3px}
        .filter-chip{display:flex;align-items:center;gap:5px;padding:4px 6px 4px 8px;background:var(--accent-light);color:var(--accent);border-radius:100px;font-size:11px;font-weight:500}
        .filter-chip button{width:16px;height:16px;border-radius:50%;border:none;background:rgba(99,102,241,0.15);color:var(--accent);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:10px;transition:var(--transition)}
        .filter-chip button:hover{background:var(--accent);color:white}
        .clear-filters{font-size:11px;color:var(--text-muted);cursor:pointer;margin-left:4px}
        .clear-filters:hover{color:var(--text-secondary);text-decoration:underline}
        /* Filter Sidebar */
        .filter-sidebar{position:fixed;right:0;top:56px;width:280px;height:calc(100vh - 56px);background:var(--bg-primary);border-left:1px solid var(--border);transform:translateX(100%);transition:var(--transition);z-index:50;overflow-y:auto;display:flex;flex-direction:column}
        .filter-sidebar.open{transform:translateX(0)}
        .sidebar-header{padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--bg-primary);z-index:1}
        .sidebar-title{font-weight:600;font-size:14px}
        .sidebar-close{width:28px;height:28px;border-radius:var(--radius-sm);border:none;background:var(--bg-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text-secondary);font-size:12px;transition:var(--transition)}
        .sidebar-close:hover{background:var(--bg-tertiary)}
        .sidebar-close svg{width:12px;height:12px}
        .filter-section{padding:16px;border-bottom:1px solid var(--border-light)}
        .filter-section-title{font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-secondary);margin-bottom:10px}
        .filter-options{display:flex;flex-wrap:wrap;gap:6px}
        .filter-option{padding:6px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:11px;cursor:pointer;transition:var(--transition);background:var(--bg-primary);color:var(--text-secondary);font-family:inherit}
        .filter-option:hover{border-color:var(--accent);color:var(--accent)}
        .filter-option.selected{background:var(--accent);color:white;border-color:var(--accent)}
        .sidebar-footer{padding:16px;display:flex;gap:8px;position:sticky;bottom:0;background:var(--bg-primary);border-top:1px solid var(--border);margin-top:auto}
        .sidebar-footer button{flex:1;padding:10px;font-size:12px;font-family:inherit;border-radius:var(--radius-sm);cursor:pointer;transition:var(--transition)}
        /* Kanban */
        .kanban-wrapper{background:var(--bg-primary);border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden}
        .kanban-toolbar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--bg-secondary);border-bottom:1px solid var(--border)}
        .kanban-toolbar-left{display:flex;align-items:center;gap:10px}
        .kanban-toolbar-right{display:flex;align-items:center;gap:8px}
        .view-btn-group{display:flex;background:var(--bg-primary);padding:3px;border-radius:var(--radius-sm);gap:2px;box-shadow:var(--shadow-sm)}
        .view-btn{padding:6px 12px;border:none;border-radius:4px;background:transparent;font-size:11px;font-weight:500;cursor:pointer;transition:var(--transition);color:var(--text-secondary);font-family:inherit}
        .view-btn:hover{color:var(--text-primary);background:var(--bg-secondary)}
        .view-btn.active{background:var(--accent);color:white}
        .toolbar-label{font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.3px}
        .toolbar-select{padding:6px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:11px;font-family:inherit;background:var(--bg-primary);color:var(--text-secondary);cursor:pointer}
        .quarter-nav-group{display:flex;gap:4px;margin-left:16px;padding-left:16px;border-left:1px solid var(--border)}
        .quarter-btn{padding:5px 8px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--bg-primary);font-size:10px;font-weight:500;cursor:pointer;transition:var(--transition);color:var(--text-muted);font-family:inherit}
        .quarter-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-light)}
        .kanban-board{display:flex;gap:16px;padding:16px;overflow-x:auto;overflow-y:auto;background:var(--bg-page);max-height:calc(100vh - 200px)}
        .kanban-column{min-width:280px;max-width:280px;background:var(--bg-secondary);border-radius:var(--radius-lg);padding:12px;flex-shrink:0;display:flex;flex-direction:column}
        .column-header{display:flex;align-items:center;justify-content:space-between;padding:4px 4px 12px}
        .column-title{display:flex;align-items:center;gap:8px}
        .column-icon{width:20px;height:20px;border-radius:5px;display:flex;align-items:center;justify-content:center}
        .column-icon svg{width:12px;height:12px}
        .column-icon.todo{background:var(--bg-primary);border:1px solid var(--border);color:var(--text-muted)}
        .column-icon.in-progress{background:#dbeafe;color:#2563eb}
        .column-icon.creating{background:#fef3c7;color:#d97706}
        .column-icon.review{background:#fef3c7;color:#d97706}
        .column-icon.done{background:#dcfce7;color:#16a34a}
        .column-icon.inprogress{background:#dbeafe;color:#2563eb}
        .column-icon.completed{background:#dcfce7;color:#16a34a}
        .column-name{font-weight:600;font-size:13px}
        .column-count{color:var(--text-muted);font-size:12px;font-weight:500}
        .column-menu{width:24px;height:24px;border-radius:var(--radius-sm);border:none;background:transparent;cursor:pointer;color:var(--text-muted);display:flex;align-items:center;justify-content:center;font-size:14px}
        .column-menu:hover{background:var(--bg-tertiary)}
        .column-menu svg{width:14px;height:14px}
        .kanban-cards{display:flex;flex-direction:column;gap:8px;flex:1}
        .column-empty{flex:1;display:flex;align-items:center;justify-content:center;padding:24px 16px;color:var(--text-muted);font-size:12px;text-align:center;border:1px dashed var(--border);border-radius:var(--radius-md);background:transparent}
        /* Task Cards */
        .kanban-card{background:var(--bg-primary);border-radius:var(--radius-md);padding:12px;cursor:pointer;transition:var(--transition);border:1px solid var(--border-light)}
        .kanban-card:hover{box-shadow:var(--shadow-md);transform:translateY(-1px);border-color:var(--border)}
        .kanban-card.completed{opacity:0.7;background:var(--bg-primary);border:1px solid var(--border)}
        .kanban-card[draggable=true]{cursor:grab}
        .kanban-card[draggable=true]:active{cursor:grabbing}
        .card-header{display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:8px}
        .card-title{font-weight:600;font-size:13px;line-height:1.4;flex:1;color:var(--text-primary)}
        .card-priority{width:8px;height:8px;border-radius:50%;flex-shrink:0;margin-top:4px}
        .card-priority.high{background:var(--error)}
        .card-priority.medium{background:var(--warning)}
        .card-priority.low{background:var(--success)}
        .card-tags{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:12px}
        .card-tag{padding:3px 8px;border-radius:4px;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.2px}
        .card-tag.social{background:#dbeafe;color:#1d4ed8}
        .card-tag.gads{background:#fef3c7;color:#b45309}
        .card-tag.lads{background:#e0e7ff;color:#4338ca}
        .card-tag.events{background:#fce7f3;color:#be185d}
        .card-tag.seo{background:#dcfce7;color:#166534}
        .card-tag.press{background:#f3e8ff;color:#7c3aed}
        .card-tag.email{background:#fef3c7;color:#b45309}
        .card-tag.web{background:#e0e7ff;color:#4338ca}
        .card-tag.video{background:#fee2e2;color:#dc2626}
        .card-tag.lp{background:#ccfbf1;color:#0d9488}
        .card-tag.ia{background:#f3e8ff;color:#7c3aed}
        .card-tag.auto{background:#ffedd5;color:#ea580c}
        .card-tag.other{background:#f4f4f5;color:#52525b}
        .card-footer{display:flex;align-items:center;justify-content:space-between;padding-top:10px;border-top:1px solid var(--border-light)}
        .card-date{font-size:11px;color:var(--text-muted)}
        .card-date.overdue{color:var(--error);font-weight:600}
        .card-date.soon{color:var(--warning);font-weight:600}
        .card-budget{font-size:12px;font-weight:700;color:var(--accent);font-family:'JetBrains Mono',monospace}
        /* Action Cards */
        .action-card{background:var(--bg-primary);border-radius:var(--radius-md);padding:12px;cursor:pointer;transition:var(--transition);border:1px solid var(--border)}
        .action-card:hover{border-color:var(--accent);box-shadow:var(--shadow-md);transform:translateY(-1px)}
        .action-card[draggable=true]{cursor:grab}
        .action-card .card-title{font-size:13px;font-weight:700}
        .action-card .card-tags{margin-bottom:12px}
        .action-progress-section{margin-bottom:10px}
        .action-progress-bar{height:6px;background:var(--bg-secondary);border-radius:3px;overflow:hidden;margin-bottom:6px}
        .action-progress-fill{height:100%;border-radius:3px;transition:var(--transition)}
        .action-progress-fill.low{background:linear-gradient(90deg,#fca5a5,#ef4444)}
        .action-progress-fill.medium{background:linear-gradient(90deg,#fcd34d,#f59e0b)}
        .action-progress-fill.high{background:linear-gradient(90deg,#86efac,#22c55e)}
        .action-progress-label{display:flex;justify-content:space-between;font-size:11px}
        .action-task-count{color:var(--text-muted)}
        .action-task-count strong{color:var(--text-secondary)}
        .action-progress-percent{font-weight:700;color:var(--text-primary)}
        .add-card-btn{width:100%;padding:10px;border:none;border-radius:var(--radius-md);background:transparent;color:var(--text-muted);font-size:12px;cursor:pointer;transition:var(--transition);display:flex;align-items:center;justify-content:center;gap:4px;margin-top:4px;font-family:inherit}
        .add-card-btn:hover{color:var(--accent);background:var(--accent-light)}
        /* Timeline */
        .timeline-container{background:var(--bg-primary);border-radius:var(--radius-lg);border:1px solid var(--border);overflow:hidden;display:flex;flex-direction:column;max-height:calc(100vh - 160px)}
        .timeline-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);background:var(--bg-secondary)}
        .timeline-header-left{display:flex;align-items:center}
        .timeline-nav{display:flex;align-items:center;gap:8px}
        .timeline-nav-btn{width:28px;height:28px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg-primary);cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text-secondary);font-size:14px;transition:var(--transition);font-family:inherit}
        .timeline-nav-btn:hover{border-color:var(--border-strong)}
        .timeline-current{font-size:13px;font-weight:600;min-width:60px;text-align:center}
        .timeline-category-row{background:var(--bg-secondary);border-top:1px solid var(--border);border-bottom:1px solid var(--border);cursor:pointer;transition:var(--transition)}
        .timeline-category-row:hover{background:var(--bg-tertiary)}
        .timeline-category-sidebar{padding:10px 16px}
        .timeline-category-sidebar::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px}
        .timeline-category-name{font-size:12px;font-weight:700;color:var(--text-primary)}
        .timeline-category-count{font-size:11px;color:var(--text-muted)}
        .timeline-action-sidebar{padding:8px 12px 8px 16px;cursor:pointer;transition:var(--transition)}
        .timeline-action-sidebar:hover .timeline-action-name{color:var(--accent)}
        .timeline-action-name{font-size:12px;font-weight:500;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .timeline-action-count{font-size:10px;color:var(--text-muted)}
        /* Dashboard Cards */
        .v11-card{background:var(--bg-primary);border:1px solid var(--border);border-radius:var(--radius-lg);box-shadow:var(--shadow-sm);transition:var(--transition)}
        .v11-card:hover{box-shadow:var(--shadow-md)}
        .v11-progress-bar{width:100%;background:var(--bg-secondary);border-radius:100px;overflow:hidden}
        .v11-progress-fill{height:100%;border-radius:100px;transition:width 0.3s ease}
        .v11-progress-fill.low{background:linear-gradient(90deg,#fca5a5,#ef4444)}
        .v11-progress-fill.medium{background:linear-gradient(90deg,#fcd34d,#f59e0b)}
        .v11-progress-fill.high{background:linear-gradient(90deg,#86efac,#22c55e)}
        /* Modals */
        .v11-modal-overlay{position:fixed;inset:0;z-index:50;display:flex;align-items:center;justify-content:center;padding:16px;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px)}
        .v11-modal{background:var(--bg-primary);border-radius:var(--radius-lg);box-shadow:var(--shadow-lg);width:100%;overflow:hidden}
        .v11-modal-header{padding:var(--space-4) var(--space-5);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
        .v11-modal-body{padding:var(--space-5);max-height:70vh;overflow-y:auto}
        .v11-modal-footer{padding:var(--space-4) var(--space-5);border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:var(--space-2)}
        .v11-input{width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:13px;font-family:inherit;background:var(--bg-primary);color:var(--text-primary);transition:var(--transition)}
        .v11-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-light)}
        .v11-select{padding:8px 12px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:13px;font-family:inherit;background:var(--bg-primary);color:var(--text-primary);cursor:pointer}
        .v11-label{display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px}
        *:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
        @media(max-width:1200px){.kanban-column{min-width:260px;max-width:260px}:root{--sidebar-width:180px}}
        @media(max-width:768px){.v11-view-tabs{display:none}.stats-pills{display:none}:root{--sidebar-width:150px}.timeline-cell{min-width:80px}}
        @media(max-width:480px){.filter-sidebar{width:100%}.v11-btn-secondary span{display:none}.kanban-board{gap:12px;padding:12px}.kanban-column{min-width:280px}}
        </style>
    <script>tailwind.config={darkMode:'class',theme:{extend:{colors:{primary:'#6366f1',secondary:'#6366f1','accent-green':'#22c55e','accent-red':'#ef4444','accent-yellow':'#f59e0b',accent:{DEFAULT:'#6366f1',light:'#eef2ff',hover:'#4f46e5',green:'#22c55e',red:'#ef4444',yellow:'#f59e0b'}},borderColor:{DEFAULT:'#e4e4e7'},fontFamily:{sans:['DM Sans','-apple-system','BlinkMacSystemFont','sans-serif'],mono:['JetBrains Mono','monospace']}}}}</script>
</head>
<body>
<div id="root">
    <div class="min-h-screen flex items-center justify-center" style="background:var(--bg-page)">
        <div class="text-center" style="color:var(--text-primary)">
            <div class="animate-spin w-12 h-12 border-4 border-t-transparent rounded-full mx-auto mb-4" style="border-color:var(--accent);border-top-color:transparent"></div>
            <p>Chargement de l'application...</p>
            <p class="text-xs mt-2" style="color:var(--text-muted)">Si ce message persiste, v√©rifiez la console (F12)</p>
        </div>
    </div>
</div>
<script type="text/babel">
console.log('üöÄ Script d√©marr√©');
console.log('React disponible:', typeof React !== 'undefined');
console.log('ReactDOM disponible:', typeof ReactDOM !== 'undefined');
const{useState,useEffect,useRef,createContext,useContext,useCallback,useMemo}=React;

// CONFIG
const CONFIG={
    MONTHS:['Jan','F√©v','Mar','Avr','Mai','Jun','Jul','Ao√ª','Sep','Oct','Nov','D√©c'],
    MONTHS_FULL:['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'],
    STATUSES:[
        {id:'todo',name:'√Ä faire',color:'#94a3b8',icon:'‚óã'},
        {id:'creating',name:'En cr√©ation',color:'#f59e0b',icon:'‚úé'},
        {id:'inprogress',name:'En cours',color:'#3b82f6',icon:'‚Üª'},
        {id:'review',name:'En revue',color:'#d97706',icon:'‚óé'},
        {id:'completed',name:'Termin√©',color:'#22c55e',icon:'‚úì'},
        {id:'paused',name:'En pause',color:'#ef4444',icon:'‚è∏'}
    ],
    CATEGORIES:[
        {id:'brand-awareness',name:'Brand Awareness',color:'#6366f1',gradient:'from-indigo-500 to-purple-600'},
        {id:'consideration',name:'Consideration / Engagement',color:'#f59e0b',gradient:'from-amber-400 to-orange-500'},
        {id:'conversion',name:'Conversion',color:'#22c55e',gradient:'from-green-400 to-emerald-600'}
    ],
    CHANNELS:[{id:'social',name:'Social Media',color:'#3b82f6'},{id:'gads',name:'Google Ads',color:'#ea4335'},{id:'lads',name:'LinkedIn Ads',color:'#0077b5'},{id:'email',name:'Email',color:'#f59e0b'},{id:'press',name:'Press',color:'#8b5cf6'},{id:'events',name:'Events',color:'#ec4899'},{id:'seo',name:'Article/SEO',color:'#10b981'},{id:'web',name:'Website',color:'#6366f1'},{id:'video',name:'Video',color:'#ef4444'},{id:'lp',name:'Landing Page',color:'#14b8a6'},{id:'ia',name:'IA',color:'#a855f7'},{id:'auto',name:'Automation',color:'#f97316'},{id:'other',name:'Other',color:'#6b7280'}],
    COUNTRIES:[
        {id:'france',name:'France',region:'Europe',color:'#3b82f6',flag:'üá´üá∑'},
        {id:'germany',name:'Germany',region:'Europe',color:'#ef4444',flag:'üá©üá™'},
        {id:'italy',name:'Italy',region:'Europe',color:'#10b981',flag:'üáÆüáπ'},
        {id:'netherlands',name:'Netherlands',region:'Europe',color:'#f97316',flag:'üá≥üá±'},
        {id:'portugal',name:'Portugal',region:'Europe',color:'#14b8a6',flag:'üáµüáπ'},
        {id:'romania',name:'Romania',region:'Europe',color:'#f59e0b',flag:'üá∑üá¥'},
        {id:'spain',name:'Spain',region:'Europe',color:'#eab308',flag:'üá™üá∏'},
        {id:'switzerland',name:'Switzerland',region:'Europe',color:'#dc2626',flag:'üá®üá≠'},
        {id:'uk',name:'United Kingdom',region:'Europe',color:'#6366f1',flag:'üá¨üáß'},
        {id:'canada',name:'Canada',region:'America',color:'#dc2626',flag:'üá®üá¶'},
        {id:'mexico',name:'Mexico',region:'America',color:'#10b981',flag:'üá≤üáΩ'},
        {id:'usa',name:'United States',region:'America',color:'#3b82f6',flag:'üá∫üá∏'},
        {id:'india',name:'India',region:'Asia',color:'#f97316',flag:'üáÆüá≥'},
        {id:'southeast-asia',name:'Southeast Asia',region:'Asia',color:'#8b5cf6',flag:'üåè'},
        {id:'australia',name:'Australia',region:'Oceania',color:'#10b981',flag:'üá¶üá∫'}
    ],
    PRIORITIES:[
        {id:'high',name:'Haute',color:'#ef4444',icon:'‚¨§'},
        {id:'medium',name:'Moyenne',color:'#f59e0b',icon:'‚¨§'},
        {id:'low',name:'Basse',color:'#22c55e',icon:'‚¨§'}
    ]
};

// DEMO DATA - Synchronized with data.json
const ACTIONS=[
    {id:'a1',name:'Global MP Brand (Social Media)',categoryId:'brand-awareness',budget:0,priority:'high',tags:['social']},
    {id:'a2',name:'Employeur Brand',categoryId:'brand-awareness',budget:0,priority:'medium',tags:['social','video']},
    {id:'a3',name:'Google Ads - Brand',categoryId:'brand-awareness',budget:12000,priority:'high',tags:['gads']},
    {id:'a4',name:'LinkedIn Ads - Brand',categoryId:'brand-awareness',budget:18000,priority:'high',tags:['lads']},
    {id:'a5',name:'Press Relations',categoryId:'brand-awareness',budget:30000,priority:'medium',tags:['press']},
    {id:'a6',name:'On-Time-Delivery Campaign',categoryId:'consideration',budget:0,priority:'high',tags:['seo','social']},
    {id:'a7',name:'Time-To-Market Campaign',categoryId:'consideration',budget:0,priority:'medium',tags:['seo']},
    {id:'a8',name:'SEO Optimizations',categoryId:'consideration',budget:5000,priority:'medium',tags:['seo','web']},
    {id:'a9',name:'Google Ads - Lead Gen',categoryId:'conversion',budget:12000,priority:'high',tags:['gads','lp']},
    {id:'a10',name:'LinkedIn Ads - Lead Gen',categoryId:'conversion',budget:9000,priority:'high',tags:['lads','lp']},
    {id:'a11',name:'Business Events',categoryId:'conversion',budget:10000,priority:'high',tags:['events']},
    {id:'a12',name:'Event Participation',categoryId:'conversion',budget:5000,priority:'medium',tags:['events']}
];

const TASKS=[
    {id:'t1',actionId:'a1',month:0,startDate:'2026-01-01',title:'V≈ìux nouvel an',description:'Post LinkedIn + Instagram',status:'completed',priority:'high',dueDate:'2026-01-15',checklist:[{id:'c1',text:'Cr√©er visuel',done:true},{id:'c2',text:'R√©diger texte',done:true}],comments:[{id:'cm1',author:'Fabien',text:'Bon engagement!',date:'2026-01-16'}],attachments:[],channels:['social']},
    {id:'t2',actionId:'a1',month:9,startDate:'2026-10-01',title:'Pink October',description:'Campagne Octobre Rose',status:'todo',priority:'medium',dueDate:'2026-10-01',checklist:[],comments:[],attachments:[],channels:['social']},
    {id:'t3',actionId:'a1',month:10,startDate:'2026-11-01',title:'Movember',description:'Campagne Movember',status:'todo',priority:'medium',dueDate:'2026-11-01',checklist:[],comments:[],attachments:[],channels:['social']},
    {id:'t4',actionId:'a1',month:11,startDate:'2026-12-01',title:'V≈ìux + Video Recap',description:'Vid√©o r√©cap ann√©e',status:'todo',priority:'high',dueDate:'2026-12-20',checklist:[],comments:[],attachments:[],channels:['social']},
    {id:'t5',actionId:'a2',month:1,startDate:'2026-02-01',title:'Content F√©vrier',description:'Contenu marque employeur',status:'inprogress',priority:'medium',dueDate:'2026-02-28',checklist:[{id:'c3',text:'Brief',done:true},{id:'c4',text:'Production',done:false}],comments:[],attachments:[],channels:['social','video']},
    {id:'t6',actionId:'a2',month:3,startDate:'2026-04-01',title:'Content Avril',description:'Contenu marque employeur',status:'todo',priority:'medium',dueDate:'2026-04-30',checklist:[],comments:[],attachments:[],channels:['social','video']},
    {id:'t7',actionId:'a3',month:1,startDate:'2026-02-01',title:'Google Ads F√©v',description:'Budget 2000‚Ç¨',status:'inprogress',priority:'high',dueDate:'2026-02-28',budget:2000,checklist:[{id:'c5',text:'Setup',done:true}],comments:[],attachments:[],channels:['gads']},
    {id:'t8',actionId:'a3',month:2,startDate:'2026-03-01',title:'Google Ads Mar',description:'Budget 2000‚Ç¨',status:'creating',priority:'high',dueDate:'2026-03-31',budget:2000,checklist:[],comments:[],attachments:[],channels:['gads']},
    {id:'t9',actionId:'a3',month:3,startDate:'2026-04-01',title:'Google Ads Avr',description:'Budget 2000‚Ç¨',status:'todo',priority:'high',dueDate:'2026-04-30',budget:2000,checklist:[],comments:[],attachments:[],channels:['gads']},
    {id:'t10',actionId:'a4',month:1,startDate:'2026-02-01',title:'LinkedIn Ads F√©v',description:'Budget 3000‚Ç¨',status:'inprogress',priority:'high',dueDate:'2026-02-28',budget:3000,checklist:[],comments:[],attachments:[],channels:['lads']},
    {id:'t11',actionId:'a4',month:2,startDate:'2026-03-01',title:'LinkedIn Ads Mar',description:'Budget 3000‚Ç¨',status:'creating',priority:'high',dueDate:'2026-03-31',budget:3000,checklist:[],comments:[],attachments:[],channels:['lads']},
    {id:'t12',actionId:'a5',month:2,startDate:'2026-03-01',title:'PR Mars',description:'Relations presse Q1',status:'todo',priority:'medium',dueDate:'2026-03-31',budget:10000,checklist:[],comments:[],attachments:[],channels:['press']},
    {id:'t13',actionId:'a6',month:2,startDate:'2026-03-01',title:'OTD Content Mars',description:'Contenu OTD',status:'creating',priority:'high',dueDate:'2026-03-15',checklist:[{id:'c6',text:'Research',done:true},{id:'c7',text:'Writing',done:false}],comments:[],attachments:[],channels:['seo','social']},
    {id:'t14',actionId:'a6',month:3,startDate:'2026-04-01',title:'OTD Content Avril',description:'Contenu OTD',status:'todo',priority:'high',dueDate:'2026-04-15',checklist:[],comments:[],attachments:[],channels:['seo','social']},
    {id:'t15',actionId:'a7',month:8,startDate:'2026-09-01',title:'TTM Content Sep',description:'Contenu TTM',status:'todo',priority:'medium',dueDate:'2026-09-15',checklist:[],comments:[],attachments:[],channels:['seo']},
    {id:'t16',actionId:'a9',month:1,startDate:'2026-02-01',title:'Google Lead Gen F√©v',description:'Budget 2000‚Ç¨',status:'inprogress',priority:'high',dueDate:'2026-02-28',budget:2000,checklist:[],comments:[],attachments:[],channels:['gads','lp']},
    {id:'t17',actionId:'a10',month:2,startDate:'2026-03-01',title:'LinkedIn Lead Gen Mar',description:'Budget 3000‚Ç¨',status:'todo',priority:'high',dueDate:'2026-03-31',budget:3000,checklist:[],comments:[],attachments:[],channels:['lads','lp']},
    {id:'t18',actionId:'a11',month:3,startDate:'2026-04-01',title:'Event In-House Avril',description:'√âv√©nement interne',status:'todo',priority:'high',dueDate:'2026-04-15',budget:10000,checklist:[{id:'c8',text:'Lieu',done:false},{id:'c9',text:'Invitations',done:false}],comments:[],attachments:[],channels:['events']},
    {id:'t19',actionId:'a12',month:3,startDate:'2026-04-01',title:'Salon Avril',description:'Participation salon',status:'todo',priority:'medium',dueDate:'2026-04-10',checklist:[],comments:[],attachments:[],channels:['events']}
];

// Touch Drag Support
const useTouchDrag=(onDragEnd)=>{
    const[isDragging,setIsDragging]=useState(false);
    const dragDataRef=useRef(null);
    const startPosRef=useRef({x:0,y:0});
    const ghostRef=useRef(null);
    
    const handleTouchStart=(e,data)=>{
        const touch=e.touches[0];
        startPosRef.current={x:touch.clientX,y:touch.clientY};
        dragDataRef.current=data;
        
        // Cr√©er un ghost element apr√®s un d√©lai (pour distinguer du scroll)
        setTimeout(()=>{
            if(dragDataRef.current){
                setIsDragging(true);
                const ghost=e.target.cloneNode(true);
                ghost.style.cssText='position:fixed;pointer-events:none;opacity:0.8;z-index:9999;width:'+e.target.offsetWidth+'px;transform:translate(-50%,-50%);';
                ghost.style.left=touch.clientX+'px';
                ghost.style.top=touch.clientY+'px';
                document.body.appendChild(ghost);
                ghostRef.current=ghost;
            }
        },200);
    };
    
    const handleTouchMove=(e)=>{
        if(!isDragging||!ghostRef.current)return;
        const touch=e.touches[0];
        ghostRef.current.style.left=touch.clientX+'px';
        ghostRef.current.style.top=touch.clientY+'px';
    };
    
    const handleTouchEnd=(e)=>{
        if(ghostRef.current){
            ghostRef.current.remove();
            ghostRef.current=null;
        }
        if(isDragging&&dragDataRef.current){
            const touch=e.changedTouches[0];
            const dropTarget=document.elementFromPoint(touch.clientX,touch.clientY);
            if(dropTarget){
                const dropZone=dropTarget.closest('[data-drop-month]');
                if(dropZone&&onDragEnd){
                    const month=parseInt(dropZone.dataset.dropMonth);
                    onDragEnd(dragDataRef.current,month);
                }
            }
        }
        setIsDragging(false);
        dragDataRef.current=null;
    };
    
    return{isDragging,handleTouchStart,handleTouchMove,handleTouchEnd};
};

const AppContext=createContext();
const useApp=()=>useContext(AppContext);

// ICONS
const Icon={
    Menu:()=><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16"/></svg>,
    Close:()=><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12"/></svg>,
    Sun:()=><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>,
    Moon:()=><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>,
    Kanban:()=><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1" strokeWidth={2}/><rect x="14" y="3" width="7" height="7" rx="1" strokeWidth={2}/><rect x="3" y="14" width="7" height="7" rx="1" strokeWidth={2}/><rect x="14" y="14" width="7" height="7" rx="1" strokeWidth={2}/></svg>,
    Timeline:()=><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16"/></svg>,
    Dashboard:()=><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>,
    Filter:()=><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg>,
    Plus:()=><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4"/></svg>,
    Trash:()=><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>,
    Refresh:()=><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>,
    Check:()=><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7"/></svg>,
    Comment:()=><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>,
    Calendar:()=><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>,
    Folder:()=><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>,
    List:()=><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>,
    TrendUp:()=><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>,
    Dollar:()=><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>,
    Alert:()=><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>,
    Hand:()=><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 11.5V14m0-2.5v-6a1.5 1.5 0 113 0m-3 6a1.5 1.5 0 00-3 0v2a7.5 7.5 0 0015 0v-5a1.5 1.5 0 00-3 0m-6-3V11m0-5.5v-1a1.5 1.5 0 013 0v1m0 0V11m0-5.5a1.5 1.5 0 013 0v3m0 0V11"/></svg>,
    External:()=><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>,
    Settings:()=><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>,
    Github:()=><svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>,
    Download:()=><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
};

// STATUS ICON COMPONENT ‚Äî matches Kanban column icons, used across all views
const StatusIcon=({statusId,size=16})=>{
    const iconSvgs={
        todo:<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width={size} height={size}><circle cx="12" cy="12" r="10" strokeWidth="2"/></svg>,
        creating:<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width={size} height={size}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>,
        inprogress:<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width={size} height={size}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>,
        review:<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width={size} height={size}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>,
        completed:<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width={size} height={size}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"/></svg>,
        paused:<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width={size} height={size}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
    };
    const colorMap={
        todo:{bg:'var(--bg-primary)',border:'1px solid var(--border)',color:'var(--text-muted)'},
        creating:{bg:'#fef3c7',border:'none',color:'#d97706'},
        inprogress:{bg:'#dbeafe',border:'none',color:'#2563eb'},
        review:{bg:'#fef3c7',border:'none',color:'#d97706'},
        completed:{bg:'#dcfce7',border:'none',color:'#16a34a'},
        paused:{bg:'#fee2e2',border:'none',color:'#ef4444'}
    };
    const c=colorMap[statusId]||{bg:'var(--bg-secondary)',border:'none',color:'var(--text-muted)'};
    return(<div style={{width:size+6,height:size+6,borderRadius:5,display:'inline-flex',alignItems:'center',justifyContent:'center',background:c.bg,border:c.border,color:c.color,flexShrink:0}}>{iconSvgs[statusId]}</div>);
};

// PRIORITY ICON COMPONENT ‚Äî flat V11 style (replaces 3D emoji circles)
const PriorityIcon=({priority,size=12})=>{
    const icons={
        high:<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width={size} height={size}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2.5" d="M5 15l7-7 7 7"/></svg>,
        medium:<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width={size} height={size}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2.5" d="M5 12h14"/></svg>,
        low:<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width={size} height={size}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2.5" d="M19 9l-7 7-7-7"/></svg>
    };
    const colors={
        high:{bg:'#fee2e2',color:'#dc2626'},
        medium:{bg:'#fef3c7',color:'#d97706'},
        low:{bg:'#dcfce7',color:'#16a34a'}
    };
    const c=colors[priority]||colors.medium;
    return(<div style={{width:size+6,height:size+6,borderRadius:4,display:'inline-flex',alignItems:'center',justifyContent:'center',background:c.bg,color:c.color,flexShrink:0}}>{icons[priority]}</div>);
};

// ICON SELECT ‚Äî custom dropdown with colored icons (replaces native <select> for status/priority)
const IconSelect=({value,options,onChange,renderOption,className,style})=>{
    const[open,setOpen]=useState(false);
    const ref=useRef(null);
    useEffect(()=>{
        const h=(e)=>{if(ref.current&&!ref.current.contains(e.target))setOpen(false);};
        document.addEventListener('mousedown',h);return()=>document.removeEventListener('mousedown',h);
    },[]);
    const selected=options.find(o=>o.id===value)||options[0];
    return(
        <div ref={ref} style={{position:'relative',...style}} className={className}>
            <div onClick={()=>setOpen(!open)} className="v11-select" style={{cursor:'pointer',display:'flex',alignItems:'center',gap:6,paddingRight:24}}>
                {renderOption(selected)}
                <span style={{position:'absolute',right:8,top:'50%',transform:'translateY(-50%)',fontSize:10,color:'var(--text-muted)'}}>‚ñæ</span>
            </div>
            {open&&(
                <div style={{position:'absolute',top:'100%',left:0,right:0,zIndex:50,background:'var(--bg-primary)',border:'1px solid var(--border)',borderRadius:8,boxShadow:'0 4px 12px rgba(0,0,0,0.15)',maxHeight:200,overflowY:'auto',marginTop:2}}>
                    {options.map(o=>(
                        <div key={o.id} onClick={()=>{onChange(o.id);setOpen(false);}} style={{padding:'6px 10px',cursor:'pointer',display:'flex',alignItems:'center',gap:6,background:o.id===value?'var(--bg-secondary)':'transparent'}}
                            onMouseEnter={e=>e.currentTarget.style.background='var(--bg-secondary)'}
                            onMouseLeave={e=>e.currentTarget.style.background=o.id===value?'var(--bg-secondary)':'transparent'}>
                            {renderOption(o)}
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
};
const StatusOption=({status})=>(<><StatusIcon statusId={status.id} size={12}/><span style={{fontSize:13}}>{status.name}</span></>);
const PriorityOption=({priority})=>(<><div style={{width:8,height:8,borderRadius:'50%',background:priority.color,flexShrink:0}}/><span style={{fontSize:13}}>{priority.name}</span></>);

// ‚ö†Ô∏è GITHUB SETTINGS MODAL - SUPPRIM√â
// Le token GitHub est maintenant int√©gr√© directement dans GITHUB_CONFIG (voir ligne ~1375-1381)
// Plus besoin de modal de configuration pour un usage multi-device transparent

// CATEGORIES MANAGEMENT MODAL
const CategoriesManagementModal=({categories,onClose,onUpdate,onAdd,onDelete,onReorder})=>{
    const[editingId,setEditingId]=useState(null);
    const[form,setForm]=useState({});
    const[isAdding,setIsAdding]=useState(false);
    const[newCategory,setNewCategory]=useState({name:'',color:'#6366f1',gradient:'from-indigo-500 to-purple-600'});
    const[draggedIndex,setDraggedIndex]=useState(null);
    const[touchStartY,setTouchStartY]=useState(null);
    const[touchCurrentY,setTouchCurrentY]=useState(null);

    const gradientPresets=[
        {name:'Bleu',gradient:'from-blue-500 to-indigo-700'},
        {name:'Vert',gradient:'from-emerald-400 to-cyan-500'},
        {name:'Orange',gradient:'from-yellow-400 to-orange-500'},
        {name:'Violet',gradient:'from-purple-500 to-pink-600'},
        {name:'Rouge',gradient:'from-red-500 to-pink-500'}
    ];

    const startEdit=(cat)=>{setEditingId(cat.id);setForm({...cat});};
    const cancelEdit=()=>{setEditingId(null);setForm({});};
    const saveEdit=()=>{onUpdate(editingId,form);cancelEdit();};
    const handleAdd=()=>{
        if(!newCategory.name.trim())return;
        onAdd({...newCategory,id:`cat${Date.now()}`});
        setNewCategory({name:'',color:'#6366f1',gradient:'from-indigo-500 to-purple-600'});
        setIsAdding(false);
    };

    // Mouse drag handlers
    const handleDragStart=(index)=>{
        setDraggedIndex(index);
    };

    const handleDragOver=(e,index)=>{
        e.preventDefault();
        if(draggedIndex===null||draggedIndex===index)return;
        const newCategories=[...categories];
        const draggedItem=newCategories[draggedIndex];
        newCategories.splice(draggedIndex,1);
        newCategories.splice(index,0,draggedItem);
        onReorder(newCategories);
        setDraggedIndex(index);
    };

    const handleDragEnd=()=>{
        setDraggedIndex(null);
    };

    // Touch handlers for mobile
    const handleTouchStart=(e,index)=>{
        if(editingId)return; // Don't allow drag while editing
        const touch=e.touches[0];
        setTouchStartY(touch.clientY);
        setTouchCurrentY(touch.clientY);
        setDraggedIndex(index);
    };

    const handleTouchMove=(e,index)=>{
        if(draggedIndex===null||editingId)return;
        const touch=e.touches[0];
        setTouchCurrentY(touch.clientY);

        // Calculate which item we're hovering over
        const element=document.elementFromPoint(touch.clientX,touch.clientY);
        if(!element)return;

        // Find the category item
        const categoryItem=element.closest('[data-category-index]');
        if(!categoryItem)return;

        const targetIndex=parseInt(categoryItem.getAttribute('data-category-index'));
        if(targetIndex!==draggedIndex&&targetIndex>=0&&targetIndex<categories.length){
            const newCategories=[...categories];
            const draggedItem=newCategories[draggedIndex];
            newCategories.splice(draggedIndex,1);
            newCategories.splice(targetIndex,0,draggedItem);
            onReorder(newCategories);
            setDraggedIndex(targetIndex);
        }
    };

    const handleTouchEnd=()=>{
        setDraggedIndex(null);
        setTouchStartY(null);
        setTouchCurrentY(null);
    };

    return(
        <div className="v11-modal-overlay" onClick={onClose}>
            <div className="v11-modal animate-slide-up" style={{maxWidth:672,maxHeight:'90vh',overflowY:'auto'}} onClick={e=>e.stopPropagation()}>
                <div style={{height:3,background:'var(--accent)',borderRadius:'var(--radius-lg) var(--radius-lg) 0 0'}}/>
                <div className="p-6">
                    <div className="flex items-center justify-between mb-6">
                        <h2 className="text-xl font-bold">üìÇ Gestion des Cat√©gories</h2>
                        <button onClick={onClose} className="v11-icon-btn"><Icon.Close/></button>
                    </div>
                    <div className="space-y-3 mb-4">
                        {categories.map((cat,index)=>(
                            <div key={cat.id} data-category-index={index} draggable={editingId!==cat.id} onDragStart={()=>handleDragStart(index)} onDragOver={(e)=>handleDragOver(e,index)} onDragEnd={handleDragEnd} onTouchStart={(e)=>handleTouchStart(e,index)} onTouchMove={(e)=>handleTouchMove(e,index)} onTouchEnd={handleTouchEnd} className={`p-4 rounded-lg ${draggedIndex===index?'opacity-50':''} ${editingId===cat.id?'':'cursor-move touch-none'}`} style={{border:'1px solid var(--border)',background:'var(--bg-secondary)'}}>
                                {editingId===cat.id?(
                                    <div className="space-y-3">
                                        <input type="text" value={form.name} onChange={e=>setForm({...form,name:e.target.value})} className="v11-input"/>
                                        <div><label className="v11-label">Gradient:</label><div className="flex gap-2">{gradientPresets.map(g=>(<button key={g.name} onClick={()=>setForm({...form,gradient:g.gradient})} className={`flex-1 h-8 rounded-lg bg-gradient-to-r ${g.gradient} ${form.gradient===g.gradient?'ring-2 ring-secondary':''}`}/>))}</div></div>
                                        <div className="flex gap-2"><button onClick={saveEdit} className="px-4 py-2 bg-primary text-white rounded-lg text-sm">Sauvegarder</button><button onClick={cancelEdit} className="v11-btn-secondary">Annuler</button></div>
                                    </div>
                                ):(
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center space-x-3"><div className="cursor-move" style={{color:'var(--text-muted)'}} title="Glisser pour r√©organiser">‚ãÆ‚ãÆ</div><div className={`w-12 h-8 rounded-lg bg-gradient-to-r ${cat.gradient}`}/><span className="font-medium">{cat.name}</span></div>
                                        <div className="flex gap-2"><button onClick={()=>startEdit(cat)} className="px-3 py-1 text-sm text-secondary hover:bg-secondary/10 rounded-lg">Modifier</button><button onClick={()=>onDelete(cat.id)} className="px-3 py-1 text-sm text-accent-red hover:bg-red-50 rounded-lg">Supprimer</button></div>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                    {isAdding?(
                        <div className="p-4 rounded-lg border-2 border-dashed space-y-3" style={{borderColor:'var(--border)'}}>
                            <input type="text" value={newCategory.name} onChange={e=>setNewCategory({...newCategory,name:e.target.value})} placeholder="Nom de la cat√©gorie" className="v11-input"/>
                            <div><label className="v11-label">Gradient:</label><div className="flex gap-2">{gradientPresets.map(g=>(<button key={g.name} onClick={()=>setNewCategory({...newCategory,gradient:g.gradient})} className={`flex-1 h-8 rounded-lg bg-gradient-to-r ${g.gradient} ${newCategory.gradient===g.gradient?'ring-2 ring-secondary':''}`}/>))}</div></div>
                            <div className="flex gap-2"><button onClick={handleAdd} className="px-4 py-2 bg-primary text-white rounded-lg text-sm">Ajouter</button><button onClick={()=>setIsAdding(false)} className="v11-btn-secondary">Annuler</button></div>
                        </div>
                    ):(
                        <button onClick={()=>setIsAdding(true)} className="w-full px-4 py-3 border-2 border-dashed rounded-lg hover:border-secondary hover:text-secondary flex items-center justify-center space-x-2" style={{borderColor:'var(--border)',color:'var(--text-muted)'}}><Icon.Plus/><span>Nouvelle Cat√©gorie</span></button>
                    )}
                </div>
            </div>
        </div>
    );
};

// NEW ACTION MODAL
const NewActionModal=({categories,onClose,onAdd})=>{
    const[form,setForm]=useState({name:'',categoryId:categories[0]?.id||'',budget:0,priority:'medium',tags:[]});
    const handleAdd=()=>{
        if(!form.name.trim()||!form.categoryId)return;
        onAdd({...form,id:`a${Date.now()}`});
        onClose();
    };
    return(
        <div className="v11-modal-overlay" onClick={onClose}>
            <div className="v11-modal animate-slide-up" style={{maxWidth:512}} onClick={e=>e.stopPropagation()}>
                <div style={{height:3,background:'var(--accent)',borderRadius:'var(--radius-lg) var(--radius-lg) 0 0'}}/>
                <div className="p-6">
                    <div className="flex items-center justify-between mb-6">
                        <h2 className="text-xl font-bold">üìÅ Nouvelle Action</h2>
                        <button onClick={onClose} className="v11-icon-btn"><Icon.Close/></button>
                    </div>
                    <div className="space-y-4">
                        <div><label className="block text-sm font-medium mb-2">Nom de l'action</label><input type="text" value={form.name} onChange={e=>setForm({...form,name:e.target.value})} placeholder="Ex: Google Ads - Brand" className="v11-input"/></div>
                        <div><label className="block text-sm font-medium mb-2">Cat√©gorie</label><select value={form.categoryId} onChange={e=>setForm({...form,categoryId:e.target.value})} className="v11-input">{categories.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
                        <div className="flex gap-4">
                            <div className="flex-1"><label className="block text-sm font-medium mb-2">Budget (‚Ç¨)</label><input type="number" value={form.budget} onChange={e=>setForm({...form,budget:parseInt(e.target.value)||0})} className="v11-input"/></div>
                            <div className="flex-1"><label className="block text-sm font-medium mb-2">Priorit√©</label><IconSelect value={form.priority} options={CONFIG.PRIORITIES} onChange={v=>setForm({...form,priority:v})} renderOption={o=><PriorityOption priority={o}/>}/></div>
                        </div>
                        <div><label className="block text-sm font-medium mb-2">Tags Canal</label><ChannelTags channels={form.tags} onAdd={id=>setForm({...form,tags:[...form.tags,id]})} onRemove={id=>setForm({...form,tags:form.tags.filter(t=>t!==id)})}/></div>
                    </div>
                    <div className="flex justify-end gap-2 mt-6"><button onClick={onClose} className="v11-btn-secondary">Annuler</button><button onClick={handleAdd} className="px-6 py-2 bg-primary text-white rounded-lg font-medium">Cr√©er l'action</button></div>
                </div>
            </div>
        </div>
    );
};

// NEW TASK MODAL
const NewTaskModal=({actions,categories,onClose,onAdd,onCreateAction})=>{
    const[form,setForm]=useState({title:'',actionId:actions[0]?.id||'',startDate:new Date().toISOString().split('T')[0],dueDate:'',priority:'medium',status:'todo',description:'',budget:0});
    const handleAdd=()=>{
        if(!form.title.trim()||!form.actionId)return;
        const action=actions.find(a=>a.id===form.actionId);
        const month=form.startDate?new Date(form.startDate).getMonth():new Date().getMonth();
        onAdd({...form,id:`t${Date.now()}`,month,channels:action?.tags||[],checklist:[],comments:[],attachments:[]});
        onClose();
    };
    const selectedAction=actions.find(a=>a.id===form.actionId);
    const actionCategory=categories.find(c=>c.id===selectedAction?.categoryId);
    return(
        <div className="v11-modal-overlay" onClick={onClose}>
            <div className="v11-modal animate-slide-up" style={{maxWidth:512}} onClick={e=>e.stopPropagation()}>
                <div className={`h-2 rounded-t-2xl bg-gradient-to-r ${actionCategory?.gradient||'from-gray-400 to-gray-500'}`}/>
                <div className="p-6">
                    <div className="flex items-center justify-between mb-6">
                        <h2 className="text-xl font-bold">‚ú® Nouvelle T√¢che</h2>
                        <button onClick={onClose} className="v11-icon-btn"><Icon.Close/></button>
                    </div>
                    <div className="space-y-4">
                        <div><label className="block text-sm font-medium mb-2">Titre</label><input type="text" value={form.title} onChange={e=>setForm({...form,title:e.target.value})} placeholder="Ex: Post LinkedIn Janvier" className="v11-input"/></div>
                        <div>
                            <div className="flex items-center justify-between mb-2"><label className="block text-sm font-medium">Action</label><button onClick={onCreateAction} className="text-xs text-secondary hover:underline flex items-center gap-1"><Icon.Plus/>Cr√©er une action</button></div>
                            <select value={form.actionId} onChange={e=>setForm({...form,actionId:e.target.value})} className="v11-input">{actions.map(a=>{const cat=categories.find(c=>c.id===a.categoryId);return<option key={a.id} value={a.id}>{a.name} ({cat?.name})</option>;})}</select>
                        </div>
                        <div className="flex gap-4">
                            <div className="flex-1"><label className="block text-sm font-medium mb-2">Date d√©but</label><input type="date" value={form.startDate} onChange={e=>setForm({...form,startDate:e.target.value})} className="v11-input"/></div>
                            <div className="flex-1"><label className="block text-sm font-medium mb-2">Date fin</label><input type="date" value={form.dueDate} onChange={e=>setForm({...form,dueDate:e.target.value})} className="v11-input"/></div>
                        </div>
                        <div className="flex gap-4">
                            <div className="flex-1"><label className="block text-sm font-medium mb-2">Priorit√©</label><IconSelect value={form.priority} options={CONFIG.PRIORITIES} onChange={v=>setForm({...form,priority:v})} renderOption={o=><PriorityOption priority={o}/>}/></div>
                            <div className="flex-1"><label className="block text-sm font-medium mb-2">Budget (‚Ç¨)</label><input type="number" value={form.budget} onChange={e=>setForm({...form,budget:parseInt(e.target.value)||0})} className="v11-input"/></div>
                        </div>
                        <div><label className="block text-sm font-medium mb-2">Description</label><textarea value={form.description} onChange={e=>setForm({...form,description:e.target.value})} rows={3} className="v11-input" style={{resize:'none'}}/></div>
                    </div>
                    <div className="flex justify-end gap-2 mt-6"><button onClick={onClose} className="v11-btn-secondary">Annuler</button><button onClick={handleAdd} className="px-6 py-2 bg-primary text-white rounded-lg font-medium">Cr√©er la t√¢che</button></div>
                </div>
            </div>
        </div>
    );
};

// HEADER
const Header=({currentView,setCurrentView,onSync,syncing,githubConnected,savingStatus})=>{
    const[mobileMenu,setMobileMenu]=useState(false);
    const navItems=[{id:'kanban',icon:Icon.Kanban,label:'Kanban'},{id:'timeline',icon:Icon.Timeline,label:'Timeline'},{id:'dashboard',icon:Icon.Dashboard,label:'KPIs'}];
    return(
        <header className="v11-header" style={{background:'var(--bg-primary)',borderBottom:'1px solid var(--border)'}}>
            <div className="v11-header-inner" style={{maxWidth:1600,margin:'0 auto',display:'flex',alignItems:'center',justifyContent:'space-between',height:'100%',gap:16,padding:'0 24px'}}>
                <div className="flex items-center gap-2.5">
                    <div className="v11-logo">M</div>
                    <div><span className="font-semibold text-sm" style={{color:'var(--text-primary)'}}>Marketing Tracker</span><span className="block text-xs" style={{color:'var(--text-muted)',fontFamily:'var(--font-mono)'}}>MIGSO-PCUBED - V3.0</span></div>
                </div>
                <nav className="hidden md:flex v11-view-tabs">
                    {navItems.map(({id,icon:I,label})=>(
                        <button key={id} onClick={()=>setCurrentView(id)} className={`v11-view-tab ${currentView===id?'active':''}`}><I size={14}/><span>{label}</span></button>
                    ))}
                </nav>
                <div className="flex items-center gap-1.5">
                    {savingStatus&&<span className="text-xs px-2 py-1 rounded-full flex items-center gap-1" style={{background:savingStatus==='error'?'var(--error-light)':'var(--accent-light)',color:savingStatus==='error'?'var(--error)':'var(--accent)'}}>{savingStatus==='saving'?'Sauvegarde...':savingStatus==='error'?'Erreur':'Sauvegard√©'}</span>}
                    <button onClick={onSync} disabled={syncing} className={`v11-icon-btn ${syncing?'animate-spin':''}`} style={{position:'relative'}} title="Synchroniser avec GitHub">
                        <Icon.Refresh/>
                        {githubConnected&&<span className="absolute top-1 right-1 w-2 h-2 rounded-full" style={{background:'var(--success)'}}/>}
                    </button>
                    <button onClick={()=>setMobileMenu(!mobileMenu)} className="md:hidden v11-icon-btn">{mobileMenu?<Icon.Close/>:<Icon.Menu/>}</button>
                </div>
            </div>
            {mobileMenu&&(<div className="md:hidden py-3 border-t animate-slide-in" style={{borderColor:'var(--border)'}}>{navItems.map(({id,icon:I,label})=>(<button key={id} onClick={()=>{setCurrentView(id);setMobileMenu(false);}} className={`flex items-center space-x-3 w-full px-4 py-3 rounded-lg text-sm ${currentView===id?'bg-primary text-white':''}`}><I/><span>{label}</span></button>))}</div>)}
        </header>
    );
};

// TASK CARD
const ChannelTags=({channels=[],onAdd,onRemove,editable=true})=>{
    const[showPicker,setShowPicker]=useState(false);
    const available=CONFIG.CHANNELS.filter(c=>!channels.includes(c.id));
    return(
        <div className="flex flex-wrap gap-1 items-center">
            {channels.map(chId=>{const ch=CONFIG.CHANNELS.find(c=>c.id===chId);return ch?(<span key={chId} className="px-2 py-0.5 rounded-full text-xs text-white flex items-center" style={{backgroundColor:ch.color}}>{ch.name}{editable&&<button onClick={()=>onRemove(chId)} className="ml-1 hover:bg-[var(--bg-primary)]/20 rounded-full w-4 h-4 flex items-center justify-center text-xs">√ó</button>}</span>):null;})}
            {editable&&available.length>0&&(<div className="relative"><button onClick={()=>setShowPicker(!showPicker)} className="px-2 py-0.5 rounded-full text-xs flex items-center space-x-1" style={{background:'var(--bg-secondary)'}}><Icon.Plus/><span>Tag</span></button>{showPicker&&(<div className="absolute top-full left-0 mt-1 rounded-lg shadow-xl p-2 z-50 min-w-[150px] max-h-48 overflow-y-auto" style={{background:'var(--bg-primary)',border:'1px solid var(--border)'}}>{available.map(ch=>(<button key={ch.id} onClick={()=>{onAdd(ch.id);setShowPicker(false);}} className="w-full text-left px-2 py-1.5 rounded text-xs flex items-center space-x-2" style={{}}><span className="w-2 h-2 rounded-full flex-shrink-0" style={{backgroundColor:ch.color}}/><span>{ch.name}</span></button>))}</div>)}</div>)}
        </div>
    );
};

const CountryTags=({countries=[],onAdd,onRemove,editable=true,allCountries=CONFIG.COUNTRIES,onAddCustomCountry})=>{
    const[showPicker,setShowPicker]=useState(false);
    const[showNewCountryForm,setShowNewCountryForm]=useState(false);
    const[newCountryName,setNewCountryName]=useState('');
    const[newCountryFlag,setNewCountryFlag]=useState('');
    const[newCountryColor,setNewCountryColor]=useState('#3b82f6');
    const[newCountryRegion,setNewCountryRegion]=useState('Europe');
    const available=allCountries.filter(c=>!countries.includes(c.id));

    // Group available countries by region
    const byRegion=available.reduce((acc,country)=>{
        if(!acc[country.region])acc[country.region]=[];
        acc[country.region].push(country);
        return acc;
    },{});

    // Get unique regions from all countries
    const availableRegions=[...new Set(CONFIG.COUNTRIES.map(c=>c.region))];

    const handleAddNewCountry=()=>{
        if(!newCountryName.trim())return;
        if(onAddCustomCountry){
            const newId=onAddCustomCountry(newCountryName.trim(),newCountryFlag||'üåç',newCountryColor,newCountryRegion);
            if(newId&&onAdd)onAdd(newId);
        }
        setNewCountryName('');
        setNewCountryFlag('');
        setNewCountryColor('#3b82f6');
        setNewCountryRegion('Europe');
        setShowNewCountryForm(false);
        setShowPicker(false);
    };

    return(
        <div className="flex flex-wrap gap-1 items-center">
            {countries.map(countryId=>{const country=allCountries.find(c=>c.id===countryId);return country?(<span key={countryId} className="px-2 py-0.5 rounded-full text-xs text-white flex items-center" style={{backgroundColor:country.color}}>{country.flag} {country.name}{editable&&<button onClick={()=>onRemove(countryId)} className="ml-1 hover:bg-[var(--bg-primary)]/20 rounded-full w-4 h-4 flex items-center justify-center text-xs">√ó</button>}</span>):null;})}
            {editable&&(<div className="relative"><button onClick={()=>setShowPicker(!showPicker)} className="px-2 py-0.5 rounded-full text-xs flex items-center space-x-1" style={{background:'var(--bg-secondary)'}}><Icon.Plus/><span>Pays</span></button>{showPicker&&(<div className="absolute top-full left-0 mt-1 rounded-lg shadow-xl p-2 z-50 min-w-[200px] max-h-96 overflow-y-auto" style={{background:'var(--bg-primary)',border:'1px solid var(--border)'}}>{!showNewCountryForm?(<>{Object.keys(byRegion).map(region=>(<div key={region}><div className="text-xs font-semibold px-2 py-1" style={{color:'var(--text-muted)'}}>{region}</div>{byRegion[region].map(country=>(<button key={country.id} onClick={()=>{onAdd(country.id);setShowPicker(false);}} className="w-full text-left px-2 py-1.5 rounded text-xs flex items-center space-x-2"><span>{country.flag}</span><span>{country.name}</span></button>))}</div>))}{onAddCustomCountry&&<button onClick={()=>setShowNewCountryForm(true)} className="w-full mt-2 px-2 py-1.5 rounded text-xs border border-dashed flex items-center justify-center space-x-1" style={{borderColor:'var(--border)'}}><Icon.Plus/><span>Nouveau pays</span></button>}</>):(<div className="p-2"><div className="text-xs font-semibold mb-2">Ajouter un pays</div><input type="text" placeholder="Nom du pays" value={newCountryName} onChange={e=>setNewCountryName(e.target.value)} className="v11-input" style={{fontSize:11,marginBottom:8}}/><input type="text" placeholder="Emoji (ex: üá´üá∑)" value={newCountryFlag} onChange={e=>setNewCountryFlag(e.target.value)} className="v11-input" style={{fontSize:11,marginBottom:8}} maxLength="4"/><div className="mb-2"><label className="text-xs block mb-1">Continent:</label><select value={newCountryRegion} onChange={e=>setNewCountryRegion(e.target.value)} className="v11-select" style={{fontSize:11,width:'100%'}}>{availableRegions.map(region=><option key={region} value={region}>{region}</option>)}</select></div><div className="flex items-center gap-2 mb-2"><label className="text-xs">Couleur:</label><input type="color" value={newCountryColor} onChange={e=>setNewCountryColor(e.target.value)} className="w-12 h-6 rounded"/></div><div className="flex gap-1"><button onClick={handleAddNewCountry} className="flex-1 px-2 py-1 text-xs bg-secondary text-white rounded">Ajouter</button><button onClick={()=>{setShowNewCountryForm(false);setNewCountryName('');setNewCountryFlag('');setNewCountryRegion('Europe');}} className="v11-btn-secondary" style={{flex:1,fontSize:11}}>Annuler</button></div></div>)}</div>)}</div>)}
        </div>
    );
};

// ACTION CARD (for category view with drag & drop reordering)
const ActionCard=({action,tasks,categories,onOpen,onMoveAction,onReorderAction})=>{
    const[dragOverPosition,setDragOverPosition]=useState(null);
    const cardRef=useRef(null);

    const handleDragOver=(e)=>{
        if(!onReorderAction)return;
        e.preventDefault();
        e.stopPropagation();

        const rect=cardRef.current.getBoundingClientRect();
        const midpoint=rect.top+rect.height/2;
        const position=e.clientY<midpoint?'before':'after';
        setDragOverPosition(position);
    };

    const handleDragLeave=(e)=>{
        e.stopPropagation();
        setDragOverPosition(null);
    };

    const handleDrop=(e)=>{
        e.preventDefault();
        e.stopPropagation();
        if(!onReorderAction||!dragOverPosition)return;

        const draggedId=e.dataTransfer.getData('actionId');
        if(draggedId&&draggedId!==action.id){
            onReorderAction(draggedId,action.id,dragOverPosition);
        }
        setDragOverPosition(null);
    };

    const actionTasks=tasks.filter(t=>t.actionId===action.id);
    const completed=actionTasks.filter(t=>t.status==='completed').length;
    const pct=actionTasks.length>0?Math.round((completed/actionTasks.length)*100):0;
    const cat=categories.find(c=>c.id===action.categoryId);

    return(
        <div
            ref={cardRef}
            draggable
            onDragStart={(e)=>{e.dataTransfer.setData('actionId',action.id);e.currentTarget.classList.add('dragging');}}
            onDragEnd={(e)=>{e.currentTarget.classList.remove('dragging');setDragOverPosition(null);}}
            onDragOver={handleDragOver}
            onDragLeave={handleDragLeave}
            onDrop={handleDrop}
            onClick={(e)=>{if(!e.defaultPrevented)onOpen(action);}}
            className={`action-card ${dragOverPosition==='before'?'drop-indicator-before':dragOverPosition==='after'?'drop-indicator-after':''}`}>
            <div className="card-header">
                <div className="card-title">{action.name}</div>
                <div className={`card-priority ${action.priority||'medium'}`}/>
            </div>
            {action.tags?.length>0&&<div className="card-tags">{action.tags.slice(0,3).map(t=>{const ch=CONFIG.CHANNELS.find(c=>c.id===t);return <span key={t} className={`card-tag ${t}`}>{ch?.name||t}</span>;})}</div>}
            <div className="action-progress-section">
                <div className="action-progress-bar"><div className={`action-progress-fill ${pct>=70?'high':pct>=40?'medium':'low'}`} style={{width:`${pct}%`}}/></div>
                <div className="action-progress-label"><span className="action-task-count"><strong>{completed}</strong>/{actionTasks.length} t√¢ches</span><span className="action-progress-percent">{pct}%</span></div>
            </div>
            {actionTasks.reduce((s,t)=>s+(t.budget||0),0)>0&&<div className="card-footer"><span/><span className="card-budget">{actionTasks.reduce((s,t)=>s+(t.budget||0),0).toLocaleString()}‚Ç¨</span></div>}
        </div>
    );
};

const TaskCard=({task,action,onOpen,onMoveTask,onReorderTask,showAction=false,onTouchDrag,categories,allCountries})=>{
    const[touching,setTouching]=useState(false);
    const[dragOverPosition,setDragOverPosition]=useState(null); // 'before' | 'after' | null
    const cardRef=useRef(null);
    const touchTimeout=useRef(null);

    const handleTouchStart=(e)=>{
        touchTimeout.current=setTimeout(()=>{
            setTouching(true);
            if(navigator.vibrate)navigator.vibrate(50);
        },300);
    };
    const handleTouchEnd=()=>{
        if(touchTimeout.current)clearTimeout(touchTimeout.current);
        setTouching(false);
    };
    const handleTouchMove=(e)=>{
        if(touching&&onTouchDrag){
            const touch=e.touches[0];
            const el=document.elementFromPoint(touch.clientX,touch.clientY);
            if(el){
                const dropZone=el.closest('[data-drop-month]');
                if(dropZone){
                    dropZone.classList.add('drag-over');
                }
            }
        }
    };

    const handleDragOver=(e)=>{
        if(!onReorderTask)return;
        e.preventDefault();
        e.stopPropagation();

        const rect=cardRef.current.getBoundingClientRect();
        const midpoint=rect.top+rect.height/2;
        const position=e.clientY<midpoint?'before':'after';
        setDragOverPosition(position);
    };

    const handleDragLeave=(e)=>{
        e.stopPropagation();
        setDragOverPosition(null);
    };

    const handleDrop=(e)=>{
        e.preventDefault();
        e.stopPropagation();
        if(!onReorderTask||!dragOverPosition)return;

        const draggedId=e.dataTransfer.getData('taskId');
        if(draggedId&&draggedId!==task.id){
            onReorderTask(draggedId,task.id,dragOverPosition);
        }
        setDragOverPosition(null);
    };

    const status=CONFIG.STATUSES.find(s=>s.id===task.status);
    const priority=CONFIG.PRIORITIES.find(p=>p.id===task.priority);
    const category=categories?.find(c=>c.id===action?.categoryId);
    const checklistPct=task.checklist?.length>0?Math.round((task.checklist.filter(c=>c.done).length/task.checklist.length)*100):null;

    return(
        <div
            ref={cardRef}
            draggable
            onDragStart={(e)=>{e.dataTransfer.setData('taskId',task.id);e.dataTransfer.setData('type','task');e.currentTarget.classList.add('dragging');}}
            onDragEnd={(e)=>{e.currentTarget.classList.remove('dragging');setDragOverPosition(null);}}
            onDragOver={handleDragOver}
            onDragLeave={handleDragLeave}
            onDrop={handleDrop}
            onTouchStart={handleTouchStart}
            onTouchMove={handleTouchMove}
            onTouchEnd={handleTouchEnd}
            onClick={()=>onOpen(task)}
            className={`kanban-card ${task.status==='completed'?'completed':''} ${touching?'touch-dragging':''} ${dragOverPosition==='before'?'drop-indicator-before':dragOverPosition==='after'?'drop-indicator-after':''}`}>
            <div className="card-header">
                <div className="card-title" style={task.status==='completed'?{textDecoration:'line-through',color:'var(--text-muted)'}:{}}>{task.title}</div>
                <div className={`card-priority ${task.priority}`}/>
            </div>
            {(task.channels||action?.tags||[]).length>0&&<div className="card-tags">
                {(task.channels||action?.tags||[]).slice(0,2).map(chId=>{const ch=CONFIG.CHANNELS.find(c=>c.id===chId);return ch?<span key={chId} className={`card-tag ${chId}`}>{ch.name}</span>:null;})}
            </div>}
            {(task.dueDate||task.budget>0)&&<div className="card-footer">
                <span className={`card-date ${task.dueDate&&new Date(task.dueDate)<new Date()&&task.status!=='completed'?'overdue':''}`}>{task.dueDate?new Date(task.dueDate).toLocaleDateString('fr-FR',{day:'numeric',month:'short'}):''}</span>
                {task.budget>0&&<span className="card-budget">{task.budget.toLocaleString()}‚Ç¨</span>}
            </div>}
        </div>
    );
};

// TASK DETAIL MODAL
const TaskDetailModal=({categories,task,action,actions,onClose,onUpdate,onDelete,onBackToAction,allCountries,onAddCustomCountry})=>{
    const[form,setForm]=useState({...task});
    const[previewAttachment,setPreviewAttachment]=useState(null);
    const[descriptionDraft,setDescriptionDraft]=useState(task.description||''); // Draft pour description
    const[descriptionSaved,setDescriptionSaved]=useState(true); // Track si sauvegard√©
    const[newComment,setNewComment]=useState('');
    const[newChecklistItem,setNewChecklistItem]=useState('');
    const currentAction=actions?.find(a=>a.id===form.actionId)||action;
    const category=categories?.find(c=>c.id===currentAction?.categoryId);

    const handleClose=()=>{onUpdate(task.id,form);onClose();}; // Auto-save on close (Trello-style)
    const saveDescription=()=>{setForm({...form,description:descriptionDraft});setDescriptionSaved(true);};
    const addComment=()=>{if(!newComment.trim())return;setForm({...form,comments:[...(form.comments||[]),{id:`cm${Date.now()}`,author:'Vous',text:newComment,date:new Date().toISOString()}]});setNewComment('');};
    const addChecklistItem=()=>{if(!newChecklistItem.trim())return;setForm({...form,checklist:[...(form.checklist||[]),{id:`cl${Date.now()}`,text:newChecklistItem,done:false}]});setNewChecklistItem('');};
    const toggleChecklistItem=(id)=>setForm({...form,checklist:form.checklist.map(i=>i.id===id?{...i,done:!i.done}:i)});
    const removeChecklistItem=(id)=>setForm({...form,checklist:form.checklist.filter(i=>i.id!==id)});
    const addChannel=(id)=>setForm({...form,channels:[...(form.channels||[]),id]});
    const removeChannel=(id)=>setForm({...form,channels:(form.channels||[]).filter(c=>c!==id)});
    const addCountry=(id)=>setForm({...form,countries:[...(form.countries||[]),id]});
    const removeCountry=(id)=>setForm({...form,countries:(form.countries||[]).filter(c=>c!==id)});
    const checklistPct=form.checklist?.length>0?Math.round((form.checklist.filter(c=>c.done).length/form.checklist.length)*100):0;

    // Handle Delete key to delete task
    useEffect(()=>{
        const handleKeyDown=(e)=>{
            // Don't trigger if user is typing in input/textarea
            const target=e.target;
            if(target.tagName==='INPUT'||target.tagName==='TEXTAREA'||target.isContentEditable){
                return;
            }

            // Delete key (or Backspace on Mac)
            if(e.key==='Delete'||e.key==='Backspace'){
                e.preventDefault();
                if(window.confirm('√ätes-vous s√ªr de vouloir supprimer cette t√¢che ?')){
                    onDelete(task.id);
                    onClose();
                }
            }
        };

        document.addEventListener('keydown',handleKeyDown);
        return()=>document.removeEventListener('keydown',handleKeyDown);
    },[task.id,onDelete,onClose]);

    return(
        <React.Fragment>
        <div className="v11-modal-overlay" onClick={handleClose} style={{alignItems:'flex-start',paddingTop:64,overflowY:'auto'}}>
            <div className="v11-modal animate-slide-up" style={{maxWidth:672,marginBottom:32}} onClick={e=>e.stopPropagation()}>
                <div className={`h-2 rounded-t-2xl bg-gradient-to-r ${category?.gradient||'from-gray-400 to-gray-500'}`}/>
                <div className="p-6">
                    <div className="flex items-start justify-between mb-4">
                        <div className="flex items-start gap-3 flex-1">
                            <button onClick={()=>setForm({...form,status:form.status==='completed'?'todo':'completed'})} className="mt-2 flex-shrink-0" style={{width:22,height:22,borderRadius:6,border:form.status==='completed'?'none':'2px solid var(--border-strong)',background:form.status==='completed'?'var(--success)':'transparent',display:'flex',alignItems:'center',justifyContent:'center',cursor:'pointer',transition:'all 0.2s'}} title={form.status==='completed'?'Marquer comme non termin√©':'Marquer comme termin√©'}>{form.status==='completed'&&<svg width="12" height="12" fill="none" stroke="white" strokeWidth="3" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7"/></svg>}</button>
                            <div className="flex-1">
                                <input type="text" value={form.title} onChange={e=>setForm({...form,title:e.target.value})} className="v11-input" style={{fontSize:'1.25rem',fontWeight:700,textDecoration:form.status==='completed'?'line-through':'none'}}/>
                                <div className="flex items-center gap-2 mt-1">
                                    <p className="text-sm" style={{color:'var(--text-muted)'}}>üìÅ {action?.name} ‚Ä¢ {CONFIG.MONTHS_FULL[task.month]}</p>
                                    {onBackToAction&&<button onClick={onBackToAction} className="text-xs text-secondary hover:underline flex items-center gap-1">‚Üê Retour √† l'action</button>}
                                </div>
                            </div>
                        </div>
                        <button onClick={handleClose} className="v11-icon-btn"><Icon.Close/></button>
                    </div>
                    <div className="flex flex-wrap gap-3 mb-6">
                        {actions&&<div className="w-full"><label className="v11-label">üìã Action</label><select value={form.actionId} onChange={e=>{const newAction=actions.find(a=>a.id===e.target.value);setForm({...form,actionId:e.target.value,channels:newAction?.tags||form.channels});}} className="v11-select" style={{width:'100%'}}>{actions.map(a=><option key={a.id} value={a.id}>{a.name}</option>)}</select></div>}
                        <div><label className="v11-label">Statut</label><IconSelect value={form.status} options={CONFIG.STATUSES} onChange={v=>setForm({...form,status:v})} renderOption={o=><StatusOption status={o}/>}/></div>
                        <div><label className="v11-label">Priorit√©</label><IconSelect value={form.priority} options={CONFIG.PRIORITIES} onChange={v=>setForm({...form,priority:v})} renderOption={o=><PriorityOption priority={o}/>}/></div>
                        <div><label className="v11-label">D√©but</label><input type="date" value={form.startDate||''} onChange={e=>setForm({...form,startDate:e.target.value})} className="v11-input"/></div>
                        <div><label className="v11-label">Fin</label><input type="date" value={form.dueDate||''} onChange={e=>setForm({...form,dueDate:e.target.value})} className="v11-input"/></div>
                        <div><label className="v11-label">Budget ‚Ç¨</label><input type="number" value={form.budget||0} onChange={e=>setForm({...form,budget:parseInt(e.target.value)||0})} className="v11-input" style={{width:96}}/></div>
                    </div>
                    <div className="mb-4"><label className="v11-label">üè∑Ô∏è Tags Canal</label><ChannelTags channels={form.channels||[]} onAdd={addChannel} onRemove={removeChannel}/></div>
                    <div className="mb-4"><label className="v11-label">üåç Tags Pays</label><CountryTags countries={form.countries||[]} onAdd={addCountry} onRemove={removeCountry} allCountries={allCountries} onAddCustomCountry={onAddCustomCountry}/></div>
                    <div className="mb-6"><label className="block text-sm font-medium mb-2">üìù Description</label><textarea value={descriptionDraft} onChange={e=>{setDescriptionDraft(e.target.value);setDescriptionSaved(false);}} placeholder="Description..." rows={3} className="v11-input" style={{resize:'none'}}/>{!descriptionSaved&&<button onClick={saveDescription} className="mt-2 px-4 py-2 bg-secondary text-white rounded-lg text-sm">Sauvegarder</button>}</div>
                    <div className="mb-6">
                        <div className="flex items-center justify-between mb-2"><label className="text-sm font-medium">‚úÖ Checklist</label>{form.checklist?.length>0&&<span className="text-sm" style={{color:'var(--text-muted)'}}>{checklistPct}%</span>}</div>
                        {form.checklist?.length>0&&<div className="v11-progress-bar" style={{height:8,marginBottom:12}}><div className={`v11-progress-fill ${checklistPct>=70?'high':checklistPct>=40?'medium':'low'}`} style={{width:`${checklistPct}%`}}/></div>}
                        <div className="space-y-2 mb-3">{form.checklist?.map(item=>(<div key={item.id} className="flex items-center space-x-3 p-2 rounded-lg" style={{background:'var(--bg-secondary)'}}><button onClick={()=>toggleChecklistItem(item.id)} className={`w-5 h-5 rounded border-2 flex items-center justify-center ${item.done?'bg-accent-green border-accent-green text-white':''}`} style={!item.done?{borderColor:'var(--border-strong)'}:{}}>{item.done&&<Icon.Check/>}</button><span className={`flex-1 text-sm ${item.done?'line-through':''}`} style={item.done?{color:'var(--text-muted)'}:{}}>{item.text}</span><button onClick={()=>removeChecklistItem(item.id)} className="hover:text-accent-red" style={{color:'var(--text-muted)'}}><Icon.Trash/></button></div>))}</div>
                        <div className="flex space-x-2"><input type="text" value={newChecklistItem} onChange={e=>setNewChecklistItem(e.target.value)} onKeyPress={e=>e.key==='Enter'&&addChecklistItem()} placeholder="Ajouter..." className="v11-input" style={{flex:1}}/><button onClick={addChecklistItem} className="px-3 py-2 bg-secondary text-white rounded-lg"><Icon.Plus/></button></div>
                    </div>
                    <div className="mb-6">
                        <label className="block text-sm font-medium mb-2">üí¨ Commentaires ({form.comments?.length||0})</label>
                        <div className="space-y-2 mb-3 max-h-40 overflow-y-auto">{form.comments?.map(c=>(<div key={c.id} className="p-3 rounded-lg" style={{background:'var(--bg-secondary)'}}><div className="flex justify-between mb-1"><span className="font-medium text-sm">{c.author}</span><span className="text-xs" style={{color:'var(--text-muted)'}}>{new Date(c.date).toLocaleDateString('fr-FR')}</span></div><p className="text-sm" style={{color:'var(--text-secondary)'}}>{c.text}</p></div>))}</div>
                        <div className="flex space-x-2"><input type="text" value={newComment} onChange={e=>setNewComment(e.target.value)} onKeyPress={e=>e.key==='Enter'&&addComment()} placeholder="√âcrire..." className="v11-input" style={{flex:1}}/><button onClick={addComment} className="px-4 py-2 bg-secondary text-white rounded-lg text-sm">Envoyer</button></div>
                    </div>
                    <div className="mb-6">
                        <label className="block text-sm font-medium mb-2">üìé Pi√®ces jointes ({(form.attachments||[]).length})</label>
                        {(form.attachments||[]).length>0&&<div className="space-y-2 mb-3">
                            {(form.attachments||[]).map(att=>(
                                <div key={att.id} className="flex items-center gap-3 p-3 rounded-lg" style={{background:'var(--bg-secondary)',cursor:'pointer'}} onClick={()=>setPreviewAttachment(att)}>
                                    {att.type?.startsWith('image/')?
                                        <img src={att.data} alt={att.name} style={{width:40,height:40,objectFit:'cover',borderRadius:'var(--radius-sm)',flexShrink:0}}/>:
                                        <div style={{width:40,height:40,borderRadius:'var(--radius-sm)',background:'var(--accent-light)',display:'flex',alignItems:'center',justifyContent:'center',flexShrink:0,fontSize:16}}>üìÑ</div>
                                    }
                                    <div style={{flex:1,minWidth:0}}>
                                        <div style={{fontSize:13,fontWeight:500,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{att.name}</div>
                                        <div style={{fontSize:11,color:'var(--text-muted)'}}>{att.size?`${(att.size/1024).toFixed(1)} Ko`:''} ‚Ä¢ {att.date?new Date(att.date).toLocaleDateString('fr-FR'):''}</div>
                                    </div>
                                    {att.data&&<a href={att.data} download={att.name} onClick={e=>e.stopPropagation()} style={{color:'var(--accent)',fontSize:12,fontWeight:500,flexShrink:0,cursor:'pointer'}} title="T√©l√©charger">‚Üì</a>}
                                    <button onClick={(e)=>{e.stopPropagation();setForm({...form,attachments:(form.attachments||[]).filter(a=>a.id!==att.id)});}} style={{color:'var(--text-muted)',cursor:'pointer',flexShrink:0,background:'none',border:'none',fontSize:14}} title="Supprimer">‚úï</button>
                                </div>
                            ))}
                        </div>}
                        <div
                            onDragOver={e=>{e.preventDefault();e.currentTarget.style.borderColor='var(--accent)';e.currentTarget.style.background='var(--accent-light)';}}
                            onDragLeave={e=>{e.currentTarget.style.borderColor='var(--border)';e.currentTarget.style.background='transparent';}}
                            onDrop={e=>{
                                e.preventDefault();
                                e.currentTarget.style.borderColor='var(--border)';
                                e.currentTarget.style.background='transparent';
                                const files=Array.from(e.dataTransfer.files);
                                files.forEach(file=>{
                                    if(file.size>5*1024*1024)return; // 5MB limit
                                    const reader=new FileReader();
                                    reader.onload=(ev)=>{
                                        setForm(prev=>({...prev,attachments:[...(prev.attachments||[]),{id:`att${Date.now()}_${Math.random().toString(36).slice(2,6)}`,name:file.name,type:file.type,size:file.size,data:ev.target.result,date:new Date().toISOString()}]}));
                                    };
                                    reader.readAsDataURL(file);
                                });
                            }}
                            className="border-2 border-dashed rounded-lg p-4 text-center" style={{borderColor:'var(--border)',cursor:'pointer',transition:'all 0.2s'}}
                            onClick={()=>document.getElementById('file-upload-input')?.click()}
                        >
                            <input id="file-upload-input" type="file" multiple style={{display:'none'}} onChange={e=>{
                                const files=Array.from(e.target.files||[]);
                                files.forEach(file=>{
                                    if(file.size>5*1024*1024)return;
                                    const reader=new FileReader();
                                    reader.onload=(ev)=>{
                                        setForm(prev=>({...prev,attachments:[...(prev.attachments||[]),{id:`att${Date.now()}_${Math.random().toString(36).slice(2,6)}`,name:file.name,type:file.type,size:file.size,data:ev.target.result,date:new Date().toISOString()}]}));
                                    };
                                    reader.readAsDataURL(file);
                                });
                                e.target.value='';
                            }}/>
                            <p style={{fontSize:13,color:'var(--text-muted)'}}>Glissez des fichiers ici ou cliquez pour parcourir</p>
                            <p style={{fontSize:11,color:'var(--text-muted)',marginTop:4}}>Max 5 Mo par fichier</p>
                        </div>
                    </div>
                    <div className="flex items-center justify-between pt-4" style={{borderTop:'1px solid var(--border)'}}>
                        <button onClick={()=>{onDelete(task.id);onClose();}} className="px-4 py-2 text-accent-red hover:bg-red-50 rounded-lg text-sm flex items-center space-x-2"><Icon.Trash/><span>Supprimer</span></button>
                        <button onClick={handleClose} className="px-6 py-2 bg-primary text-white rounded-lg text-sm font-medium">Fermer</button>
                    </div>
                </div>
            </div>
        </div>
        {previewAttachment&&(
            <div onClick={()=>setPreviewAttachment(null)} style={{position:'fixed',inset:0,zIndex:200,background:'rgba(0,0,0,0.85)',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',cursor:'zoom-out',padding:24}}>
                <div style={{position:'absolute',top:16,right:16,display:'flex',gap:8}}>
                    {previewAttachment.data&&<a href={previewAttachment.data} download={previewAttachment.name} onClick={e=>e.stopPropagation()} style={{padding:'8px 16px',background:'rgba(255,255,255,0.15)',color:'white',borderRadius:'var(--radius-sm)',fontSize:13,fontWeight:500,textDecoration:'none',cursor:'pointer',backdropFilter:'blur(8px)'}}>‚Üì T√©l√©charger</a>}
                    <button onClick={()=>setPreviewAttachment(null)} style={{padding:'8px 16px',background:'rgba(255,255,255,0.15)',color:'white',borderRadius:'var(--radius-sm)',fontSize:13,fontWeight:500,border:'none',cursor:'pointer',backdropFilter:'blur(8px)'}}>‚úï Fermer</button>
                </div>
                {previewAttachment.type?.startsWith('image/')?
                    <img src={previewAttachment.data} alt={previewAttachment.name} onClick={e=>e.stopPropagation()} style={{maxWidth:'90vw',maxHeight:'85vh',objectFit:'contain',borderRadius:'var(--radius-lg)',boxShadow:'0 20px 60px rgba(0,0,0,0.5)',cursor:'default'}}/>:
                    previewAttachment.type==='application/pdf'?
                    <iframe src={previewAttachment.data} onClick={e=>e.stopPropagation()} style={{width:'80vw',height:'85vh',borderRadius:'var(--radius-lg)',border:'none',background:'white',cursor:'default'}}/>:
                    <div onClick={e=>e.stopPropagation()} style={{background:'var(--bg-primary)',borderRadius:'var(--radius-lg)',padding:40,textAlign:'center',cursor:'default',maxWidth:400}}>
                        <div style={{fontSize:48,marginBottom:16}}>üìÑ</div>
                        <div style={{fontSize:16,fontWeight:600,marginBottom:8}}>{previewAttachment.name}</div>
                        <div style={{fontSize:13,color:'var(--text-muted)',marginBottom:16}}>{previewAttachment.size?`${(previewAttachment.size/1024).toFixed(1)} Ko`:''}</div>
                        <p style={{fontSize:12,color:'var(--text-muted)'}}>Aper√ßu non disponible pour ce type de fichier</p>
                        {previewAttachment.data&&<a href={previewAttachment.data} download={previewAttachment.name} style={{display:'inline-block',marginTop:16,padding:'10px 20px',background:'var(--accent)',color:'white',borderRadius:'var(--radius-md)',fontSize:13,fontWeight:600,textDecoration:'none'}}>T√©l√©charger</a>}
                    </div>
                }
                <div style={{color:'rgba(255,255,255,0.7)',fontSize:12,marginTop:12}}>{previewAttachment.name}</div>
            </div>
        )}
        </React.Fragment>
    );
};

const ActionDetailModal=({categories,action,tasks,onClose,onUpdateAction,onUpdateTask,onOpenTask,onAddTask,onDeleteAction})=>{
    const[form,setForm]=useState({...action});
    const[showConfirmDelete,setShowConfirmDelete]=useState(false);
    const actionTasks=tasks.filter(t=>t.actionId===action.id);
    const completedTasks=actionTasks.filter(t=>t.status==='completed').length;
    const progressPct=actionTasks.length>0?Math.round((completedTasks/actionTasks.length)*100):0;
    const category=categories?.find(c=>c.id===form.categoryId);
    const totalBudget=actionTasks.reduce((s,t)=>s+(t.budget||0),0);

    const handleClose=()=>{onUpdateAction(action.id,form);onClose();}; // Auto-save on close (Trello-style)
    const handleDelete=()=>{if(onDeleteAction){onDeleteAction(action.id);onClose();}};
    const handleStatusChange=(taskId,newStatus)=>{onUpdateTask(taskId,{status:newStatus});};
    const addChannel=(id)=>setForm({...form,tags:[...(form.tags||[]),id]});
    const removeChannel=(id)=>setForm({...form,tags:(form.tags||[]).filter(c=>c!==id)});

    return(
        <div className="v11-modal-overlay" onClick={handleClose} style={{alignItems:'flex-start',paddingTop:64,overflowY:'auto'}}>
            <div className="v11-modal animate-slide-up" style={{maxWidth:512,marginBottom:32}} onClick={e=>e.stopPropagation()}>
                <div className={`h-2 rounded-t-2xl bg-gradient-to-r ${category?.gradient||'from-gray-400 to-gray-500'}`}/>
                <div className="p-6" style={{maxHeight:'calc(90vh - 80px)',overflowY:'auto'}}>
                    <div className="flex items-start justify-between mb-4">
                        <div className="flex-1">
                            <span className="text-xs" style={{color:'var(--text-muted)',textTransform:'uppercase',letterSpacing:0.5,fontWeight:600}}>üìÅ ACTION</span>
                            <input type="text" value={form.name} onChange={e=>setForm({...form,name:e.target.value})} className="v11-input" style={{fontSize:'1.25rem',fontWeight:700,marginTop:4}}/>
                        </div>
                        <button onClick={handleClose} className="ml-2 v11-icon-btn"><Icon.Close/></button>
                    </div>
                    <div className="flex flex-wrap gap-3 mb-4">
                        <div><label className="v11-label">Cat√©gorie</label><select value={form.categoryId} onChange={e=>setForm({...form,categoryId:e.target.value})} className="v11-select">{categories.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
                        <div><label className="v11-label">Priorit√©</label><IconSelect value={form.priority} options={CONFIG.PRIORITIES} onChange={v=>setForm({...form,priority:v})} renderOption={o=><PriorityOption priority={o}/>}/></div>
                        <div><label className="v11-label">Budget ‚Ç¨</label><input type="number" value={form.budget||0} onChange={e=>setForm({...form,budget:parseInt(e.target.value)||0})} className="v11-input" style={{width:128}}/></div>
                    </div>
                    <div className="rounded-xl p-4 mb-4" style={{background:'var(--bg-secondary)'}}>
                        <div className="flex justify-between mb-3">
                            <div><span className="text-xs" style={{color:'var(--text-muted)'}}>üí∞ Budget Total T√¢ches</span><p className="text-lg font-bold text-secondary">{totalBudget.toLocaleString()}‚Ç¨</p></div>
                            <div><span className="text-xs" style={{color:'var(--text-muted)'}}>üìä Progression</span><p className="text-lg font-bold">{progressPct}%</p></div>
                            <div><span className="text-xs" style={{color:'var(--text-muted)'}}>üìã T√¢ches</span><p className="text-lg font-bold">{completedTasks}/{actionTasks.length}</p></div>
                        </div>
                        <div className="v11-progress-bar" style={{height:12}}><div className={`v11-progress-fill ${progressPct>=70?'high':progressPct>=40?'medium':'low'}`} style={{width:`${progressPct}%`}}/></div>
                    </div>
                    <div className="mb-4"><label className="v11-label">üè∑Ô∏è Tags Canal</label><ChannelTags channels={form.tags||[]} onAdd={addChannel} onRemove={removeChannel}/></div>
                    <div className="mb-4">
                        <div className="flex items-center justify-between mb-3">
                            <label className="text-sm font-medium">üìã T√ÇCHES ({actionTasks.length})</label>
                            <button onClick={()=>onAddTask(action.id)} className="px-3 py-1 bg-secondary text-white rounded-lg text-xs flex items-center space-x-1"><Icon.Plus/><span>Ajouter</span></button>
                        </div>
                        <div className="space-y-2 max-h-48 overflow-y-auto">
                            {actionTasks.length>0?actionTasks.map(task=>{
                                const status=CONFIG.STATUSES.find(s=>s.id===task.status);
                                return(
                                    <div key={task.id} className="rounded-lg p-3" style={{background:'var(--bg-secondary)',border:'1px solid var(--border-light)'}}>
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center space-x-3 flex-1 min-w-0">
                                                <IconSelect value={task.status} options={CONFIG.STATUSES} onChange={v=>handleStatusChange(task.id,v)} renderOption={o=><StatusOption status={o}/>} style={{minWidth:120}}/>
                                                <div className="flex-1 min-w-0">
                                                    <p className="font-medium text-sm truncate">{task.title}</p>
                                                    <p className="text-xs" style={{color:'var(--text-muted)'}}>üìÖ {task.startDate?new Date(task.startDate).toLocaleDateString('fr-FR',{day:'numeric',month:'short'}):'?'} ‚Üí {task.dueDate?new Date(task.dueDate).toLocaleDateString('fr-FR',{day:'numeric',month:'short'}):'?'}</p>
                                                </div>
                                            </div>
                                            <div className="flex items-center space-x-2">
                                                {task.budget>0&&<span className="text-xs font-semibold text-secondary">{task.budget}‚Ç¨</span>}
                                                <button onClick={()=>onOpenTask(task)} className="p-1 rounded" style={{color:'var(--text-muted)'}}><Icon.External/></button>
                                            </div>
                                        </div>
                                    </div>
                                );
                            }):<p className="text-center py-4 text-sm" style={{color:'var(--text-muted)'}}>Aucune t√¢che</p>}
                        </div>
                    </div>
                    {showConfirmDelete&&(
                        <div className="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                            <p className="text-sm font-medium text-red-800 mb-2">‚ö†Ô∏è Confirmer la suppression ?</p>
                            <p className="text-xs text-red-600 mb-3">Cette action et ses {actionTasks.length} t√¢che(s) seront d√©finitivement supprim√©es.</p>
                            <div className="flex space-x-2">
                                <button onClick={handleDelete} className="px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium">Confirmer</button>
                                <button onClick={()=>setShowConfirmDelete(false)} className="v11-btn-secondary">Annuler</button>
                            </div>
                        </div>
                    )}
                    <div className="flex items-center justify-between pt-4" style={{borderTop:'1px solid var(--border)'}}>
                        <button onClick={()=>setShowConfirmDelete(true)} className="px-4 py-2 text-accent-red hover:bg-red-50 rounded-lg text-sm flex items-center space-x-2"><Icon.Trash/><span>Supprimer</span></button>
                        <button onClick={handleClose} className="px-6 py-2 bg-primary text-white rounded-lg text-sm font-medium">Fermer</button>
                    </div>
                </div>
            </div>
        </div>
    );
};

// KANBAN VIEW
const KanbanView=({categories,actions,tasks,onOpenTask,onOpenAction,onUpdateTask,onUpdateAction,onAddTask,onAddAction,onMoveTask,onReorderTask,onMoveAction,onReorderAction,filters,setFilters,allCountries,selectedYear,onYearChange})=>{
    const[viewMode,setViewMode]=useState('month');
    const[selectedAction,setSelectedAction]=useState(null);
    const[actionFilters,setActionFilters]=useState([]);
    const[sortBy,setSortBy]=useState('order'); // order, name, date, deadline, priority

    const filteredTasks=tasks.filter(t=>{
        const action=actions.find(a=>a.id===t.actionId);
        if(selectedYear){
            const taskStartYear=t.startDate?new Date(t.startDate).getFullYear():null;
            const taskEndYear=t.dueDate?new Date(t.dueDate).getFullYear():null;
            if(taskStartYear&&taskStartYear>selectedYear)return false;
            if(taskEndYear&&taskEndYear<selectedYear)return false;
            if(taskStartYear&&!taskEndYear&&taskStartYear!==selectedYear)return false;
        }
        if(filters.search&&!t.title.toLowerCase().includes(filters.search.toLowerCase()))return false;
        if(filters.status.length>0&&!filters.status.includes(t.status))return false;
        if(filters.category.length>0&&!filters.category.includes(action?.categoryId))return false;
        if(filters.priority.length>0&&!filters.priority.includes(t.priority))return false;
        if(filters.channel&&filters.channel.length>0&&!(t.channels||[]).some(c=>filters.channel.includes(c)))return false;
        if(filters.country&&filters.country.length>0&&!(t.countries||[]).some(c=>filters.country.includes(c)))return false;
        if(actionFilters.length>0&&!actionFilters.includes(t.actionId))return false;
        return true;
    });

    const handleActionDrop=(e,categoryId)=>{
        e.preventDefault();e.currentTarget.classList.remove('drag-over');
        const actionId=e.dataTransfer.getData('actionId');
        if(actionId&&onUpdateAction){
            onUpdateAction(actionId,{categoryId});
        }
    };
    const handleDragOver=(e)=>{e.preventDefault();e.currentTarget.classList.add('drag-over');};
    const handleDragLeave=(e)=>{e.currentTarget.classList.remove('drag-over');};

    const getColumns=()=>{
        // Helper to sort items by different criteria
        const sortItems=(items)=>{
            const sorted=[...items];
            if(sortBy==='order')return sorted.sort((a,b)=>(a.order||0)-(b.order||0));
            if(sortBy==='name')return sorted.sort((a,b)=>a.title.localeCompare(b.title));
            if(sortBy==='date')return sorted.sort((a,b)=>new Date(a.startDate||0)-new Date(b.startDate||0));
            if(sortBy==='deadline')return sorted.sort((a,b)=>new Date(a.dueDate||'9999')-new Date(b.dueDate||'9999'));
            if(sortBy==='created')return sorted.sort((a,b)=>new Date(a.createdAt||0)-new Date(b.createdAt||0));
            if(sortBy==='priority'){
                const priorityOrder={high:0,medium:1,low:2};
                return sorted.sort((a,b)=>(priorityOrder[a.priority]||99)-(priorityOrder[b.priority]||99));
            }
            return sorted;
        };

        if(viewMode==='month')return CONFIG.MONTHS_FULL.map((name,idx)=>({key:idx,name,items:sortItems(filteredTasks.filter(t=>t.month===idx))}));
        if(viewMode==='quarter'){
            const quarters=[
                {key:0,name:'Q1 (Jan-Mars)',months:[0,1,2]},
                {key:1,name:'Q2 (Avr-Juin)',months:[3,4,5]},
                {key:2,name:'Q3 (Juil-Sep)',months:[6,7,8]},
                {key:3,name:'Q4 (Oct-D√©c)',months:[9,10,11]}
            ];
            return quarters.map(q=>({
                key:q.key,
                name:q.name,
                items:sortItems(filteredTasks.filter(t=>q.months.includes(t.month)))
            }));
        }
        if(viewMode==='category')return categories.map(cat=>({key:cat.id,name:cat.name,gradient:cat.gradient,items:actions.filter(a=>a.categoryId===cat.id&&filteredTasks.some(t=>t.actionId===a.id))}));
        if(viewMode==='action'){
            if(selectedAction){
                return CONFIG.STATUSES.map(s=>({key:s.id,name:s.name,color:s.color,icon:s.icon,items:sortItems(filteredTasks.filter(t=>t.actionId===selectedAction&&t.status===s.id))}));
            }else{
                return CONFIG.STATUSES.map(s=>({key:s.id,name:s.name,color:s.color,icon:s.icon,items:sortItems(filteredTasks.filter(t=>t.status===s.id))}));
            }
        }
        return[];
    };

    return(
        <div className="animate-slide-in">
            <div className="kanban-wrapper">
            <div className="kanban-toolbar">
                <div className="kanban-toolbar-left">
                    <div className="view-btn-group">
                        {[{id:'month',label:'Par Mois'},{id:'quarter',label:'Par Trimestre'},{id:'category',label:'Par Cat√©gorie'},{id:'action',label:'Par Action'}].map(v=>(
                            <button key={v.id} onClick={()=>{setViewMode(v.id);if(v.id!=='action')setSelectedAction(null);}} className={`view-btn ${viewMode===v.id?'active':''}`}>{v.label}</button>
                        ))}
                    </div>
                </div>
                <div className="kanban-toolbar-right">
                    {viewMode!=='category'&&<><span className="toolbar-label">Tri:</span>
                    <select value={sortBy} onChange={(e)=>setSortBy(e.target.value)} className="toolbar-select">
                        <option value="order">Manuel</option>
                        <option value="name">Nom A‚ÜíZ</option>
                        <option value="created">Date cr√©ation</option>
                        <option value="date">Date d√©but</option>
                        <option value="deadline">Deadline</option>
                        <option value="priority">Priorit√©</option>
                    </select></>}
                    {onYearChange&&<div className="timeline-nav" style={{marginLeft:12}}>
                        <button className="timeline-nav-btn" onClick={()=>onYearChange(selectedYear-1)}>‚óÄ</button>
                        <span className="timeline-current">{selectedYear}</span>
                        <button className="timeline-nav-btn" onClick={()=>onYearChange(selectedYear+1)}>‚ñ∂</button>
                    </div>}
                </div>
            </div>
            <div className="kanban-board">
                    {getColumns().map(col=>(
                        <div
                            key={col.key}
                            data-drop-month={viewMode==='month'?col.key:null}
                            onDragOver={(e)=>{e.preventDefault();if(viewMode==='month'||viewMode==='quarter'||viewMode==='category'||viewMode==='action')e.currentTarget.classList.add('drag-over');}}
                            onDragLeave={(e)=>e.currentTarget.classList.remove('drag-over')}
                            onDrop={(e)=>{
                                e.preventDefault();
                                e.currentTarget.classList.remove('drag-over');
                                if(viewMode==='month'){
                                    const taskId=e.dataTransfer.getData('taskId');
                                    if(taskId){
                                        const monthIdx=col.key;
                                        const year=selectedYear;
                                        const startDate=year+'-'+String(monthIdx+1).padStart(2,'0')+'-01';
                                        const lastDay=new Date(year,monthIdx+1,0).getDate();
                                        const dueDate=year+'-'+String(monthIdx+1).padStart(2,'0')+'-'+lastDay;
                                        onUpdateTask(taskId,{startDate,dueDate,month:monthIdx});
                                    }
                                }else if(viewMode==='quarter'){
                                    const taskId=e.dataTransfer.getData('taskId');
                                    if(taskId){
                                        const quarterIdx=col.key;
                                        const year=selectedYear;
                                        const firstMonth=quarterIdx*3;
                                        const lastMonth=quarterIdx*3+2;
                                        const startDate=year+'-'+String(firstMonth+1).padStart(2,'0')+'-01';
                                        const lastDay=new Date(year,lastMonth+1,0).getDate();
                                        const dueDate=year+'-'+String(lastMonth+1).padStart(2,'0')+'-'+lastDay;
                                        onUpdateTask(taskId,{startDate,dueDate,month:firstMonth});
                                    }
                                }else if(viewMode==='category'){
                                    const actionId=e.dataTransfer.getData('actionId');
                                    if(actionId&&onUpdateAction){
                                        onUpdateAction(actionId,{categoryId:col.key});
                                    }
                                }else if(viewMode==='action'){
                                    const taskId=e.dataTransfer.getData('taskId');
                                    if(taskId){
                                        onUpdateTask(taskId,{status:col.key});
                                    }
                                }
                            }}
                            className="kanban-column" >
                            <div className="column-header">
                                <div className="column-title">
                                    {col.color&&<StatusIcon statusId={col.key} size={12}/>}
                                    {col.gradient&&<div style={{background:categories.find(c=>c.id===col.key)?.color||'var(--accent)',width:4,height:20,borderRadius:2,flexShrink:0}}/>}
                                    <span className="column-name">{col.name}</span>
                                    <span className="column-count">{col.items.length}</span>
                                </div>
                                <button className="column-menu" onClick={(e)=>e.stopPropagation()}>‚ãÆ</button>
                            </div>
                            <div className="kanban-cards">
                                {viewMode==='category'?col.items.sort((a,b)=>(a.order||0)-(b.order||0)).map(action=><ActionCard key={action.id} action={action} tasks={tasks} categories={categories} onOpen={onOpenAction} onMoveAction={onMoveAction} onReorderAction={onReorderAction}/>):[...col.items].sort((a,b)=>(a.status==='completed')-(b.status==='completed')).map(task=><TaskCard key={task.id} task={task} action={actions.find(a=>a.id===task.actionId)} onOpen={onOpenTask} onMoveTask={sortBy==='order'?onMoveTask:null} onReorderTask={sortBy==='order'?onReorderTask:null} showAction={viewMode==='month'} categories={categories} allCountries={allCountries}/>)}
                                {col.items.length===0&&<div className="column-empty">Aucune t√¢che</div>}
                                <button onClick={()=>{
                                    if(viewMode==='month'){
                                        const monthIdx=col.key;
                                        const year=selectedYear;
                                        const startDate=year+'-'+String(monthIdx+1).padStart(2,'0')+'-01';
                                        const lastDay=new Date(year,monthIdx+1,0).getDate();
                                        const dueDate=year+'-'+String(monthIdx+1).padStart(2,'0')+'-'+lastDay;
                                        const newTask={id:`t${Date.now()}`,title:'Nouvelle t√¢che',actionId:actions[0]?.id||'',month:monthIdx,startDate,dueDate,status:'todo',priority:'medium',description:'',checklist:[],comments:[],attachments:[],channels:actions[0]?.tags||[]};
                                        onAddTask(newTask);
                                        setTimeout(()=>onOpenTask(newTask),100);
                                    }else if(viewMode==='category'){
                                        const newAction={id:`a${Date.now()}`,name:'Nouvelle action',categoryId:col.key,budget:0,priority:'medium',tags:[]};
                                        onAddAction(newAction);
                                        setTimeout(()=>onOpenAction(newAction),100);
                                    }else if(viewMode==='action'){
                                        const newTask={id:`t${Date.now()}`,title:'Nouvelle t√¢che',actionId:selectedAction||actions[0]?.id||'',month:new Date().getMonth(),startDate:new Date().toISOString().split('T')[0],dueDate:new Date().toISOString().split('T')[0],status:col.key,priority:'medium',description:'',checklist:[],comments:[],attachments:[],channels:actions.find(a=>a.id===(selectedAction||actions[0]?.id))?.tags||[]};
                                        onAddTask(newTask);
                                        setTimeout(()=>onOpenTask(newTask),100);
                                    }
                                }} className="add-card-btn">
                                    + Ajouter
                                </button>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
};

// TIMELINE VIEW
// Am√©liorations drag & drop v2.2 :
// - Snap √† la demi-journ√©e en vue semaine (14 slots) pour une pr√©cision doubl√©e
// - Snap au jour avec demi-journ√©e en vue mois pour meilleure pr√©cision
// - Handles de redimensionnement plus larges (10-20px) et plus visibles (opacity 0.3 par d√©faut)
// - Indicateurs visuels am√©lior√©s : bordures anim√©es, ombres, feedback en temps r√©el
// - Curseur col-resize global pendant le resize pour clart√©
// - Zone de drop des t√¢ches entre actions avec bordure pointill√©e et fond color√©
// - Pr√©vention des conflits : clic sur handle ne d√©clenche pas l'ouverture de carte
// - Styles CSS optimis√©s pour mobile/tactile (handles 28px, opacity 0.7)
const TimelineView=({categories,actions,tasks,onOpenTask,onOpenAction,onUpdateTask,onUpdateAction,onReorderAction,onAddTask,filters,setFilters,selectedYear,onYearChange})=>{
    const timelineRef=useRef(null);
    const dragGhostRef=useRef(null);
    const[zoom,setZoom]=useState('month');
    const[isPanning,setIsPanning]=useState(false);
    const[startX,setStartX]=useState(0);
    const[scrollLeft,setScrollLeft]=useState(0);
    const[spacePressed,setSpacePressed]=useState(false);
    const[resizing,setResizing]=useState(null); // {taskId, handle: 'left'|'right', startX, originalStart, originalEnd}
    const[justResized,setJustResized]=useState(false); // Prevent click after resize
    const[dragging,setDragging]=useState(null); // {taskId, task, startX, startY, originalLeft}
    const[dragOverTask,setDragOverTask]=useState(null); // {taskId, position: 'before'|'after'}
    const[dragOverAction,setDragOverAction]=useState(null); // {actionId, position: 'before'|'after'}
    const[dragOverActionRow,setDragOverActionRow]=useState(null); // actionId of row being dragged over
    const[dragPreview,setDragPreview]=useState(null); // {left, width, actionId} for preview line
    const[dropIndicator,setDropIndicator]=useState(null); // {left, actionId} for precise drop indicator
    const[centerDateRef,setCenterDateRef]=useState(null); // Reference date for scroll preservation
    const[creatingTask,setCreatingTask]=useState(null); // {actionId, startX, currentX, startDate, actionRow} for task creation
    const currentMonth=new Date().getMonth();
    // Week base: Monday on or before Jan 1 (aligns week columns to real calendar weeks)
    const jan1=new Date(selectedYear,0,1);const jan1Dow=jan1.getDay();
    const weekBase=new Date(selectedYear,0,1-(jan1Dow===0?6:jan1Dow-1));
    const currentWeek=Math.floor((new Date().getTime()-weekBase.getTime())/(7*24*60*60*1000));

    // Calculate the date at the center of the current viewport
    const getCenterDate=useCallback(()=>{
        if(!timelineRef.current)return null;
        const scrollLeft=timelineRef.current.scrollLeft;
        const viewportWidth=timelineRef.current.clientWidth;
        const centerX=scrollLeft+viewportWidth/2-250; // -250 for left column

        const year=selectedYear;
        if(zoom==='day'){
            const dayIndex=Math.floor(centerX/colWidth);
            const date=new Date(year,0,1+dayIndex);
            return date;
        }else if(zoom==='week'){
            const pixelsPerDay=colWidth/7;
            const dayIndex=Math.floor(centerX/pixelsPerDay);
            const date=new Date(weekBase.getTime()+dayIndex*86400000);
            return date;
        }else if(zoom==='month'){
            const monthIndex=Math.floor(centerX/colWidth);
            const monthProgress=(centerX%colWidth)/colWidth;
            const daysInMonth=new Date(year,monthIndex+1,0).getDate();
            const day=Math.floor(monthProgress*daysInMonth)+1;
            const date=new Date(year,monthIndex,day);
            return date;
        }else if(zoom==='quarter'){
            const quarterIndex=Math.floor(centerX/colWidth);
            const quarterProgress=(centerX%colWidth)/colWidth;
            const monthInQuarter=Math.floor(quarterProgress*3);
            const monthProgress=(quarterProgress*3)%1;
            const monthIndex=quarterIndex*3+monthInQuarter;
            const daysInMonth=new Date(year,monthIndex+1,0).getDate();
            const day=Math.floor(monthProgress*daysInMonth)+1;
            const date=new Date(year,monthIndex,day);
            return date;
        }
        return new Date(year,0,1);
    },[zoom,colWidth]);

    // Scroll to a specific date in the current zoom level
    const scrollToDate=useCallback((targetDate)=>{
        if(!timelineRef.current||!targetDate)return;
        const year=selectedYear;
        const month=targetDate.getMonth();
        const day=targetDate.getDate();

        let scrollPosition=0;
        if(zoom==='day'){
            const dayOfYear=Math.floor((targetDate-new Date(year,0,1))/(1000*60*60*24));
            scrollPosition=dayOfYear*colWidth;
        }else if(zoom==='week'){
            const daysFromBase=Math.floor((targetDate-weekBase)/(1000*60*60*24));
            const pixelsPerDay=colWidth/7;
            scrollPosition=daysFromBase*pixelsPerDay;
        }else if(zoom==='month'){
            const daysInMonth=new Date(year,month+1,0).getDate();
            const dayProgress=(day-1)/daysInMonth;
            scrollPosition=month*colWidth+dayProgress*colWidth;
        }else if(zoom==='quarter'){
            const quarter=Math.floor(month/3);
            const monthInQuarter=month%3;
            const daysInMonth=new Date(year,month+1,0).getDate();
            const dayProgress=(day-1)/daysInMonth;
            const monthProgress=monthInQuarter/3+dayProgress/3;
            scrollPosition=quarter*colWidth+monthProgress*colWidth;
        }

        // Center the date in the viewport
        const viewportWidth=timelineRef.current.clientWidth;
        timelineRef.current.scrollLeft=scrollPosition-viewportWidth/2+250; // +250 for left column
    },[zoom,colWidth]);

    // Save center date before zoom change and restore after
    const handleZoomChange=useCallback((newZoom)=>{
        const centerDate=getCenterDate();
        setCenterDateRef(centerDate);
        setZoom(newZoom);
    },[getCenterDate]);

    // Restore scroll position when zoom changes
    useEffect(()=>{
        if(centerDateRef){
            // Small delay to ensure layout is ready
            setTimeout(()=>{
                scrollToDate(centerDateRef);
                setCenterDateRef(null);
            },0);
        }
    },[zoom,centerDateRef,scrollToDate]);

    useEffect(()=>{
        const handleKeyDown=(e)=>{if(e.code==='Space'&&!e.target.tagName.match(/INPUT|TEXTAREA/)){e.preventDefault();setSpacePressed(true);}};
        const handleKeyUp=(e)=>{if(e.code==='Space')setSpacePressed(false);};
        window.addEventListener('keydown',handleKeyDown);
        window.addEventListener('keyup',handleKeyUp);
        return()=>{window.removeEventListener('keydown',handleKeyDown);window.removeEventListener('keyup',handleKeyUp);};
    },[]);

    const handleMouseDown=(e)=>{if(!spacePressed)return;setIsPanning(true);setStartX(e.pageX-timelineRef.current.offsetLeft);setScrollLeft(timelineRef.current.scrollLeft);};
    const handleMouseMove=(e)=>{if(!isPanning)return;e.preventDefault();const x=e.pageX-timelineRef.current.offsetLeft;timelineRef.current.scrollLeft=scrollLeft-(x-startX)*2;};
    const handleMouseUp=()=>setIsPanning(false);

    const colWidth=zoom==='quarter'?280:zoom==='week'?40:zoom==='day'?60:100;

    // Resize handlers with useCallback to avoid recreating on every render
    const startResize=useCallback((taskId,handle,clientX,task)=>{
        document.body.classList.add('resizing');
        setResizing({
            taskId,
            handle,
            startX:clientX,
            originalStart:task.startDate,
            originalEnd:task.dueDate
        });
    },[]);

    const endResize=useCallback(()=>{
        document.body.classList.remove('resizing');
        setResizing(null);
        setJustResized(true);
        // Reset after a short delay to allow click events to be blocked
        setTimeout(()=>setJustResized(false),100);
    },[]);

    useEffect(()=>{
        if(!resizing)return;

        const handleGlobalMouseMove=(e)=>{
            e.preventDefault();
            const deltaX=e.clientX-resizing.startX;
            const task=tasks.find(t=>t.id===resizing.taskId);
            if(!task)return;

            // Calculate pixels per day based on zoom
            const currentColWidth=zoom==='quarter'?280:zoom==='week'?40:zoom==='day'?60:100;
            let pixelsPerDay;
            if(zoom==='day'){
                pixelsPerDay=currentColWidth; // 60px per day
            }else if(zoom==='week'){
                pixelsPerDay=currentColWidth/7; // 40px / 7 days
            }else if(zoom==='month'){
                // For month view, calculate precise pixels per day
                const avgDaysInMonth=30;
                pixelsPerDay=currentColWidth/avgDaysInMonth;
            }else if(zoom==='quarter'){
                // For quarter view: 280px per quarter, 3 months per quarter, ~30 days per month
                pixelsPerDay=currentColWidth/(3*30); // ~3.1px per day
            }else{
                pixelsPerDay=1;
            }

            // Calculate days moved with smart snap-to-grid
            let daysMoved;
            if(zoom==='week'){
                // Snap to day boundaries in week view
                daysMoved=Math.round(deltaX/pixelsPerDay);
            }else if(zoom==='month'){
                // Smart snap in month view: detect if near month boundaries
                const daysMovedRaw=deltaX/pixelsPerDay;
                const originalDate=resizing.handle==='left'?new Date(resizing.originalStart):new Date(resizing.originalEnd);
                const newDate=new Date(originalDate);
                newDate.setDate(newDate.getDate()+Math.round(daysMovedRaw));

                // Check if near start or end of month (within 5 days - increased threshold)
                const dayOfMonth=newDate.getDate();
                const daysInMonth=new Date(newDate.getFullYear(),newDate.getMonth()+1,0).getDate();
                const snapThreshold=5; // Increased from 3 to 5 days

                if(dayOfMonth<=snapThreshold){
                    // Near start of month - snap to day 1
                    daysMoved=Math.round(daysMovedRaw)-(dayOfMonth-1);
                }else if(dayOfMonth>=daysInMonth-snapThreshold){
                    // Near end of month - snap to last day
                    daysMoved=Math.round(daysMovedRaw)+(daysInMonth-dayOfMonth);
                }else{
                    // Normal snap to nearest day
                    daysMoved=Math.round(daysMovedRaw);
                }
            }else{
                daysMoved=Math.round(deltaX/pixelsPerDay);
            }

            if(daysMoved===0)return;

            const originalStart=new Date(resizing.originalStart);
            const originalEnd=new Date(resizing.originalEnd);
            let newStart=resizing.originalStart;
            let newEnd=resizing.originalEnd;

            if(resizing.handle==='left'){
                const newStartDate=new Date(originalStart);
                newStartDate.setDate(newStartDate.getDate()+daysMoved);
                if(newStartDate.getTime()<originalEnd.getTime()){
                    newStart=newStartDate.toISOString().split('T')[0];
                }
            }else{
                const newEndDate=new Date(originalEnd);
                newEndDate.setDate(newEndDate.getDate()+daysMoved);
                if(newEndDate.getTime()>originalStart.getTime()){
                    newEnd=newEndDate.toISOString().split('T')[0];
                }
            }

            if(newStart!==task.startDate||newEnd!==task.dueDate){
                onUpdateTask(resizing.taskId,{startDate:newStart,dueDate:newEnd});
            }
        };

        const handleGlobalMouseUp=()=>{
            endResize();
        };

        const handleGlobalTouchMove=(e)=>{
            e.preventDefault();
            const deltaX=e.touches[0].clientX-resizing.startX;
            const task=tasks.find(t=>t.id===resizing.taskId);
            if(!task)return;

            // Calculate pixels per day based on zoom
            const currentColWidth=zoom==='quarter'?280:zoom==='week'?40:zoom==='day'?60:100;
            let pixelsPerDay;
            if(zoom==='day'){
                pixelsPerDay=currentColWidth; // 60px per day
            }else if(zoom==='week'){
                pixelsPerDay=currentColWidth/7; // 40px / 7 days
            }else if(zoom==='month'){
                // For month view, calculate precise pixels per day
                const avgDaysInMonth=30;
                pixelsPerDay=currentColWidth/avgDaysInMonth;
            }else if(zoom==='quarter'){
                // For quarter view: 280px per quarter, 3 months per quarter, ~30 days per month
                pixelsPerDay=currentColWidth/(3*30); // ~3.1px per day
            }else{
                pixelsPerDay=1;
            }

            // Calculate days moved with smart snap-to-grid
            let daysMoved;
            if(zoom==='week'){
                // Snap to day boundaries in week view
                daysMoved=Math.round(deltaX/pixelsPerDay);
            }else if(zoom==='month'){
                // Smart snap in month view: detect if near month boundaries
                const daysMovedRaw=deltaX/pixelsPerDay;
                const originalDate=resizing.handle==='left'?new Date(resizing.originalStart):new Date(resizing.originalEnd);
                const newDate=new Date(originalDate);
                newDate.setDate(newDate.getDate()+Math.round(daysMovedRaw));

                // Check if near start or end of month (within 5 days - increased threshold)
                const dayOfMonth=newDate.getDate();
                const daysInMonth=new Date(newDate.getFullYear(),newDate.getMonth()+1,0).getDate();
                const snapThreshold=5; // Increased from 3 to 5 days

                if(dayOfMonth<=snapThreshold){
                    // Near start of month - snap to day 1
                    daysMoved=Math.round(daysMovedRaw)-(dayOfMonth-1);
                }else if(dayOfMonth>=daysInMonth-snapThreshold){
                    // Near end of month - snap to last day
                    daysMoved=Math.round(daysMovedRaw)+(daysInMonth-dayOfMonth);
                }else{
                    // Normal snap to nearest day
                    daysMoved=Math.round(daysMovedRaw);
                }
            }else{
                daysMoved=Math.round(deltaX/pixelsPerDay);
            }

            if(daysMoved===0)return;

            const originalStart=new Date(resizing.originalStart);
            const originalEnd=new Date(resizing.originalEnd);
            let newStart=resizing.originalStart;
            let newEnd=resizing.originalEnd;

            if(resizing.handle==='left'){
                const newStartDate=new Date(originalStart);
                newStartDate.setDate(newStartDate.getDate()+daysMoved);
                if(newStartDate.getTime()<originalEnd.getTime()){
                    newStart=newStartDate.toISOString().split('T')[0];
                }
            }else{
                const newEndDate=new Date(originalEnd);
                newEndDate.setDate(newEndDate.getDate()+daysMoved);
                if(newEndDate.getTime()>originalStart.getTime()){
                    newEnd=newEndDate.toISOString().split('T')[0];
                }
            }

            if(newStart!==task.startDate||newEnd!==task.dueDate){
                onUpdateTask(resizing.taskId,{startDate:newStart,dueDate:newEnd});
            }
        };

        const handleGlobalTouchEnd=()=>{
            endResize();
        };

        document.addEventListener('mousemove',handleGlobalMouseMove);
        document.addEventListener('mouseup',handleGlobalMouseUp);
        document.addEventListener('touchmove',handleGlobalTouchMove,{passive:false});
        document.addEventListener('touchend',handleGlobalTouchEnd);

        return()=>{
            document.removeEventListener('mousemove',handleGlobalMouseMove);
            document.removeEventListener('mouseup',handleGlobalMouseUp);
            document.removeEventListener('touchmove',handleGlobalTouchMove);
            document.removeEventListener('touchend',handleGlobalTouchEnd);
        };
    },[resizing,tasks,onUpdateTask,zoom,endResize]);

    // Drag & Drop handlers for horizontal drag (date change)
    const handleTaskDragStart=(e,task)=>{
        // Don't start drag if we're resizing
        if(resizing){
            e.preventDefault();
            return;
        }
        e.stopPropagation();
        e.dataTransfer.effectAllowed='move';
        e.dataTransfer.setData('taskId',task.id);
        e.dataTransfer.setData('text/plain',task.id); // Fallback for compatibility

        // Use minimal invisible ghost ‚Äî the preview line is the real indicator
        const ghost=document.createElement('div');
        ghost.style.cssText='position:absolute;top:-1000px;width:1px;height:1px;opacity:0.01;';
        document.body.appendChild(ghost);
        e.dataTransfer.setDragImage(ghost,0,0);
        setTimeout(()=>document.body.removeChild(ghost),0);
        const pos=getTaskPosition(task);
        const grabOffset=e.clientX-e.currentTarget.getBoundingClientRect().left;

        setDragging({taskId:task.id,task:task,startX:e.clientX,startY:e.clientY,originalLeft:pos?.left||0,grabOffset:grabOffset||0});
        e.currentTarget.classList.add('dragging');
    };

    const handleTaskDragEnd=(e)=>{
        e.currentTarget.classList.remove('dragging');
        setDragging(null);
        setDragOverTask(null);
        setDragOverActionRow(null);
        setDragPreview(null);
        setDropIndicator(null);
    };

    const handleTaskDragOver=(e,task)=>{
        e.preventDefault();
        // If this is the task being dragged, let event bubble to action row
        if(dragging&&dragging.taskId===task.id)return;
        e.stopPropagation();

        // Determine if drag is in top or bottom half of task
        const rect=e.currentTarget.getBoundingClientRect();
        const midY=rect.top+rect.height/2;
        const position=e.clientY<midY?'before':'after';
        setDragOverTask({taskId:task.id,position});
    };

    const handleTaskDragLeave=(e)=>{
        // If this is the task being dragged, let event bubble
        if(dragging&&e.currentTarget.classList.contains('dragging'))return;
        e.stopPropagation();
        setDragOverTask(null);
    };

    const handleTaskDrop=(e,targetTask)=>{
        // If dropping on the task being dragged, let event bubble to action row
        if(dragging&&dragging.taskId===targetTask.id)return;
        e.preventDefault();
        e.stopPropagation();
        const draggedId=e.dataTransfer.getData('taskId');
        if(!draggedId||draggedId===targetTask.id){
            setDragOverTask(null);
            return;
        }

        const draggedTask=tasks.find(t=>t.id===draggedId);
        if(!draggedTask||!targetTask)return;

        // If tasks are in the same action, reorder them
        if(draggedTask.actionId===targetTask.actionId){
            // Get all tasks in this action sorted by order
            const actionTasks=tasks.filter(t=>t.actionId===targetTask.actionId).sort((a,b)=>(a.order||0)-(b.order||0));
            const draggedIndex=actionTasks.findIndex(t=>t.id===draggedId);
            const targetIndex=actionTasks.findIndex(t=>t.id===targetTask.id);

            if(draggedIndex!==-1&&targetIndex!==-1){
                // Reorder
                const reordered=[...actionTasks];
                const[removed]=reordered.splice(draggedIndex,1);
                const insertIndex=dragOverTask?.position==='before'?targetIndex:targetIndex+1;
                const adjustedIndex=draggedIndex<targetIndex?insertIndex-1:insertIndex;
                reordered.splice(adjustedIndex,0,removed);

                // Update order property
                const updates=reordered.map((t,idx)=>({id:t.id,order:idx}));
                updates.forEach(({id,order})=>onUpdateTask(id,{order}));
            }
        }else{
            // Move task to different action - preserve start/due dates
            onUpdateTask(draggedId,{
                actionId:targetTask.actionId,
                order:targetTask.order||0,
                startDate:draggedTask.startDate,
                dueDate:draggedTask.dueDate
            });
        }

        setDragOverTask(null);
    };

    // Drag & Drop handlers for actions
    const handleActionDragOver=(e,action)=>{
        if(!onReorderAction)return;

        // Check if this is an action drag (not a task drag)
        // We check for 'actionid' in types (HTML5 DnD normalizes to lowercase)
        const types=Array.from(e.dataTransfer.types||[]).map(t=>t.toLowerCase());
        const hasActionId=types.includes('actionid');

        if(!hasActionId){
            return; // This is a task drag, ignore it
        }

        e.preventDefault();
        e.stopPropagation();

        // Determine if drag is in top or bottom half of action row
        const rect=e.currentTarget.getBoundingClientRect();
        const midY=rect.top+rect.height/2;
        const position=e.clientY<midY?'before':'after';
        setDragOverAction({actionId:action.id,position});
    };

    const handleActionDragLeave=(e)=>{
        e.stopPropagation();
        // Only clear if we're actually leaving the action row
        const relatedTarget=e.relatedTarget;
        if(!relatedTarget||!e.currentTarget.contains(relatedTarget)){
            setDragOverAction(null);
        }
    };

    const handleActionDrop=(e,targetAction)=>{
        // Check if this is an action drag (not a task drag)
        // We check for 'actionid' in types (HTML5 DnD normalizes to lowercase)
        const types=Array.from(e.dataTransfer.types||[]).map(t=>t.toLowerCase());
        const hasActionId=types.includes('actionid');

        if(!hasActionId){
            return; // This is a task drag, let it be handled by task handlers
        }

        e.preventDefault();
        e.stopPropagation();

        // Only handle action drops, not task drops
        const draggedId=e.dataTransfer.getData('actionId');
        if(!draggedId){
            return;
        }

        if(draggedId===targetAction.id){
            setDragOverAction(null);
            return;
        }

        if(onReorderAction&&dragOverAction){
            onReorderAction(draggedId,targetAction.id,dragOverAction.position);
        }

        setDragOverAction(null);
    };

    const getWeekNumber=(date)=>{
        const diff=date-weekBase;
        return Math.floor(diff/(7*24*60*60*1000));
    };

    const getTaskPosition=(task)=>{
        if(!task.startDate||!task.dueDate)return null;
        const start=new Date(task.startDate);
        const end=new Date(task.dueDate);
        const startMonth=start.getMonth();
        const endMonth=end.getMonth();
        const startDay=start.getDate();
        const endDay=end.getDate();
        const daysInStartMonth=new Date(selectedYear,startMonth+1,0).getDate();
        const daysInEndMonth=new Date(selectedYear,endMonth+1,0).getDate();

        if(zoom==='day'){
            // Calculate day index from start of year (0-364)
            const startDayOfYear=Math.floor((start-new Date(selectedYear,0,1))/(1000*60*60*24));
            const endDayOfYear=Math.floor((end-new Date(selectedYear,0,1))/(1000*60*60*24));
            const left=startDayOfYear*colWidth;
            const width=Math.max((endDayOfYear-startDayOfYear+1)*colWidth,colWidth); // At least 1 day width
            return{left,width};
        }
        if(zoom==='week'){
            // Calculate precise positioning based on days from weekBase (Monday-aligned)
            const startDaysFromBase=Math.floor((start-weekBase)/(1000*60*60*24));
            const endDaysFromBase=Math.floor((end-weekBase)/(1000*60*60*24));
            const pixelsPerDay=colWidth/7;
            const left=startDaysFromBase*pixelsPerDay;
            const width=Math.max((endDaysFromBase-startDaysFromBase+1)*pixelsPerDay,pixelsPerDay);
            return{left,width};
        }
        if(zoom==='month'){
            const startOffset=((startDay-1)/daysInStartMonth)*colWidth; // -1 for 0-indexed
            const totalMonths=endMonth-startMonth;
            const endOffset=((daysInEndMonth-endDay)/daysInEndMonth)*colWidth;
            const width=(totalMonths+1)*colWidth-startOffset-endOffset;
            const minWidth=(1/daysInStartMonth)*colWidth; // At least 1 day width proportional to month
            return{left:startMonth*colWidth+startOffset,width:Math.max(width,minWidth)};
        }
        if(zoom==='quarter'){
            // Calculate position within quarter view
            // Each quarter is colWidth (280px), containing 3 months
            const startQuarter=Math.floor(startMonth/3);
            const endQuarter=Math.floor(endMonth/3);
            const quarterWidth=colWidth; // 280px per quarter
            const monthWidthInQuarter=quarterWidth/3; // ~93px per month

            // Calculate start position
            const monthInStartQuarter=startMonth%3;
            const daysInMonth=new Date(selectedYear,startMonth+1,0).getDate();
            const dayOffset=(startDay-1)/daysInMonth; // 0-1 within the month
            const startOffset=monthInStartQuarter*monthWidthInQuarter+dayOffset*monthWidthInQuarter;
            const left=startQuarter*quarterWidth+startOffset;

            // Calculate width
            const totalQuarters=endQuarter-startQuarter;
            const monthInEndQuarter=endMonth%3;
            const daysInEndMonth=new Date(selectedYear,endMonth+1,0).getDate();
            const endDayOffset=endDay/daysInEndMonth; // 0-1 within the month
            const endOffset=monthInEndQuarter*monthWidthInQuarter+endDayOffset*monthWidthInQuarter;

            let width;
            if(totalQuarters===0){
                // Same quarter
                width=endOffset-startOffset;
            }else{
                // Spans multiple quarters
                width=(totalQuarters+1)*quarterWidth-startOffset-(quarterWidth-endOffset);
            }

            const minWidth=monthWidthInQuarter/30; // At least 1 day width
            return{left,width:Math.max(width,minWidth)};
        }
        return{left:startMonth*colWidth,width:colWidth};
    };

    // Calculate swim lanes for overlapping tasks
    const calculateSwimLanes=(tasks)=>{
        const swimLanes={};
        const lanes=[];

        // Sort tasks by start date
        const sortedTasks=[...tasks].sort((a,b)=>{
            if(!a.startDate||!b.startDate)return 0;
            return new Date(a.startDate)-new Date(b.startDate);
        });

        sortedTasks.forEach(task=>{
            if(!task.startDate||!task.dueDate){
                swimLanes[task.id]=0;
                return;
            }

            const pos=getTaskPosition(task);
            if(!pos){
                swimLanes[task.id]=0;
                return;
            }

            const taskStart=pos.left;
            const taskEnd=pos.left+pos.width;

            // Find first available lane where this task doesn't overlap
            let assignedLane=-1;
            for(let i=0;i<lanes.length;i++){
                let canFit=true;
                for(const existingTask of lanes[i]){
                    if(taskStart<existingTask.end&&taskEnd>existingTask.start){
                        canFit=false;
                        break;
                    }
                }
                if(canFit){
                    assignedLane=i;
                    lanes[i].push({id:task.id,start:taskStart,end:taskEnd});
                    break;
                }
            }

            // No existing lane can fit this task ‚Äî create a new one
            if(assignedLane===-1){
                assignedLane=lanes.length;
                lanes.push([{id:task.id,start:taskStart,end:taskEnd}]);
            }

            swimLanes[task.id]=assignedLane;
        });

        const maxLanes=lanes.length;
        return{swimLanes,maxLanes:Math.max(maxLanes,1)};
    };

    // Shared pixel<->date conversion (used by both preview and drop for perfect consistency)
    const dateToPixel=(d)=>{
        const m=d.getMonth();const day=d.getDate();
        const dim=new Date(selectedYear,m+1,0).getDate();
        if(zoom==='day'){
            const doy=Math.floor((d-new Date(selectedYear,0,1))/(86400000));
            return doy*colWidth;
        }else if(zoom==='week'){
            const daysFromBase=Math.floor((d-weekBase)/(86400000));
            return daysFromBase*(colWidth/7);
        }else if(zoom==='month'){
            return m*colWidth+((day-1)/dim)*colWidth;
        }else{
            const q=Math.floor(m/3);const miq=m%3;const mw=colWidth/3;
            return q*colWidth+miq*mw+((day-1)/dim)*mw;
        }
    };

    const pixelToDate=(absX)=>{
        const year=selectedYear;
        if(zoom==='day'){
            const dayIdx=Math.round(absX/colWidth);
            return new Date(year,0,1+Math.max(0,dayIdx));
        }else if(zoom==='week'){
            const pixelsPerDay=colWidth/7;
            const dayIdx=Math.round(absX/pixelsPerDay);
            // Snap to week boundary (Monday) if very close (within 1 day)
            const nearestWeekDay=Math.round(dayIdx/7)*7;
            const snappedDay=Math.abs(dayIdx-nearestWeekDay)<=1?nearestWeekDay:dayIdx;
            return new Date(weekBase.getTime()+Math.max(0,snappedDay)*86400000);
        }else if(zoom==='month'){
            const monthIdx=Math.max(0,Math.min(11,Math.floor(absX/colWidth)));
            const monthFrac=Math.max(0,(absX-monthIdx*colWidth)/colWidth);
            const dim=new Date(year,monthIdx+1,0).getDate();
            const day=Math.max(1,Math.round(monthFrac*dim));
            return new Date(year,monthIdx,day);
        }else{
            const qIdx=Math.max(0,Math.min(3,Math.floor(absX/colWidth)));
            const qFrac=Math.max(0,(absX-qIdx*colWidth)/colWidth);
            const miq=Math.min(2,Math.floor(qFrac*3));
            const mFrac=(qFrac*3)-miq;
            const targetMonth=qIdx*3+miq;
            const dim=new Date(year,targetMonth+1,0).getDate();
            const day=Math.max(1,Math.round(mFrac*dim));
            return new Date(year,targetMonth,Math.min(day,dim));
        }
    };

    const getDayHeaders=()=>{
        const days=[];
        const months=[];
        let currentMonth=-1;
        let dayCounter=0;
        for(let m=0;m<12;m++){
            const daysInMonth=new Date(selectedYear,m+1,0).getDate();
            const monthStart=dayCounter;
            for(let d=1;d<=daysInMonth;d++){
                days.push({day:dayCounter,date:d,month:m,label:d.toString()});
                dayCounter++;
            }
            months.push({month:m,label:CONFIG.MONTHS[m],startDay:monthStart,endDay:dayCounter-1,days:daysInMonth});
        }
        return{days,months};
    };

    const getWeekHeaders=()=>{
        const weeks=[];
        const months=[];
        const dec31=new Date(selectedYear,11,31);
        let lastMonth=-1;
        for(let w=0;w<54;w++){
            const weekStart=new Date(weekBase.getTime()+w*7*86400000);
            if(weekStart>dec31)break;
            // ISO week number for label
            const thu=new Date(weekStart.getTime()+3*86400000);
            const isoD=new Date(Date.UTC(thu.getFullYear(),thu.getMonth(),thu.getDate()));
            isoD.setUTCDate(isoD.getUTCDate()+4-(isoD.getUTCDay()||7));
            const isoYS=new Date(Date.UTC(isoD.getUTCFullYear(),0,1));
            const isoWeek=Math.ceil(((isoD-isoYS)/86400000+1)/7);
            weeks.push({week:w,label:isoWeek.toString()});
            // Month grouping: use Monday date, but assign to Jan if in previous year
            const monthIdx=weekStart.getFullYear()<selectedYear?0:weekStart.getMonth();
            if(monthIdx!==lastMonth){
                if(months.length>0)months[months.length-1].endWeek=w;
                months.push({month:monthIdx,label:CONFIG.MONTHS[monthIdx],startWeek:w,endWeek:w+1});
                lastMonth=monthIdx;
            }
        }
        if(months.length>0)months[months.length-1].endWeek=weeks.length;
        return{weeks,months};
    };

    const headers=zoom==='quarter'?[{q:1,label:'Q1',months:[0,1,2]},{q:2,label:'Q2',months:[3,4,5]},{q:3,label:'Q3',months:[6,7,8]},{q:4,label:'Q4',months:[9,10,11]}]:zoom==='week'?getWeekHeaders().weeks:zoom==='day'?getDayHeaders().days:CONFIG.MONTHS.map((m,i)=>({month:i,label:m}));
    const monthHeaders=zoom==='week'?getWeekHeaders().months:zoom==='day'?getDayHeaders().months:null;

    const filteredTasks=tasks.filter(t=>{
        const action=actions.find(a=>a.id===t.actionId);
        if(selectedYear){
            const taskStartYear=t.startDate?new Date(t.startDate).getFullYear():null;
            const taskEndYear=t.dueDate?new Date(t.dueDate).getFullYear():null;
            // Show task if its date range overlaps the selected year
            if(taskStartYear&&taskStartYear>selectedYear)return false;
            if(taskEndYear&&taskEndYear<selectedYear)return false;
            if(taskStartYear&&!taskEndYear&&taskStartYear!==selectedYear)return false;
        }
        if(filters?.search&&!t.title.toLowerCase().includes(filters.search.toLowerCase()))return false;
        if(filters?.status.length>0&&!filters.status.includes(t.status))return false;
        if(filters?.priority.length>0&&!filters.priority.includes(t.priority))return false;
        if(filters?.category.length>0&&action&&!filters.category.includes(action.categoryId))return false;
        if(filters?.channel.length>0){
            const taskChannels=t.channels||action?.tags||[];
            if(!filters.channel.some(c=>taskChannels.includes(c)))return false;
        }
        if(filters?.country&&filters.country.length>0){
            const taskCountries=t.countries||[];
            if(!filters.country.some(c=>taskCountries.includes(c)))return false;
        }
        return true;
    });

    const groupedByCategory=categories.map(cat=>{
        const catActions=actions.filter(a=>a.categoryId===cat.id).map(action=>({action,tasks:filteredTasks.filter(t=>t.actionId===action.id)})).filter(({tasks:t})=>t.length>0);
        return{category:cat,actions:catActions};
    }).filter(g=>g.actions.length>0);
    const scrollToQuarter=(q)=>{if(timelineRef.current)timelineRef.current.scrollLeft=(q-1)*3*colWidth;};

    const handleDrop=(e,colIdx)=>{
        e.preventDefault();e.currentTarget.classList.remove('drag-over');
        const taskId=e.dataTransfer.getData('taskId');
        if(taskId&&onUpdateTask){
            const task=tasks.find(t=>t.id===taskId);
            if(!task)return;

            const year=selectedYear;

            // Calculate task duration in days
            let duration=1; // default 1 day
            if(task.startDate&&task.dueDate){
                const oldStart=new Date(task.startDate);
                const oldEnd=new Date(task.dueDate);
                duration=Math.max(1,Math.ceil((oldEnd-oldStart)/(1000*60*60*24))+1);
            }

            // Get position within column based on mouse position
            const rect=e.currentTarget.getBoundingClientRect();
            const relativeX=e.clientX-rect.left;
            let percentage=relativeX/rect.width;

            let startDate,dueDate;

            if(zoom==='week'){
                // For week view: snap to half-day boundaries for better precision (14 slots per week)
                const weekNumber=colIdx;

                // Calculate which half-day of the week based on percentage
                // 7 days * 2 half-days = 14 slots per week
                let halfDaySlot=Math.round(percentage*14);

                // Clamp to valid range [0-13] and ensure task fits in week
                const durationInHalfDays=duration*2;
                halfDaySlot=Math.max(0,Math.min(14-durationInHalfDays,halfDaySlot));

                // Convert half-day slot to day
                const dayOfWeek=Math.floor(halfDaySlot/2);

                // Calculate the actual date (from Monday-aligned weekBase)
                const daysOffset=weekNumber*7+dayOfWeek;
                const newStartDate=new Date(weekBase.getTime()+daysOffset*86400000);

                // Calculate end date
                const newEndDate=new Date(newStartDate);
                newEndDate.setDate(newEndDate.getDate()+duration-1);

                startDate=newStartDate.getFullYear()+'-'+String(newStartDate.getMonth()+1).padStart(2,'0')+'-'+String(newStartDate.getDate()).padStart(2,'0');
                dueDate=newEndDate.getFullYear()+'-'+String(newEndDate.getMonth()+1).padStart(2,'0')+'-'+String(newEndDate.getDate()).padStart(2,'0');

            }else if(zoom==='day'){
                // For day view: direct day-to-day placement (always snaps to full days)
                const dayOfYear=colIdx; // colIdx is the day index (0-364)

                // Calculate the actual date
                const newStartDate=new Date(year,0,1+dayOfYear);

                // Calculate end date
                const newEndDate=new Date(newStartDate);
                newEndDate.setDate(newEndDate.getDate()+duration-1);

                startDate=newStartDate.getFullYear()+'-'+String(newStartDate.getMonth()+1).padStart(2,'0')+'-'+String(newStartDate.getDate()).padStart(2,'0');
                dueDate=newEndDate.getFullYear()+'-'+String(newEndDate.getMonth()+1).padStart(2,'0')+'-'+String(newEndDate.getDate()).padStart(2,'0');

            }else if(zoom==='month'){
                // For month view: snap to full days (daily precision)
                const monthIdx=colIdx;
                const daysInMonth=new Date(year,monthIdx+1,0).getDate();

                // Calculate target day based on percentage - always round to nearest full day
                let targetDay=Math.round(percentage*daysInMonth);
                targetDay=Math.max(1,Math.min(daysInMonth,targetDay));

                // Ensure task fits within available space
                let startDay=Math.max(1,Math.min(daysInMonth-duration+1,targetDay));

                startDate=year+'-'+String(monthIdx+1).padStart(2,'0')+'-'+String(startDay).padStart(2,'0');

                // Calculate end date
                const newStartDate=new Date(year,monthIdx,startDay);
                const newEndDate=new Date(newStartDate);
                newEndDate.setDate(newEndDate.getDate()+duration-1);

                const endMonth=newEndDate.getMonth();
                const endDay=newEndDate.getDate();
                dueDate=year+'-'+String(endMonth+1).padStart(2,'0')+'-'+String(endDay).padStart(2,'0');

            }else{
                // Quarter view: colIdx is quarter index (0-3)
                const quarterIdx=colIdx;
                const firstMonthOfQuarter=quarterIdx*3;

                let monthIdx,monthPercentage;

                if(percentage===0){
                    monthIdx=firstMonthOfQuarter;
                    monthPercentage=0;
                }else if(percentage===1){
                    monthIdx=firstMonthOfQuarter+2;
                    monthPercentage=1;
                }else if(percentage===0.5){
                    monthIdx=firstMonthOfQuarter+1;
                    monthPercentage=0.5;
                }else{
                    // Determine which month within the quarter based on percentage
                    let monthInQuarter=Math.floor(percentage*3);
                    if(monthInQuarter>2)monthInQuarter=2;
                    monthIdx=firstMonthOfQuarter+monthInQuarter;
                    monthPercentage=(percentage*3)%1;
                }

                const daysInMonth=new Date(year,monthIdx+1,0).getDate();
                let startDay;

                if(monthPercentage===0){
                    startDay=1;
                }else if(monthPercentage===1){
                    startDay=Math.max(1,daysInMonth-duration+1);
                }else if(monthPercentage===0.5){
                    startDay=Math.max(1,Math.min(daysInMonth-duration+1,Math.floor((daysInMonth-duration+1)/2)+1));
                }else{
                    startDay=Math.max(1,Math.min(daysInMonth-duration+1,Math.round(monthPercentage*daysInMonth)));
                }

                startDate=year+'-'+String(monthIdx+1).padStart(2,'0')+'-'+String(startDay).padStart(2,'0');

                const newStartDate=new Date(year,monthIdx,startDay);
                const newEndDate=new Date(newStartDate);
                newEndDate.setDate(newEndDate.getDate()+duration-1);

                const endMonth=newEndDate.getMonth();
                const endDay=newEndDate.getDate();
                dueDate=year+'-'+String(endMonth+1).padStart(2,'0')+'-'+String(endDay).padStart(2,'0');
            }

            onUpdateTask(taskId,{startDate,dueDate});
        }
    };
    const handleDragOver=(e)=>{e.preventDefault();e.currentTarget.classList.add('drag-over');};
    const handleDragLeave=(e)=>{e.currentTarget.classList.remove('drag-over');};

    // Handler for dropping a task into an action row ‚Äî uses same pixelToDate as preview for perfect match
    const handleActionRowDrop=(e,targetAction)=>{
        e.preventDefault();
        e.stopPropagation();

        setDragOverActionRow(null);
        setDragPreview(null);
        setDropIndicator(null);

        const taskId=e.dataTransfer.getData('taskId');
        if(!taskId||!onUpdateTask)return;

        const draggedTask=tasks.find(t=>t.id===taskId);
        if(!draggedTask)return;

        const rect=e.currentTarget.getBoundingClientRect();
        // getBoundingClientRect already accounts for parent scroll ‚Äî no scrollOffset needed
        const absX=e.clientX-rect.left;

        let duration=1;
        if(draggedTask.startDate&&draggedTask.dueDate){
            const oldStart=new Date(draggedTask.startDate);
            const oldEnd=new Date(draggedTask.dueDate);
            duration=Math.max(1,Math.ceil((oldEnd-oldStart)/(1000*60*60*24))+1);
        }

        // Apply grab offset ‚Äî same logic as preview for exact match
        const adjustedX=absX-(dragging?.grabOffset||0);
        const snapDate=pixelToDate(adjustedX);

        const endDate=new Date(snapDate);
        endDate.setDate(endDate.getDate()+duration-1);

        const fmt=(d)=>d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
        const startDate=fmt(snapDate);
        const dueDate=fmt(endDate);

        if(draggedTask.actionId===targetAction.id){
            onUpdateTask(taskId,{startDate,dueDate});
        }else{
            const actionTasks=tasks.filter(t=>t.actionId===targetAction.id);
            const maxOrder=actionTasks.length>0?Math.max(...actionTasks.map(t=>t.order||0)):0;
            onUpdateTask(taskId,{actionId:targetAction.id,order:maxOrder+1,startDate,dueDate});
        }
    };

    const handleActionRowDragOver=(e,targetAction)=>{
        e.preventDefault();
        e.stopPropagation();

        const types=Array.from(e.dataTransfer.types||[]).map(t=>t.toLowerCase());
        const hasActionId=types.includes('actionid');
        const hasTaskId=types.includes('taskid');

        if(hasActionId||!hasTaskId){return;}

        setDragOverActionRow(targetAction.id);

        if(dragging&&dragging.task){
            const rect=e.currentTarget.getBoundingClientRect();
            // getBoundingClientRect already accounts for parent scroll ‚Äî no scrollOffset needed
            const absX=e.clientX-rect.left;
            const task=dragging.task;

            if(task.startDate&&task.dueDate){
                const oldStart=new Date(task.startDate);
                const oldEnd=new Date(task.dueDate);
                const duration=Math.max(1,Math.ceil((oldEnd-oldStart)/(1000*60*60*24))+1);

                // Apply grab offset so the task stays "attached" at the grab point
                const adjustedX=absX-(dragging.grabOffset||0);
                const snapDate=pixelToDate(adjustedX);

                const endDate=new Date(snapDate);
                endDate.setDate(endDate.getDate()+duration-1);

                const dayAfterEnd=new Date(endDate);
                dayAfterEnd.setDate(dayAfterEnd.getDate()+1);
                const previewLeft=dateToPixel(snapDate);
                const previewWidth=Math.max(dateToPixel(dayAfterEnd)-previewLeft,20);

                // Calculate swim lane ‚Äî find free lane among RENDERED task positions (not recalculated)
                const actionTasksAll=filteredTasks.filter(t=>t.actionId===targetAction.id);
                const renderedLanes=calculateSwimLanes(actionTasksAll);
                let previewLane=0;
                for(let lane=0;lane<20;lane++){
                    let canFit=true;
                    for(const t of actionTasksAll){
                        if(t.id===task.id)continue;
                        if((renderedLanes.swimLanes[t.id]||0)!==lane)continue;
                        const tPos=getTaskPosition(t);
                        if(!tPos)continue;
                        if(previewLeft<tPos.left+tPos.width&&previewLeft+previewWidth>tPos.left){canFit=false;break;}
                    }
                    if(canFit){previewLane=lane;break;}
                }
                const previewTop=8+previewLane*34;

                // Get task bar color for preview
                const channels=task.channels||actions.find(a=>a.id===task.actionId)?.tags||[];
                const mainCh=channels[0]||'';
                const chColors={social:'#60a5fa',gads:'#fbbf24',lads:'#818cf8',events:'#f472b6',seo:'#4ade80',press:'#c4b5fd',email:'#fbbf24',web:'#818cf8',video:'#f87171',lp:'#2dd4bf',ia:'#c4b5fd',auto:'#fb923c'};
                const barColor=chColors[mainCh]||CONFIG.STATUSES.find(s=>s.id===task.status)?.color||'#94a3b8';

                setDragPreview({left:previewLeft,width:previewWidth,top:previewTop,actionId:targetAction.id,color:barColor});
                setDropIndicator({left:previewLeft,actionId:targetAction.id});
            }
        }
    };

    const handleActionRowDragLeave=(e,targetAction)=>{
        const relatedTarget=e.relatedTarget;
        if(!relatedTarget||!e.currentTarget.contains(relatedTarget)){
            if(dragOverActionRow===targetAction.id){
                setDragOverActionRow(null);
                setDragPreview(null);
                setDropIndicator(null);
            }
        }
    };

    // Task creation handlers
    const handleCreateTaskStart=(e,action)=>{
        // Don't start if clicking on an existing task or if space is pressed
        if(e.target.closest('.timeline-bar')||spacePressed||resizing||dragging)return;

        const rect=e.currentTarget.getBoundingClientRect();
        const startX=e.clientX-rect.left;

        setCreatingTask({
            actionId:action.id,
            startX,
            currentX:startX,
            actionRow:e.currentTarget
        });
    };

    const createTaskAtPosition=(actionId,startX,endX)=>{
        const year=selectedYear;
        let startDate,dueDate;
        const fmt=(d)=>d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');

        // Calculate dates based on zoom and position
        if(zoom==='day'){
            const startDay=Math.floor(startX/colWidth);
            const endDay=Math.floor(endX/colWidth);
            startDate=fmt(new Date(year,0,1+startDay));
            dueDate=fmt(new Date(year,0,1+endDay));
        }else if(zoom==='week'){
            const pixelsPerDay=colWidth/7;
            const startDay=Math.floor(startX/pixelsPerDay);
            const endDay=Math.floor(endX/pixelsPerDay);
            startDate=fmt(new Date(weekBase.getTime()+startDay*86400000));
            dueDate=fmt(new Date(weekBase.getTime()+endDay*86400000));
        }else if(zoom==='month'){
            const startMonth=Math.floor(startX/colWidth);
            const endMonth=Math.floor(endX/colWidth);
            const startMonthProgress=(startX%colWidth)/colWidth;
            const endMonthProgress=(endX%colWidth)/colWidth;

            const daysInStartMonth=new Date(year,startMonth+1,0).getDate();
            const daysInEndMonth=new Date(year,endMonth+1,0).getDate();
            const startDay=Math.max(1,Math.floor(startMonthProgress*daysInStartMonth)+1);
            const endDay=Math.max(1,Math.floor(endMonthProgress*daysInEndMonth)+1);

            startDate=`${year}-${String(startMonth+1).padStart(2,'0')}-${String(startDay).padStart(2,'0')}`;
            dueDate=`${year}-${String(endMonth+1).padStart(2,'0')}-${String(endDay).padStart(2,'0')}`;
        }else if(zoom==='quarter'){
            const startQuarter=Math.floor(startX/colWidth);
            const endQuarter=Math.floor(endX/colWidth);
            const startQuarterProgress=(startX%colWidth)/colWidth;
            const endQuarterProgress=(endX%colWidth)/colWidth;

            const startMonthInQuarter=Math.floor(startQuarterProgress*3);
            const endMonthInQuarter=Math.floor(endQuarterProgress*3);
            const startMonth=startQuarter*3+startMonthInQuarter;
            const endMonth=endQuarter*3+endMonthInQuarter;

            const startMonthProgress=(startQuarterProgress*3)%1;
            const endMonthProgress=(endQuarterProgress*3)%1;

            const daysInStartMonth=new Date(year,startMonth+1,0).getDate();
            const daysInEndMonth=new Date(year,endMonth+1,0).getDate();
            const startDay=Math.max(1,Math.floor(startMonthProgress*daysInStartMonth)+1);
            const endDay=Math.max(1,Math.floor(endMonthProgress*daysInEndMonth)+1);

            startDate=`${year}-${String(startMonth+1).padStart(2,'0')}-${String(startDay).padStart(2,'0')}`;
            dueDate=`${year}-${String(endMonth+1).padStart(2,'0')}-${String(endDay).padStart(2,'0')}`;
        }

        // Create the task with calculated dates
        if(onAddTask){
            onAddTask(actionId,startDate,dueDate);
        }
    };

    // Global mouse handlers for task creation
    useEffect(()=>{
        if(!creatingTask)return;

        const handleGlobalMouseMove=(e)=>{
            if(!creatingTask)return;
            const rect=creatingTask.actionRow.getBoundingClientRect();
            const currentX=Math.max(0,e.clientX-rect.left);
            setCreatingTask({...creatingTask,currentX});
        };

        const handleGlobalMouseUp=(e)=>{
            if(!creatingTask)return;
            const minDragDistance=30;
            const dragDistance=Math.abs(creatingTask.currentX-creatingTask.startX);

            // Only create task if drag distance is significant (prevent accidental clicks)
            if(dragDistance>=minDragDistance){
                const startX=Math.min(creatingTask.startX,creatingTask.currentX);
                const endX=Math.max(creatingTask.startX,creatingTask.currentX);
                createTaskAtPosition(creatingTask.actionId,startX,endX);
            }
            setCreatingTask(null);
        };

        document.addEventListener('mousemove',handleGlobalMouseMove);
        document.addEventListener('mouseup',handleGlobalMouseUp);

        return()=>{
            document.removeEventListener('mousemove',handleGlobalMouseMove);
            document.removeEventListener('mouseup',handleGlobalMouseUp);
        };
    },[creatingTask,colWidth]);

    return(
        <div className="animate-slide-in">
            <div className="timeline-container">
                <div className="timeline-header">
                    <div className="timeline-header-left">
                        <div className="view-btn-group">
                            {[{id:'week',label:'Semaine'},{id:'month',label:'Mois'},{id:'quarter',label:'Trimestre'}].map(z=>(
                                <button key={z.id} onClick={()=>handleZoomChange(z.id)} className={`view-btn ${zoom===z.id?'active':''}`}>{z.label}</button>
                            ))}
                        </div>
                        <div className="quarter-nav-group">
                            {[1,2,3,4].map(q=>(<button key={q} onClick={()=>scrollToQuarter(q)} className="quarter-btn">Q{q}</button>))}
                        </div>
                    </div>
                    <div className="timeline-nav">
                        <button className="timeline-nav-btn" onClick={()=>onYearChange&&onYearChange(selectedYear-1)}>‚óÄ</button>
                        <span className="timeline-current">{selectedYear}</span>
                        <button className="timeline-nav-btn" onClick={()=>onYearChange&&onYearChange(selectedYear+1)}>‚ñ∂</button>
                    </div>
                </div>
                <div ref={timelineRef} className={`overflow-x-scroll ${spacePressed?'cursor-grab':''} ${isPanning?'cursor-grabbing':''}`} style={{scrollbarWidth:'thin',overflowX:'scroll',flex:1,overflowY:'auto'}} onMouseDown={handleMouseDown} onMouseMove={handleMouseMove} onMouseUp={handleMouseUp} onMouseLeave={handleMouseUp}>
                    <div style={{minWidth:`${headers.length*colWidth+250}px`}}>
                        {(zoom==='week'||zoom==='day')&&monthHeaders&&(
                            <div className={`flex border-b border-[var(--border)] sticky top-0 z-40 bg-[var(--bg-primary)]`}>
                                <div className={`w-[250px] flex-shrink-0 sticky left-0 z-30 bg-[var(--bg-primary)]`}/>
                                {monthHeaders.map((m,idx)=>(
                                    <div key={idx} className={`flex-shrink-0 p-2 text-center font-semibold border-l border-[var(--border)] ${m.month===currentMonth?'bg-accent/10 text-accent':''}`} style={{width:zoom==='week'?(m.endWeek-m.startWeek)*colWidth:m.days*colWidth}}>
                                        {m.label}
                                    </div>
                                ))}
                            </div>
                        )}
                        <div className={`flex border-b border-[var(--border)] ${(zoom==='week'||zoom==='day')?'sticky top-[37px] z-30':'sticky top-0 z-40'} bg-[var(--bg-primary)]`}>
                            <div className={`w-[250px] flex-shrink-0 p-3 font-semibold text-sm sticky left-0 bg-[var(--bg-primary)] border-r border-[var(--border)]`}>Actions</div>
                            {zoom==='quarter'?headers.map(h=>(
                                <div key={h.q} className={`flex-shrink-0 p-3 text-center font-semibold border-l border-[var(--border)]`} style={{width:colWidth}}>
                                    <div>{h.label}</div>
                                    <div className="flex justify-around text-xs text-[var(--text-muted)] mt-1">{h.months.map(m=><span key={m}>{CONFIG.MONTHS[m]}</span>)}</div>
                                </div>
                            )):zoom==='week'?headers.map((h,i)=>(
                                <div key={i} className={`flex-shrink-0 p-1 text-center text-xs font-medium border-l border-[var(--border)] ${h.week===currentWeek?'bg-accent/10 text-accent':''}`} style={{width:colWidth}}>{h.label}</div>
                            )):zoom==='day'?headers.map((h,i)=>(
                                <div key={i} className={`flex-shrink-0 p-1 text-center text-xs font-medium border-l border-[var(--border)] ${h.month===currentMonth&&h.date===new Date().getDate()?'bg-accent/10 text-accent':''}`} style={{width:colWidth}}>{h.label}</div>
                            )):headers.map((h,i)=>(
                                <div key={i} className={`flex-shrink-0 p-2 text-center text-xs font-medium border-l border-[var(--border)] ${h.month===currentMonth?'bg-accent/10 text-accent':''}`} style={{width:colWidth}}>{h.label}</div>
                            ))}
                        </div>
                        {groupedByCategory.map(({category,actions:catActions})=>(
                            <div key={category.id}>
                                <div className="timeline-category-row flex" onDragOver={(e)=>{if(onUpdateAction){const types=Array.from(e.dataTransfer.types||[]).map(t=>t.toLowerCase());if(types.includes('actionid')){e.preventDefault();e.currentTarget.classList.add('drag-over');}}}} onDragLeave={(e)=>{e.currentTarget.classList.remove('drag-over');}} onDrop={(e)=>{const types=Array.from(e.dataTransfer.types||[]).map(t=>t.toLowerCase());if(types.includes('actionid')){e.preventDefault();e.currentTarget.classList.remove('drag-over');const actionId=e.dataTransfer.getData('actionId');if(actionId&&onUpdateAction){onUpdateAction(actionId,{categoryId:category.id});}}}}>
                                    <div className="w-[250px] flex-shrink-0 sticky left-0 z-30 flex items-center" style={{background:'var(--bg-secondary)'}}>
                                        <div style={{width:4,alignSelf:'stretch',background:category.color,flexShrink:0}}/>
                                        <div className="timeline-category-sidebar">
                                            <div className="timeline-category-name">{category.name}</div>
                                            <div className="timeline-category-count">{catActions.length} actions</div>
                                        </div>
                                    </div>
                                    <div className="flex-1" style={{background:'var(--bg-secondary)'}}/>
                                </div>
                                {catActions.sort((a,b)=>(a.action.order||0)-(b.action.order||0)).map(({action,tasks:actionTasks})=>{
                                    const isDragOverAction=dragOverAction?.actionId===action.id;
                                    const dragOverActionClass=isDragOverAction?(dragOverAction.position==='before'?'drop-indicator-before':'drop-indicator-after'):'';
                                    const{swimLanes,maxLanes}=calculateSwimLanes(actionTasks);
                                    const rowHeight=Math.max(48,maxLanes*34+16);
                                    return(
                                    <div key={action.id} onDragOver={(e)=>handleActionDragOver(e,action)} onDragLeave={handleActionDragLeave} onDrop={(e)=>handleActionDrop(e,action)} className={`flex group relative ${dragOverActionClass}`} style={{borderBottom:'1px solid var(--border-light)'}}>
                                        <div className="w-[250px] flex-shrink-0 relative sticky left-0 z-30 timeline-action-sidebar" style={{background:'var(--bg-primary)',borderRight:'1px solid var(--border)',cursor:onReorderAction?'grab':'pointer'}} draggable={!!onReorderAction} onDragStart={(e)=>{if(onReorderAction){e.stopPropagation();e.dataTransfer.effectAllowed='move';e.dataTransfer.setData('actionId',action.id);e.dataTransfer.setData('text/plain','action:'+action.id);e.currentTarget.classList.add('dragging');}}} onDragEnd={(e)=>{e.currentTarget.classList.remove('dragging');setDragOverAction(null);}} onClick={(e)=>{if(!e.defaultPrevented&&onOpenAction){onOpenAction(action);}}}>
                                            <div className="timeline-action-name">{action.name}</div>
                                            <div className="timeline-action-count">{actionTasks.length} t√¢ches</div>
                                            {onReorderAction&&<div className="absolute right-2 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-50 transition-opacity text-xs" style={{color:'var(--text-muted)'}} title="Glisser pour r√©ordonner">‚ãÆ‚ãÆ</div>}
                                        </div>
                                        <div className={`flex-1 relative ${dragOverActionRow===action.id?'action-row-drag-over':''}`} style={{height:`${rowHeight}px`,zIndex:20,overflow:'hidden'}} onMouseDown={(e)=>handleCreateTaskStart(e,action)} onDragOver={(e)=>{handleActionRowDragOver(e,action);}} onDragLeave={(e)=>handleActionRowDragLeave(e,action)} onDrop={(e)=>{const taskId=e.dataTransfer.getData('taskId');if(taskId){e.stopPropagation();handleActionRowDrop(e,action);}}}>
                                            <div className="absolute inset-0 flex pointer-events-none">
                                                {headers.map((_,i)=>(
                                                    <div key={i} className={`border-l border-[var(--border)]`} style={{width:colWidth}}/>
                                                ))}
                                            </div>
                                            {dragPreview&&dragPreview.actionId===action.id&&(
                                                <div className="drag-preview-line" style={{left:dragPreview.left,width:dragPreview.width,top:dragPreview.top||8,background:dragPreview.color||'var(--accent)'}}/>
                                            )}
                                            {creatingTask&&creatingTask.actionId===action.id&&(
                                                <div className="absolute rounded-lg border-2 border-dashed border-secondary bg-secondary/20 flex items-center justify-center text-secondary text-xs font-medium pointer-events-none" style={{left:Math.min(creatingTask.startX,creatingTask.currentX),width:Math.abs(creatingTask.currentX-creatingTask.startX)||colWidth,top:8,height:26}}>
                                                    <span>Nouvelle t√¢che</span>
                                                </div>
                                            )}
                                            {actionTasks.sort((a,b)=>(a.order||0)-(b.order||0)).map(task=>{
                                                const pos=getTaskPosition(task);
                                                if(!pos)return null;
                                                const status=CONFIG.STATUSES.find(s=>s.id===task.status);
                                                const isDragOver=dragOverTask?.taskId===task.id;
                                                const isResizing=resizing?.taskId===task.id;
                                                const dragOverClass=isDragOver?(dragOverTask.position==='before'?'drop-indicator-before':'drop-indicator-after'):'';
                                                const swimLane=swimLanes[task.id]||0;
                                                const topOffset=8+swimLane*34;
                                                const resizingStyle=isResizing?{boxShadow:'0 0 0 3px rgba(255,255,255,0.5), 0 4px 12px rgba(0,0,0,0.3)',transform:'scale(1.02)',zIndex:30}:{};
                                                const channels=task.channels||action?.tags||[];
                                                const mainChannel=channels[0]||'';
                                                const channelColors={social:'#60a5fa',gads:'#fbbf24',lads:'#818cf8',events:'#f472b6',seo:'#4ade80',press:'#c4b5fd',email:'#fbbf24',web:'#818cf8',video:'#f87171',lp:'#2dd4bf',ia:'#c4b5fd',auto:'#fb923c'};
                                                const barColor=channelColors[mainChannel]||status?.color||'#94a3b8';
                                                const darkChannels=['gads','email'];
                                                const textColor=darkChannels.includes(mainChannel)?'#78350f':'white';
                                                const isCompleted=task.status==='completed';
                                                return(
                                                    <div key={task.id} draggable={!resizing} onClick={()=>!isResizing&&!justResized&&onOpenTask(task)} onDragStart={(e)=>handleTaskDragStart(e,task)} onDragEnd={handleTaskDragEnd} onDragOver={(e)=>handleTaskDragOver(e,task)} onDragLeave={handleTaskDragLeave} onDrop={(e)=>handleTaskDrop(e,task)} className={`timeline-bar absolute flex items-center overflow-visible ${isResizing?'':'cursor-move'} ${dragOverClass}`} style={{left:pos.left,width:pos.width,top:`${topOffset}px`,height:26,borderRadius:5,padding:'0 8px',fontSize:10,fontWeight:500,whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis',backgroundColor:barColor,color:textColor,zIndex:1,transition:'transform 0.15s, box-shadow 0.15s',opacity:isCompleted?0.45:1,...resizingStyle}} title={`${task.title}\n${status?.name}\n${task.startDate} ‚Üí ${task.dueDate}${task.budget>0?'\nBudget: '+task.budget+'‚Ç¨':''}`}>
                                                        <div className="resize-handle resize-handle-left" onClick={(e)=>{e.stopPropagation();e.preventDefault();}} onMouseDown={(e)=>{e.stopPropagation();e.preventDefault();startResize(task.id,'left',e.clientX,task);}} onTouchStart={(e)=>{e.stopPropagation();e.preventDefault();startResize(task.id,'left',e.touches[0].clientX,task);}} onDragStart={(e)=>{e.preventDefault();e.stopPropagation();return false;}} draggable={false} title="Redimensionner d√©but"/>
                                                        <span className="truncate flex-1 pointer-events-none" style={isCompleted?{textDecoration:'line-through'}:{}}>{task.title}</span>
                                                        {task.budget>0&&(zoom==='month'||zoom==='quarter')&&<span style={{marginLeft:4,opacity:0.8,fontSize:9}} className="pointer-events-none">({(task.budget/1000).toFixed(0)}k)</span>}
                                                        <div className="resize-handle resize-handle-right" onClick={(e)=>{e.stopPropagation();e.preventDefault();}} onMouseDown={(e)=>{e.stopPropagation();e.preventDefault();startResize(task.id,'right',e.clientX,task);}} onTouchStart={(e)=>{e.stopPropagation();e.preventDefault();startResize(task.id,'right',e.touches[0].clientX,task);}} onDragStart={(e)=>{e.preventDefault();e.stopPropagation();return false;}} draggable={false} title="Redimensionner fin"/>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                    );
                                })}
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        </div>
    );
};

// DASHBOARD VIEW// DASHBOARD VIEW
const DashboardView=({categories,actions,tasks})=>{
    const totalTasks=tasks.length;
    const completedTasks=tasks.filter(t=>t.status==='completed').length;
    const totalBudget=tasks.reduce((s,t)=>s+(t.budget||0),0);
    const spentBudget=tasks.filter(t=>['completed','inprogress'].includes(t.status)).reduce((s,t)=>s+(t.budget||0),0);
    const progressPct=totalTasks>0?Math.round((completedTasks/totalTasks)*100):0;
    const currentMonth=new Date().getMonth();
    const currentTasks=tasks.filter(t=>t.month===currentMonth);
    const overdueTasks=tasks.filter(t=>t.status!=='completed'&&(t.month<currentMonth||(t.dueDate&&new Date(t.dueDate)<new Date())));

    const KPICard=({title,value,subtitle,icon:I,color})=>(
        <div className="v11-card" style={{padding:'20px 24px',cursor:'default'}}>
            <div className="flex items-start justify-between">
                <div>
                    <p style={{fontSize:12,fontWeight:500,color:'var(--text-muted)',marginBottom:4,textTransform:'uppercase',letterSpacing:'0.3px'}}>{title}</p>
                    <p style={{fontSize:28,fontWeight:700,color,lineHeight:1.2}}>{value}</p>
                    {subtitle&&<p style={{fontSize:12,color:'var(--text-muted)',marginTop:4}}>{subtitle}</p>}
                </div>
                <div style={{padding:10,borderRadius:'var(--radius-md)',backgroundColor:`${color}15`}}>
                    <I size={20} color={color}/>
                </div>
            </div>
        </div>
    );

    return(
        <div className="space-y-6 animate-slide-in">
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <KPICard title="Avancement" value={`${progressPct}%`} subtitle={`${completedTasks}/${totalTasks} t√¢ches`} icon={Icon.TrendUp} color="#22c55e"/>
                <KPICard title="Budget" value={`${(spentBudget/1000).toFixed(0)}k‚Ç¨`} subtitle={`sur ${(totalBudget/1000).toFixed(0)}k‚Ç¨`} icon={Icon.Dollar} color="#6366f1"/>
                <KPICard title="Ce mois" value={currentTasks.length} subtitle="t√¢ches actives" icon={Icon.Calendar} color="#f59e0b"/>
                <KPICard title="En retard" value={overdueTasks.length} subtitle={overdueTasks.length>0?'√† traiter':'Tout OK!'} icon={Icon.Alert} color={overdueTasks.length>0?'#ef4444':'#22c55e'}/>
            </div>
            <div className="v11-card" style={{padding:'var(--space-6)',cursor:'default'}}>
                <h3 className="font-semibold mb-4">Progression par cat√©gorie</h3>
                <div className="space-y-4">
                    {categories.map(cat=>{
                        const catActions=actions.filter(a=>a.categoryId===cat.id);
                        const catTasks=tasks.filter(t=>catActions.some(a=>a.id===t.actionId));
                        const catCompleted=catTasks.filter(t=>t.status==='completed').length;
                        const catPct=catTasks.length>0?Math.round((catCompleted/catTasks.length)*100):0;
                        const catBudget=catTasks.reduce((s,t)=>s+(t.budget||0),0);
                        return(
                            <div key={cat.id}>
                                <div className="flex items-center justify-between mb-2"><div className="flex items-center space-x-3"><div className={`w-3 h-3 rounded-full bg-gradient-to-r ${cat.gradient}`}/><span className="font-medium text-sm">{cat.name}</span></div><div className="flex items-center space-x-4 text-sm"><span style={{color:'var(--text-muted)'}}>{catCompleted}/{catTasks.length}</span><span className="font-semibold text-secondary">{(catBudget/1000).toFixed(0)}k‚Ç¨</span><span className="font-bold">{catPct}%</span></div></div>
                                <div className="v11-progress-bar" style={{height:12}}><div className={`h-full rounded-full bg-gradient-to-r ${cat.gradient}`} style={{width:`${catPct}%`}}/></div>
                            </div>
                        );
                    })}
                </div>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div className="v11-card" style={{padding:'var(--space-6)',cursor:'default'}}>
                    <h3 className="font-semibold mb-4">Par statut</h3>
                    <div className="space-y-3">
                        {CONFIG.STATUSES.map(s=>{const count=tasks.filter(t=>t.status===s.id).length;const pct=totalTasks>0?Math.round((count/totalTasks)*100):0;return(<div key={s.id} className="flex items-center"><div className="w-28 flex items-center space-x-2"><StatusIcon statusId={s.id} size={12}/><span className="text-sm">{s.name}</span></div><div className="flex-1 h-4 rounded-full mx-3" style={{background:'var(--bg-secondary)'}}><div className="h-full rounded-full" style={{width:`${pct}%`,backgroundColor:s.color}}/></div><span className="w-8 text-right text-sm font-medium">{count}</span></div>);})}
                    </div>
                </div>
                <div className="v11-card" style={{padding:'var(--space-6)',cursor:'default',borderColor:overdueTasks.length>0?'var(--error)':'var(--border-light)'}}>
                    <h3 className="font-semibold mb-4">üö® En retard</h3>
                    <div className="space-y-2 max-h-64 overflow-y-auto">
                        {overdueTasks.length>0?overdueTasks.slice(0,8).map(t=>{const action=actions.find(a=>a.id===t.actionId);return<div key={t.id} style={{padding:'10px 14px',borderRadius:'var(--radius-sm)',background:'var(--error-light)',border:'1px solid #fecaca'}}><p style={{fontWeight:600,fontSize:13}}>{t.title}</p><p style={{fontSize:11,color:'var(--error)',marginTop:2}}>{action?.name} ‚Ä¢ {CONFIG.MONTHS_FULL[t.month]}</p></div>;}):<div className="text-center" style={{padding:'32px 0'}}><span style={{fontSize:32}}>‚úÖ</span><p style={{fontSize:13,color:'var(--text-muted)',marginTop:8}}>Tout est √† jour!</p></div>}
                    </div>
                </div>
            </div>
            <div className="v11-card" style={{padding:'var(--space-6)',cursor:'default'}}>
                <h3 className="font-semibold mb-4">üì¢ Par canal</h3>
                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                    {CONFIG.CHANNELS.map(ch=>{
                        const chTasks=tasks.filter(t=>(t.channels||[]).includes(ch.id));
                        const chCompleted=chTasks.filter(t=>t.status==='completed').length;
                        return(
                            <div key={ch.id} style={{padding:'14px 16px',borderRadius:'var(--radius-md)',border:'1px solid var(--border)',background:'var(--bg-primary)'}}>
                                <div className="flex items-center space-x-2" style={{marginBottom:8}}>
                                    <div style={{width:10,height:10,borderRadius:'50%',backgroundColor:ch.color,flexShrink:0}}/>
                                    <span style={{fontSize:12,fontWeight:600,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{ch.name}</span>
                                </div>
                                <div style={{fontSize:22,fontWeight:700}}>{chTasks.length}</div>
                                <div style={{fontSize:11,color:'var(--text-muted)'}}>{chCompleted} termin√©es</div>
                            </div>
                        );
                    })}
                </div>
            </div>
        </div>
    );
};

// FILTER SIDEBAR
const FilterSidebar=({show,onClose,filters,setFilters,categories,allCountries})=>{
    return(
        <div className={`filter-sidebar ${show?'open':''}`}>
            <div className="sidebar-header">
                <span className="sidebar-title">Filtres</span>
                <button className="sidebar-close" onClick={onClose}><Icon.Close/></button>
            </div>
            <div className="filter-section">
                <div className="filter-section-title">Recherche</div>
                <input type="text" placeholder="Rechercher..." value={filters.search} onChange={e=>setFilters({...filters,search:e.target.value})} className="v11-input"/>
            </div>
            <div className="filter-section">
                <div className="filter-section-title">Statut</div>
                <div className="filter-options">{CONFIG.STATUSES.map(s=>(<button key={s.id} onClick={()=>{const n=filters.status.includes(s.id)?filters.status.filter(x=>x!==s.id):[...filters.status,s.id];setFilters({...filters,status:n});}} className={`filter-option ${filters.status.includes(s.id)?'selected':''}`} style={{display:'flex',alignItems:'center',gap:4}}><StatusIcon statusId={s.id} size={11}/> {s.name}</button>))}</div>
            </div>
            <div className="filter-section">
                <div className="filter-section-title">Cat√©gorie</div>
                <div className="filter-options">{categories.map(c=>(<button key={c.id} onClick={()=>{const n=filters.category.includes(c.id)?filters.category.filter(x=>x!==c.id):[...filters.category,c.id];setFilters({...filters,category:n});}} className={`filter-option ${filters.category.includes(c.id)?'selected':''}`}>{c.name}</button>))}</div>
            </div>
            <div className="filter-section">
                <div className="filter-section-title">Priorit√©</div>
                <div className="filter-options">{CONFIG.PRIORITIES.map(p=>(<button key={p.id} onClick={()=>{const n=filters.priority.includes(p.id)?filters.priority.filter(x=>x!==p.id):[...filters.priority,p.id];setFilters({...filters,priority:n});}} className={`filter-option ${filters.priority.includes(p.id)?'selected':''}`} style={{display:'flex',alignItems:'center',gap:4}}><div style={{width:8,height:8,borderRadius:'50%',background:p.color,flexShrink:0}}/> {p.name}</button>))}</div>
            </div>
            <div className="filter-section">
                <div className="filter-section-title">Canal</div>
                <div className="filter-options">{CONFIG.CHANNELS.map(ch=>(<button key={ch.id} onClick={()=>{const n=(filters.channel||[]).includes(ch.id)?(filters.channel||[]).filter(x=>x!==ch.id):[...(filters.channel||[]),ch.id];setFilters({...filters,channel:n});}} className={`filter-option ${(filters.channel||[]).includes(ch.id)?'selected':''}`}>{ch.name}</button>))}</div>
            </div>
            <div className="filter-section">
                <div className="filter-section-title">Pays</div>
                <div className="filter-options">{allCountries.map(co=>(<button key={co.id} onClick={()=>{const n=(filters.country||[]).includes(co.id)?(filters.country||[]).filter(x=>x!==co.id):[...(filters.country||[]),co.id];setFilters({...filters,country:n});}} className={`filter-option ${(filters.country||[]).includes(co.id)?'selected':''}`}>{co.flag} {co.name}</button>))}</div>
            </div>
            <div className="sidebar-footer">
                <button onClick={()=>setFilters({search:'',status:[],category:[],priority:[],channel:[],country:[]})} className="v11-btn-secondary" style={{flex:1}}>R√©initialiser</button>
                <button onClick={onClose} className="v11-btn-primary" style={{flex:1}}>Appliquer</button>
            </div>
        </div>
    );
};

// MAIN APP
const App=()=>{
    const darkMode=false;
    const[currentView,setCurrentView]=useState('kanban');
    const[categories,setCategories]=useState(CONFIG.CATEGORIES);
    const[actions,setActions]=useState(ACTIONS);
    const[tasks,setTasks]=useState(TASKS);
    const[filters,setFilters]=useState({search:'',status:[],category:[],priority:[],channel:[],country:[]});
    const[syncing,setSyncing]=useState(false);
    const[savingStatus,setSavingStatus]=useState(null);
    const[selectedTask,setSelectedTask]=useState(null);
    const[selectedAction,setSelectedAction]=useState(null);
    const[notification,setNotification]=useState(null);
    const[githubToken,setGithubToken]=useState('');
    const[showCategoriesModal,setShowCategoriesModal]=useState(false);
    const[showNewActionModal,setShowNewActionModal]=useState(false);
    const[showNewTaskModal,setShowNewTaskModal]=useState(false);
    const[showCreateDropdown,setShowCreateDropdown]=useState(false);
    const[showExportDropdown,setShowExportDropdown]=useState(false);
    const[showFilterSidebar,setShowFilterSidebar]=useState(false);
    const[selectedYear,setSelectedYear]=useState(new Date().getFullYear());
    const[dataLoaded,setDataLoaded]=useState(false);
    const[fileSha,setFileSha]=useState(()=>{
        // CRITICAL FIX: Restore SHA from localStorage on init
        return localStorage.getItem('github_file_sha')||'';
    });
    const[customCountries,setCustomCountries]=useState(()=>{
        const saved=localStorage.getItem('customCountries');
        return saved?JSON.parse(saved):[];
    });
    const saveQueueRef=useRef([]);
    const isSavingRef=useRef(false);
    const createDropdownRef=useRef(null);
    const exportDropdownRef=useRef(null);

    // Close dropdowns on outside click
    useEffect(()=>{
        if(!showCreateDropdown&&!showExportDropdown)return;
        const handler=(e)=>{
            if(showCreateDropdown&&createDropdownRef.current&&!createDropdownRef.current.contains(e.target)){
                setShowCreateDropdown(false);
            }
            if(showExportDropdown&&exportDropdownRef.current&&!exportDropdownRef.current.contains(e.target)){
                setShowExportDropdown(false);
            }
        };
        document.addEventListener('mousedown',handler);
        return()=>document.removeEventListener('mousedown',handler);
    },[showCreateDropdown,showExportDropdown]);

    // Save custom countries to localStorage whenever they change
    useEffect(()=>{
        localStorage.setItem('customCountries',JSON.stringify(customCountries));
    },[customCountries]);

    // Merge built-in and custom countries
    const allCountries=[...CONFIG.COUNTRIES,...customCountries];

    // Add custom country function
    const addCustomCountry=(name,flag,color,region)=>{
        const newCountry={
            id:`custom-${Date.now()}`,
            name,
            flag:flag||'üåç',
            color:color||'#6366f1',
            region:region||'Custom'
        };
        setCustomCountries(prev=>[...prev,newCountry]);
        showNotification(`‚úÖ Pays "${name}" ajout√©`);
        return newCountry.id;
    };

    // ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
    // ‚ïë  ‚úÖ CONFIGURATION VERCEL - TOKEN S√âCURIS√â C√îT√â SERVEUR                   ‚ïë
    // ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
    //
    // Le token GitHub est maintenant stock√© de mani√®re s√©curis√©e dans Vercel
    // en tant que variable d'environnement. Plus besoin de le mettre ici !
    //
    // Configuration du repository GitHub
    const GITHUB_CONFIG={
        owner:'migso-pcubed-mkt-com',
        repo:'Marketing-Dashboard',
        branch:'main',
        path:'data.json'
    };

    // URL de l'API Vercel (sera automatiquement d√©tect√©e)
    // En production: https://votre-app.vercel.app/api/github
    // En d√©veloppement local: http://localhost:3000/api/github
    const API_BASE_URL=window.location.hostname==='localhost'
        ?'http://localhost:3000'
        :window.location.origin;

    // UTF-8 safe Base64 encoding/decoding
    const base64EncodeUnicode=(str)=>{
        return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,(match,p1)=>String.fromCharCode('0x'+p1)));
    };
    const base64DecodeUnicode=(str)=>{
        return decodeURIComponent(atob(str).split('').map(c=>'%'+('00'+c.charCodeAt(0).toString(16)).slice(-2)).join(''));
    };

    // CRITICAL HELPER: Fetch GitHub API with consistent cache busting
    const fetchGitHubAPI=(url,options={})=>{
        const timestamp=Date.now();
        const random=Math.random().toString(36).substring(7);
        const cacheBustedUrl=`${url}${url.includes('?')?'&':'?'}_=${timestamp}&r=${random}`;

        return fetch(cacheBustedUrl,{
            ...options,
            headers:{
                ...options.headers,
                'Cache-Control':'no-store, no-cache, must-revalidate, proxy-revalidate',
                'Pragma':'no-cache',
                'Expires':'0'
            },
            cache:'no-store'
        });
    };

    useEffect(()=>{document.body.className='light';},[]);

    // Keyboard shortcuts
    useEffect(()=>{
        const handleKeyPress=(e)=>{
            if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA')return;
            if(e.key==='Escape'){
                if(selectedTask)setSelectedTask(null);
                else if(selectedAction)setSelectedAction(null);
                else if(showCategoriesModal)setShowCategoriesModal(false);
                else if(showCreateDropdown)setShowCreateDropdown(false);
                else if(showFilterSidebar)setShowFilterSidebar(false);
                else if(showNewActionModal)setShowNewActionModal(false);
                else if(showNewTaskModal)setShowNewTaskModal(false);
            }
            if(e.key==='n'&&!e.ctrlKey&&!e.metaKey)handleCreateNewTask();
            if((e.key==='1'||e.key==='&')&&!e.ctrlKey&&!e.metaKey)setCurrentView('kanban');
            if((e.key==='2'||e.key==='√©')&&!e.ctrlKey&&!e.metaKey)setCurrentView('timeline');
            if((e.key==='3'||e.key==='"')&&!e.ctrlKey&&!e.metaKey)setCurrentView('dashboard');
        };
        document.addEventListener('keydown',handleKeyPress);
        return()=>document.removeEventListener('keydown',handleKeyPress);
    },[selectedTask,selectedAction,showCategoriesModal,showNewActionModal,showNewTaskModal]);

    // Load data from Vercel API (which proxies to GitHub)
    useEffect(()=>{
        console.log('üöÄ Chargement des donn√©es via Vercel API...');
        setGithubToken('vercel-api'); // Marqueur pour indiquer qu'on utilise l'API

        // CRITICAL FIX: Set dataLoaded to true after a small delay to ensure React is mounted
        // This prevents the app from being stuck on loading screen if API fails
        const mountTimer = setTimeout(() => {
            console.log('‚úÖ App mounted, activating interface');
            setDataLoaded(true);
        }, 100);

        // Try to load data with timeout fallback
        const timeoutId = setTimeout(() => {
            console.warn('‚è±Ô∏è Chargement timeout, utilisation des donn√©es par d√©faut');
            loadFromLocalStorage();
        }, 5000);

        loadDataFromGitHub().then(() => {
            clearTimeout(timeoutId);
        }).catch((err) => {
            console.error('Erreur lors du chargement:', err);
            clearTimeout(timeoutId);
        });

        return () => {
            clearTimeout(mountTimer);
            clearTimeout(timeoutId);
        };
    },[]);



    // CRITICAL FIX: Persist SHA to localStorage whenever it changes
    useEffect(()=>{
        if(fileSha){
            localStorage.setItem('github_file_sha',fileSha);
            console.log('üìå SHA persist√©:',fileSha.substring(0,8)+'...');
        }else{
            localStorage.removeItem('github_file_sha');
        }
    },[fileSha]);

    // CRITICAL FIX: Auto-save with proper closure handling
    // Watches categories, actions, tasks and auto-saves when they change
    useEffect(()=>{
        // Skip auto-save on initial mount (dataLoaded false)
        if(!dataLoaded)return;

        console.log('üîÑ Donn√©es modifi√©es, auto-save dans 2s...');
        setSavingStatus('saving');

        // Debounce: clear previous timeout
        if(autoSaveTimeoutRef.current){
            clearTimeout(autoSaveTimeoutRef.current);
        }

        // Set new timeout with current values
        autoSaveTimeoutRef.current=setTimeout(async()=>{
            console.log('üíæ Auto-save d√©clench√©e...');
            if(githubToken){
                const success=await saveToGitHub();
                setSavingStatus(success?'saved':'error');
                if(!success){
                    saveToLocalStorage(); // Backup if GitHub fails
                }
            }else{
                saveToLocalStorage();
                setSavingStatus('saved');
            }
            setTimeout(()=>setSavingStatus(null),2000);
        },2000);

        // Cleanup on unmount
        return()=>{
            if(autoSaveTimeoutRef.current){
                clearTimeout(autoSaveTimeoutRef.current);
            }
        };
    },[categories,actions,tasks,dataLoaded,githubToken]); // Re-run when data changes

    const loadDataFromGitHub=async()=>{
        try{
            console.log('üì• Loading from GitHub via Vercel API...');
            const url=`${API_BASE_URL}/api/github`;

            const response=await fetch(url,{
                method:'GET',
                headers:{
                    'Accept':'application/json',
                    'Cache-Control':'no-cache'
                }
            });

            if(response.ok){
                const data=await response.json();
                console.log('üì• Loaded from GitHub. SHA:',data.sha,'Size:',data.size);
                const decodedContent=base64DecodeUnicode(data.content.replace(/\n/g,'').replace(/\s/g,''));
                const content=JSON.parse(decodedContent);

                // Validate loaded data structure
                const isValidCategories=Array.isArray(content.categories)&&content.categories.every(c=>c.id&&c.name);
                const isValidActions=Array.isArray(content.actions)&&content.actions.every(a=>a.id&&a.name);
                const isValidTasks=Array.isArray(content.tasks)&&content.tasks.every(t=>t.id&&t.title);

                if(!isValidCategories||!isValidActions||!isValidTasks){
                    console.error('‚ö†Ô∏è Invalid data structure from GitHub',{
                        categories:isValidCategories,
                        actions:isValidActions,
                        tasks:isValidTasks
                    });
                    showNotification('‚ö†Ô∏è Donn√©es GitHub invalides, backup local charg√©');
                    loadFromLocalStorage();
                    setDataLoaded(true);
                    return;
                }

                // Update state with loaded data
                setCategories(content.categories||CONFIG.CATEGORIES);
                setActions(content.actions||ACTIONS);
                setTasks(content.tasks||TASKS);
                setFileSha(data.sha);

                // Save to localStorage as backup
                saveToLocalStorage();

                console.log('‚úÖ GitHub loaded successfully. Categories:',content.categories?.length,'Actions:',content.actions?.length,'Tasks:',content.tasks?.length);
                showNotification('‚úÖ Donn√©es charg√©es depuis GitHub');
            }else if(response.status===404){
                console.warn('‚ö†Ô∏è File not found on GitHub, will create on first save');
                showNotification('‚ö†Ô∏è Fichier data.json non trouv√© - cr√©ation au premier save');
                loadFromLocalStorage();
                setFileSha(''); // Clear SHA for new file
            }else if(response.status===500){
                const errorData=await response.json();
                console.error('‚ùå ERREUR 500: Probl√®me serveur Vercel:',errorData);
                if(errorData.message&&errorData.message.includes('GITHUB_TOKEN')){
                    alert('‚ùå CONFIGURATION REQUISE\n\nLe token GitHub n\'est pas configur√© dans Vercel.\n\nVeuillez:\n1. Aller sur votre dashboard Vercel\n2. Projet ‚Üí Settings ‚Üí Environment Variables\n3. Ajouter: GITHUB_TOKEN = votre_token_github\n4. Red√©ployer l\'application\n\nEn attendant, les donn√©es locales sont utilis√©es.');
                }else{
                    showNotification(`‚ùå Erreur serveur: ${errorData.error}`);
                }
                loadFromLocalStorage();
            }else{
                const errorText=await response.text();
                console.error('API error:',response.status,errorText);
                showNotification(`‚ùå Erreur API: ${response.status}`);
                loadFromLocalStorage();
            }
        }catch(e){
            console.error('Erreur chargement GitHub:',e);
            showNotification('‚ö†Ô∏è Erreur chargement GitHub, backup local charg√©');
            loadFromLocalStorage();
        }
        // Note: dataLoaded is now set to true immediately in useEffect, not here
    };

    const loadFromLocalStorage=()=>{
        try{
            const backup=localStorage.getItem('marketing_tracker_backup');
            if(backup){
                const data=JSON.parse(backup);
                setCategories(data.categories||CONFIG.CATEGORIES);
                setActions(data.actions||ACTIONS);
                setTasks(data.tasks||TASKS);
                showNotification('üì¶ Backup local charg√©');
            }
        }catch(e){
            console.error('LocalStorage load error:',e);
        }
    };

    const saveToGitHub=async()=>{
        if(!githubToken){showNotification('‚ö†Ô∏è Connexion API manquante');return;}
        setSyncing(true);
        try{
            const jsonString=JSON.stringify({categories,actions,tasks},null,2);
            const content=base64EncodeUnicode(jsonString);

            const body={
                message:`Update data from Marketing Tracker V2.2 - ${new Date().toISOString()}`,
                content:content,
                sha:fileSha||undefined // Include SHA if we have it
            };

            console.log('üíæ Saving to GitHub via Vercel API...',{
                hasSha:!!fileSha,
                sha:fileSha?fileSha.substring(0,8)+'...':'none',
                contentLength:content.length,
                jsonLength:jsonString.length
            });

            const url=`${API_BASE_URL}/api/github`;
            const response=await fetch(url,{
                method:'PUT',
                headers:{
                    'Content-Type':'application/json',
                    'Accept':'application/json'
                },
                body:JSON.stringify(body)
            });

            if(response.ok){
                const data=await response.json();
                setFileSha(data.content.sha);
                console.log('‚úÖ GitHub save successful. New SHA:',data.content.sha.substring(0,8));
                showNotification('‚úÖ Sauvegarde GitHub r√©ussie');
                // Force localStorage update
                saveToLocalStorage();
                return true;
            }else{
                const errorText=await response.text();
                let errorDetails;
                try{
                    errorDetails=JSON.parse(errorText);
                }catch(e){
                    errorDetails={message:errorText};
                }

                // Handle server errors (500)
                if(response.status===500){
                    console.error('‚ùå ERREUR 500: Probl√®me serveur Vercel:',errorDetails);
                    if(errorDetails.message&&errorDetails.message.includes('GITHUB_TOKEN')){
                        alert('‚ùå CONFIGURATION REQUISE\n\nLe token GitHub n\'est pas configur√© dans Vercel.\n\nVeuillez:\n1. Aller sur votre dashboard Vercel\n2. Projet ‚Üí Settings ‚Üí Environment Variables\n3. Ajouter: GITHUB_TOKEN = votre_token_github\n4. Red√©ployer l\'application\n\nSauvegarde locale effectu√©e en backup.');
                    }
                    showNotification('‚ùå Erreur serveur - Voir console');
                    return false;
                }

                // Handle SHA conflict (409)
                if(response.status===409||errorDetails.details?.message?.includes('does not match')){
                    console.warn('‚ö†Ô∏è SHA conflict detected');
                    if(confirm('Le fichier a √©t√© modifi√© ailleurs. Voulez-vous √©craser avec vos modifications locales ?\n\nOUI = √âcraser les modifications distantes\nNON = Annuler et recharger la page')){
                        // Reload data to get latest SHA, then retry
                        await loadDataFromGitHub();
                        // User will need to save again manually
                        showNotification('‚ö†Ô∏è Donn√©es recharg√©es. Sauvegardez √† nouveau.');
                        return false;
                    }else{
                        showNotification('‚ö†Ô∏è Sauvegarde annul√©e - rechargez la page');
                        return false;
                    }
                }

                console.error('API save error:',{
                    status:response.status,
                    statusText:response.statusText,
                    error:errorDetails
                });
                showNotification(`‚ùå Erreur ${response.status}: ${errorDetails.error||errorDetails.message||response.statusText}`);
                return false;
            }
        }catch(e){
            console.error('Erreur sauvegarde GitHub:',e);
            showNotification(`‚ùå Erreur: ${e.message}`);
            return false;
        }finally{
            setSyncing(false);
        }
    };

    const autoSaveTimeoutRef=useRef(null);

    const saveToLocalStorage=()=>{
        try{
            const data={categories,actions,tasks,timestamp:Date.now()};
            localStorage.setItem('marketing_tracker_backup',JSON.stringify(data));
        }catch(e){
            console.error('LocalStorage save error:',e);
        }
    };

    // ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
    // ‚ïë  üîÑ AUTO-SYNC POLLING - Synchronisation multi-devices automatique         ‚ïë
    // ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
    const checkForUpdates=async()=>{
        // Ne pas checker si une modale est ouverte (pour ne pas perdre les modifications en cours)
        if(selectedTask||selectedAction){
            console.log('‚è∏Ô∏è Polling paused: modal open');
            return;
        }

        // Ne pas checker si on est en train de sauvegarder
        if(syncing||savingStatus==='saving'){
            console.log('‚è∏Ô∏è Polling paused: saving in progress');
            return;
        }

        try{
            const url=`${API_BASE_URL}/api/github`;
            const response=await fetch(url,{
                method:'GET',
                headers:{
                    'Accept':'application/json',
                    'Cache-Control':'no-cache'
                }
            });

            if(response.ok){
                const data=await response.json();

                // Si le SHA a chang√©, recharger les donn√©es
                if(data.sha&&fileSha&&data.sha!==fileSha){
                    console.log('üîÑ Modifications d√©tect√©es sur GitHub, synchronisation...');
                    showNotification('üîÑ Synchronisation avec l\'√©quipe...');
                    await loadDataFromGitHub();
                    showNotification('‚úÖ Synchronis√© avec l\'√©quipe');
                }
            }
        }catch(e){
            console.log('‚ö†Ô∏è Polling error (silencieux):',e.message);
            // On ne montre pas d'erreur √† l'utilisateur pour ne pas le d√©ranger
        }
    };

    // Polling pour auto-sync multi-devices toutes les 15 secondes
    useEffect(()=>{
        if(!githubToken||!dataLoaded)return;

        console.log('üîÑ Auto-sync polling activ√© (15s)');
        const interval=setInterval(checkForUpdates,15000); // 15 secondes

        return()=>clearInterval(interval);
    },[githubToken,dataLoaded,selectedTask,selectedAction,syncing,savingStatus,fileSha]);

    // Auto-initialize order and createdAt properties for tasks that don't have them
    useEffect(()=>{
        if(!dataLoaded)return;

        const needsOrder=tasks.some(t=>t.order===undefined);
        const needsCreatedAt=tasks.some(t=>!t.createdAt);

        if(needsOrder||needsCreatedAt){
            console.log('üî¢ Initializing task properties...');
            setTasks(prev=>prev.map((t,idx)=>({
                ...t,
                order:t.order!==undefined?t.order:idx,
                createdAt:t.createdAt||new Date().toISOString()
            })));
        }
    },[dataLoaded,tasks.length]);

    // Auto-initialize order for actions that don't have it
    useEffect(()=>{
        if(!dataLoaded)return;

        const needsOrder=actions.some(a=>a.order===undefined);
        if(needsOrder){
            console.log('üî¢ Initializing action order...');
            setActions(prev=>prev.map((a,idx)=>({...a,order:a.order!==undefined?a.order:idx})));
        }
    },[dataLoaded,actions.length]);

    const handleSync=()=>saveToGitHub();

    const handleUpdateTask=(taskId,updates)=>{
        setTasks(prev=>prev.map(t=>{
            if(t.id!==taskId)return t;
            const newTask={...t,...updates};
            if(updates.dueDate){
                const d=new Date(updates.dueDate);
                newTask.month=d.getMonth();
            }
            return newTask;
        }));
        showNotification('‚úÖ T√¢che mise √† jour');
        // Auto-save via useEffect
    };

    const handleUpdateAction=(actionId,updates)=>{
        setActions(prev=>prev.map(a=>a.id===actionId?{...a,...updates}:a));
        showNotification('‚úÖ Action mise √† jour');
        // Auto-save via useEffect
    };

    const handleDeleteAction=(actionId)=>{
        const action=actions.find(a=>a.id===actionId);
        const affectedTasks=tasks.filter(t=>t.actionId===actionId).length;
        const confirmMessage=affectedTasks>0
            ?`Voulez-vous vraiment supprimer l'action "${action?.name}" ?\n\nCela supprimera √©galement ${affectedTasks} t√¢che(s) associ√©e(s).`
            :`Voulez-vous vraiment supprimer l'action "${action?.name}" ?`;

        if(!confirm(confirmMessage))return;

        setActions(prev=>prev.filter(a=>a.id!==actionId));
        setTasks(prev=>prev.filter(t=>t.actionId!==actionId));
        showNotification('üóëÔ∏è Action supprim√©e');
        // Auto-save via useEffect
    };

    const handleAddTask=(actionId,customStartDate=null,customDueDate=null)=>{
        const action=actions.find(a=>a.id===actionId);
        const startDate=customStartDate||new Date().toISOString().split('T')[0];
        const month=new Date(startDate).getMonth();
        let dueDate;
        if(customDueDate){
            dueDate=customDueDate;
        }else{
            const endOfMonth=new Date(2026,month+1,0).getDate();
            dueDate=`2026-${String(month+1).padStart(2,'0')}-${endOfMonth}`;
        }
        const maxOrder=Math.max(...tasks.map(t=>t.order||0),-1)+1;
        const now=new Date().toISOString();
        const newTask={id:`t${Date.now()}`,actionId,month,startDate,title:'Nouvelle t√¢che',description:'',status:'todo',priority:'medium',dueDate,budget:0,channels:action?.tags||[],checklist:[],comments:[],attachments:[],order:maxOrder,createdAt:now};
        setTasks(prev=>[...prev,newTask]);
        setSelectedTask(newTask);
        showNotification('‚úÖ T√¢che cr√©√©e');
        // Auto-save via useEffect
    };

    const handleMoveTask=(taskId,direction)=>{
        const task=tasks.find(t=>t.id===taskId);
        if(!task)return;

        // Find all tasks in the same column (month/status based on view)
        const sameTasks=tasks.filter(t=>{
            if(task.month!==undefined)return t.month===task.month; // Month view
            return t.status===task.status; // Action view
        }).sort((a,b)=>(a.order||0)-(b.order||0));

        const currentIndex=sameTasks.findIndex(t=>t.id===taskId);
        if(currentIndex===-1)return;

        const targetIndex=direction==='up'?currentIndex-1:currentIndex+1;
        if(targetIndex<0||targetIndex>=sameTasks.length)return;

        // Swap orders
        const currentOrder=sameTasks[currentIndex].order||currentIndex;
        const targetOrder=sameTasks[targetIndex].order||targetIndex;

        setTasks(prev=>prev.map(t=>{
            if(t.id===sameTasks[currentIndex].id)return{...t,order:targetOrder};
            if(t.id===sameTasks[targetIndex].id)return{...t,order:currentOrder};
            return t;
        }));

        showNotification(direction==='up'?'‚¨ÜÔ∏è T√¢che d√©plac√©e vers le haut':'‚¨áÔ∏è T√¢che d√©plac√©e vers le bas');
    };

    const handleReorderTask=(draggedId,targetId,position)=>{
        if(draggedId===targetId)return;

        const draggedTask=tasks.find(t=>t.id===draggedId);
        const targetTask=tasks.find(t=>t.id===targetId);
        if(!draggedTask||!targetTask)return;

        // Check if moving to a different column
        const isDifferentMonth=(draggedTask.month!==undefined&&targetTask.month!==undefined&&draggedTask.month!==targetTask.month);
        const isDifferentStatus=(draggedTask.status!==undefined&&targetTask.status!==undefined&&draggedTask.status!==targetTask.status);
        const isDifferentColumn=isDifferentMonth||isDifferentStatus;

        // If different column, update the dragged task's column properties first
        let updatedDraggedTask={...draggedTask};
        if(isDifferentColumn){
            if(isDifferentMonth){
                updatedDraggedTask.month=targetTask.month;
                // Also update dates based on new month
                const year=2026;
                const monthIdx=targetTask.month;
                const startDate=year+'-'+String(monthIdx+1).padStart(2,'0')+'-01';
                const lastDay=new Date(year,monthIdx+1,0).getDate();
                const dueDate=year+'-'+String(monthIdx+1).padStart(2,'0')+'-'+lastDay;
                updatedDraggedTask.startDate=startDate;
                updatedDraggedTask.dueDate=dueDate;
            }
            if(isDifferentStatus){
                updatedDraggedTask.status=targetTask.status;
            }
        }

        // Find all tasks in the TARGET column (with updated dragged task if column changed)
        const targetColumnTasks=tasks.filter(t=>{
            if(t.id===draggedId)return true; // Include dragged task
            if(targetTask.month!==undefined)return t.month===targetTask.month;
            return t.status===targetTask.status;
        }).map(t=>t.id===draggedId?updatedDraggedTask:t).sort((a,b)=>(a.order||0)-(b.order||0));

        const draggedIndex=targetColumnTasks.findIndex(t=>t.id===draggedId);
        const targetIndex=targetColumnTasks.findIndex(t=>t.id===targetId);
        if(draggedIndex===-1||targetIndex===-1)return;

        // Reorder the tasks in target column
        const reordered=[...targetColumnTasks];
        const[removed]=reordered.splice(draggedIndex,1);
        const insertIndex=position==='before'?targetIndex:targetIndex+1;
        const adjustedIndex=draggedIndex<targetIndex?insertIndex-1:insertIndex;
        reordered.splice(adjustedIndex,0,removed);

        // Update order property - assign new sequential orders
        const updatedTasks=reordered.map((t,idx)=>({...t,order:idx}));

        setTasks(prev=>prev.map(t=>{
            const updated=updatedTasks.find(ut=>ut.id===t.id);
            return updated||t;
        }));

        showNotification(isDifferentColumn?'‚úÖ T√¢che d√©plac√©e vers nouvelle colonne':'‚úÖ T√¢che r√©ordonn√©e');
    };

    const handleMoveAction=(actionId,direction)=>{
        const action=actions.find(a=>a.id===actionId);
        if(!action)return;

        // Find all actions in the same category
        const sameActions=actions.filter(a=>a.categoryId===action.categoryId).sort((a,b)=>(a.order||0)-(b.order||0));

        const currentIndex=sameActions.findIndex(a=>a.id===actionId);
        if(currentIndex===-1)return;

        const targetIndex=direction==='up'?currentIndex-1:currentIndex+1;
        if(targetIndex<0||targetIndex>=sameActions.length)return;

        // Swap orders
        const currentOrder=sameActions[currentIndex].order||currentIndex;
        const targetOrder=sameActions[targetIndex].order||targetIndex;

        setActions(prev=>prev.map(a=>{
            if(a.id===sameActions[currentIndex].id)return{...a,order:targetOrder};
            if(a.id===sameActions[targetIndex].id)return{...a,order:currentOrder};
            return a;
        }));

        showNotification(direction==='up'?'‚¨ÜÔ∏è Action d√©plac√©e vers le haut':'‚¨áÔ∏è Action d√©plac√©e vers le bas');
    };

    const handleReorderAction=(draggedId,targetId,position)=>{
        if(draggedId===targetId)return;

        const draggedAction=actions.find(a=>a.id===draggedId);
        const targetAction=actions.find(a=>a.id===targetId);
        if(!draggedAction||!targetAction)return;

        // Check if moving to different category
        if(draggedAction.categoryId!==targetAction.categoryId){
            // Inter-category move: change category and reorder
            const targetActions=actions.filter(a=>a.categoryId===targetAction.categoryId).sort((a,b)=>(a.order||0)-(b.order||0));
            const targetIndex=targetActions.findIndex(a=>a.id===targetId);

            if(targetIndex!==-1){
                const insertIndex=position==='before'?targetIndex:targetIndex+1;

                // Remove from old category and update orders
                const oldCategoryActions=actions.filter(a=>a.categoryId===draggedAction.categoryId&&a.id!==draggedId).sort((a,b)=>(a.order||0)-(b.order||0));
                const oldUpdates=oldCategoryActions.map((a,idx)=>({...a,order:idx}));

                // Insert into new category
                targetActions.splice(insertIndex,0,{...draggedAction,categoryId:targetAction.categoryId});
                const newUpdates=targetActions.map((a,idx)=>({...a,order:idx,categoryId:targetAction.categoryId}));

                setActions(prev=>prev.map(a=>{
                    const updated=[...oldUpdates,...newUpdates].find(ua=>ua.id===a.id);
                    return updated||a;
                }));

                showNotification('‚úÖ Action d√©plac√©e vers nouvelle cat√©gorie');
            }
        }else{
            // Intra-category move: reorder within same category
            const sameActions=actions.filter(a=>a.categoryId===draggedAction.categoryId).sort((a,b)=>(a.order||0)-(b.order||0));

            const draggedIndex=sameActions.findIndex(a=>a.id===draggedId);
            const targetIndex=sameActions.findIndex(a=>a.id===targetId);
            if(draggedIndex===-1||targetIndex===-1)return;

            // Reorder the actions
            const reordered=[...sameActions];
            const[removed]=reordered.splice(draggedIndex,1);
            const insertIndex=position==='before'?targetIndex:targetIndex+1;
            const adjustedIndex=draggedIndex<targetIndex?insertIndex-1:insertIndex;
            reordered.splice(adjustedIndex,0,removed);

            // Update order property - assign new sequential orders
            const updatedActions=reordered.map((a,idx)=>({...a,order:idx}));

            setActions(prev=>prev.map(a=>{
                const updated=updatedActions.find(ua=>ua.id===a.id);
                return updated||a;
            }));

            showNotification('‚úÖ Action r√©ordonn√©e');
        }
    };

    const handleDeleteTask=(taskId)=>{
        setTasks(prev=>prev.filter(t=>t.id!==taskId));
        showNotification('üóëÔ∏è T√¢che supprim√©e');
        // Auto-save via useEffect
    };

    const handleCreateNewTask=()=>setShowNewTaskModal(true);

    const handleUpdateCategory=(catId,updates)=>{
        setCategories(prev=>prev.map(c=>c.id===catId?{...c,...updates}:c));
        showNotification('‚úÖ Cat√©gorie mise √† jour');
        // Auto-save via useEffect
    };

    const handleAddCategory=(newCat)=>{
        setCategories(prev=>[...prev,newCat]);
        showNotification('‚úÖ Cat√©gorie cr√©√©e');
        // Auto-save via useEffect
    };

    const handleDeleteCategory=(catId)=>{
        const category=categories.find(c=>c.id===catId);
        const affectedActions=actions.filter(a=>a.categoryId===catId).length;
        const confirmMessage=affectedActions>0
            ?`Voulez-vous vraiment supprimer la cat√©gorie "${category?.name}" ?\n\nCela supprimera √©galement ${affectedActions} action(s) associ√©e(s).`
            :`Voulez-vous vraiment supprimer la cat√©gorie "${category?.name}" ?`;

        if(!confirm(confirmMessage))return;

        setCategories(prev=>prev.filter(c=>c.id!==catId));
        setActions(prev=>prev.filter(a=>a.categoryId!==catId));
        showNotification('üóëÔ∏è Cat√©gorie supprim√©e');
        // Auto-save via useEffect
    };

    const handleReorderCategories=(reorderedCategories)=>{
        setCategories(reorderedCategories);
        showNotification('‚úÖ Ordre des cat√©gories mis √† jour');
        // Auto-save via useEffect
    };

    const handleAddAction=(newAction)=>{
        setActions(prev=>[...prev,newAction]);
        showNotification('‚úÖ Action cr√©√©e');
        // Auto-save via useEffect
    };

    const handleAddNewTask=(newTask)=>{
        const maxOrder=Math.max(...tasks.map(t=>t.order||0),-1)+1;
        const now=new Date().toISOString();
        setTasks(prev=>[...prev,{...newTask,order:maxOrder,createdAt:newTask.createdAt||now}]);
        showNotification('‚úÖ T√¢che cr√©√©e');
        // Auto-save via useEffect
    };

    const showNotification=(msg)=>{setNotification(msg);setTimeout(()=>setNotification(null),3000);};

    const exportToJSON=()=>{
        const data={categories,actions,tasks,exportDate:new Date().toISOString()};
        const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url;
        a.download=`marketing-tracker-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showNotification('üì• Export JSON t√©l√©charg√©');
    };

    const exportToCSV=()=>{
        const headers=['ID','Titre','Action','Cat√©gorie','Statut','Priorit√©','Date d√©but','Date fin','Budget','Channels','Description'];
        const rows=tasks.map(t=>{
            const action=actions.find(a=>a.id===t.actionId);
            const category=categories.find(c=>c.id===action?.categoryId);
            return[
                t.id,
                t.title,
                action?.name||'',
                category?.name||'',
                CONFIG.STATUSES.find(s=>s.id===t.status)?.name||t.status,
                CONFIG.PRIORITIES.find(p=>p.id===t.priority)?.name||t.priority,
                t.startDate||'',
                t.dueDate||'',
                t.budget||0,
                (t.channels||[]).join(';'),
                (t.description||'').replace(/"/g,'""')
            ].map(v=>`"${v}"`).join(',');
        });
        const csv=[headers.join(','),...rows].join('\n');
        const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url;
        a.download=`marketing-tracker-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        showNotification('üìä Export CSV t√©l√©charg√©');
    };

    const totalBudget=tasks.reduce((s,t)=>s+(t.budget||0),0);
    const completedCount=tasks.filter(t=>t.status==='completed').length;
    const activeFilterCount=[filters.status,filters.category,filters.priority,filters.channel,filters.country].reduce((c,arr)=>c+(Array.isArray(arr)?arr.length:0),0)+(filters.search?1:0);

    if(!dataLoaded)return(<div className="min-h-screen flex items-center justify-center" style={{background:'var(--bg-page)'}}><div className="text-center" style={{color:'var(--text-primary)'}}><div className="animate-spin w-12 h-12 border-4 rounded-full mx-auto mb-4" style={{borderColor:'var(--accent)',borderTopColor:'transparent'}}/><p>Chargement des donn√©es...</p></div></div>);

    return(
        <AppContext.Provider value={{}}>
            <div className="min-h-screen" style={{background:'var(--bg-page)'}}>
                <Header currentView={currentView} setCurrentView={setCurrentView} onSync={handleSync} syncing={syncing} githubConnected={!!githubToken} savingStatus={savingStatus}/>
                <main style={{maxWidth:1600,margin:'0 auto',padding:'var(--space-4) var(--space-6)'}}>
                    <div className="toolbar">
                        <button className={`filter-btn ${showFilterSidebar?'active':''}`} onClick={()=>setShowFilterSidebar(!showFilterSidebar)}>
                            <Icon.Filter/>Filtres
                            {activeFilterCount>0&&<span className="filter-count">{activeFilterCount}</span>}
                        </button>
                        <div className="stats-pills">
                            <span className="stat-pill"><strong>{tasks.length}</strong> t√¢ches</span>
                            <span className="stat-pill"><strong>{(totalBudget/1000).toFixed(0)}k‚Ç¨</strong> budget</span>
                        </div>
                        <div className="toolbar-spacer"/>
                        <div className="new-btn-container" ref={exportDropdownRef}>
                            <button className="v11-btn-secondary" onClick={()=>{setShowCreateDropdown(false);setShowExportDropdown(!showExportDropdown);}}><Icon.Download size={13}/><span>Export</span></button>
                            {showExportDropdown&&<div className="dropdown-menu open" style={{minWidth:160}}>
                                <button onClick={()=>{setShowExportDropdown(false);exportToJSON();}} className="dropdown-item">Export JSON</button>
                                <button onClick={()=>{setShowExportDropdown(false);exportToCSV();}} className="dropdown-item">Export CSV</button>
                            </div>}
                        </div>
                        <div className="new-btn-container" ref={createDropdownRef}>
                            <button className={`v11-btn-primary ${showCreateDropdown?'open':''}`} onClick={()=>{setShowExportDropdown(false);setShowCreateDropdown(!showCreateDropdown);}}>
                                <Icon.Plus size={13}/>Cr√©er
                                <svg className="chevron" width="10" height="10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"/></svg>
                            </button>
                            {showCreateDropdown&&<div className="dropdown-menu open">
                                <button className="dropdown-item default" onClick={()=>{setShowCreateDropdown(false);handleCreateNewTask();}}>
                                    <div className="dropdown-item-icon task"><Icon.Check/></div>
                                    <div className="dropdown-item-content"><div className="dropdown-item-title">Nouvelle t√¢che</div><div className="dropdown-item-desc">Ajouter une t√¢che √† une action</div></div>
                                    <span className="dropdown-item-shortcut">N</span>
                                </button>
                                <button className="dropdown-item" onClick={()=>{setShowCreateDropdown(false);setShowNewActionModal(true);}}>
                                    <div className="dropdown-item-icon action"><Icon.List/></div>
                                    <div className="dropdown-item-content"><div className="dropdown-item-title">Nouvelle action</div><div className="dropdown-item-desc">Cr√©er un groupe de t√¢ches</div></div>
                                    <span className="dropdown-item-shortcut">‚áßN</span>
                                </button>
                                <div className="dropdown-divider"/>
                                <button className="dropdown-item" onClick={()=>{setShowCreateDropdown(false);setShowCategoriesModal(true);}}>
                                    <div className="dropdown-item-icon category"><Icon.Folder/></div>
                                    <div className="dropdown-item-content"><div className="dropdown-item-title">G√©rer les cat√©gories</div><div className="dropdown-item-desc">Cr√©er ou r√©organiser les groupes</div></div>
                                </button>
                            </div>}
                        </div>
                    </div>
                    {activeFilterCount>0&&(
                        <div className="active-filters">
                            <span className="active-filters-label">Filtres:</span>
                            {filters.search&&<div className="filter-chip">"{filters.search}"<button onClick={()=>setFilters({...filters,search:''})}>‚úï</button></div>}
                            {filters.status.map(s=>{const st=CONFIG.STATUSES.find(x=>x.id===s);return <div key={s} className="filter-chip" style={{display:'flex',alignItems:'center',gap:4}}><StatusIcon statusId={s} size={10}/> {st?.name}<button onClick={()=>setFilters({...filters,status:filters.status.filter(x=>x!==s)})}>‚úï</button></div>;})}
                            {filters.category.map(c=>{const cat=categories.find(x=>x.id===c);return <div key={c} className="filter-chip">{cat?.name}<button onClick={()=>setFilters({...filters,category:filters.category.filter(x=>x!==c)})}>‚úï</button></div>;})}
                            {filters.priority.map(p=>{const pr=CONFIG.PRIORITIES.find(x=>x.id===p);return <div key={p} className="filter-chip" style={{display:'flex',alignItems:'center',gap:4}}><div style={{width:7,height:7,borderRadius:'50%',background:pr?.color,flexShrink:0}}/> {pr?.name}<button onClick={()=>setFilters({...filters,priority:filters.priority.filter(x=>x!==p)})}>‚úï</button></div>;})}
                            {(filters.channel||[]).map(c=>{const ch=CONFIG.CHANNELS.find(x=>x.id===c);return <div key={c} className="filter-chip">{ch?.name}<button onClick={()=>setFilters({...filters,channel:filters.channel.filter(x=>x!==c)})}>‚úï</button></div>;})}
                            {(filters.country||[]).map(c=>{const co=allCountries.find(x=>x.id===c);return <div key={c} className="filter-chip">{co?.flag} {co?.name}<button onClick={()=>setFilters({...filters,country:filters.country.filter(x=>x!==c)})}>‚úï</button></div>;})}
                            <span className="clear-filters" onClick={()=>setFilters({search:'',status:[],category:[],priority:[],channel:[],country:[]})}>Tout effacer</span>
                        </div>
                    )}
                    {currentView==='kanban'&&<KanbanView categories={categories} actions={actions} tasks={tasks} onOpenTask={setSelectedTask} onOpenAction={setSelectedAction} onUpdateTask={handleUpdateTask} onUpdateAction={handleUpdateAction} onAddTask={handleAddNewTask} onAddAction={handleAddAction} onMoveTask={handleMoveTask} onReorderTask={handleReorderTask} onMoveAction={handleMoveAction} onReorderAction={handleReorderAction} filters={filters} setFilters={setFilters} allCountries={allCountries} selectedYear={selectedYear} onYearChange={setSelectedYear}/>}
                    {currentView==='timeline'&&<TimelineView categories={categories} actions={actions} tasks={tasks} onOpenTask={setSelectedTask} onOpenAction={setSelectedAction} onUpdateTask={handleUpdateTask} onUpdateAction={handleUpdateAction} onReorderAction={handleReorderAction} onAddTask={handleAddTask} filters={filters} setFilters={setFilters} selectedYear={selectedYear} onYearChange={setSelectedYear}/>}
                    {currentView==='dashboard'&&<DashboardView categories={categories} actions={actions} tasks={tasks}/>}
                </main>
                {selectedTask&&<TaskDetailModal categories={categories} task={selectedTask} action={actions.find(a=>a.id===selectedTask.actionId)} actions={actions} onClose={()=>setSelectedTask(null)} onUpdate={handleUpdateTask} onDelete={handleDeleteTask} onBackToAction={selectedAction?()=>{setSelectedTask(null);setSelectedAction(actions.find(a=>a.id===selectedTask.actionId));}:null} allCountries={allCountries} onAddCustomCountry={addCustomCountry}/>}
                {selectedAction&&!selectedTask&&<ActionDetailModal categories={categories} action={selectedAction} tasks={tasks} onClose={()=>setSelectedAction(null)} onUpdateAction={handleUpdateAction} onUpdateTask={handleUpdateTask} onOpenTask={t=>{setSelectedTask(t);}} onAddTask={handleAddTask} onDeleteAction={handleDeleteAction}/>}
                {/* GitHubSettingsModal supprim√© - Token int√©gr√© directement dans GITHUB_CONFIG */}
                {showCategoriesModal&&<CategoriesManagementModal categories={categories} onClose={()=>setShowCategoriesModal(false)} onUpdate={handleUpdateCategory} onAdd={handleAddCategory} onDelete={handleDeleteCategory} onReorder={handleReorderCategories} />}
                {showNewActionModal&&<NewActionModal categories={categories} onClose={()=>setShowNewActionModal(false)} onAdd={handleAddAction}/>}
                {showNewTaskModal&&<NewTaskModal actions={actions} categories={categories} onClose={()=>setShowNewTaskModal(false)} onAdd={handleAddNewTask} onCreateAction={()=>{setShowNewTaskModal(false);setShowNewActionModal(true);}}/>}
                <FilterSidebar show={showFilterSidebar} onClose={()=>setShowFilterSidebar(false)} filters={filters} setFilters={setFilters} categories={categories} allCountries={allCountries}/>
                {notification&&<div className="fixed bottom-4 right-4 px-4 py-3 animate-slide-in" style={{background:'var(--accent)',color:'white',borderRadius:'var(--radius-md)',boxShadow:'var(--shadow-lg)',fontSize:13,fontWeight:500}}>{notification}</div>}
            </div>
        </AppContext.Provider>
    );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
console.log('‚úÖ Application React charg√©e avec succ√®s');
</script>
<script>
// Fallback: si apr√®s 3 secondes le message de chargement est toujours l√†, afficher une erreur
setTimeout(() => {
    const root = document.getElementById('root');
    if (root && root.innerHTML.includes('Chargement de l\'application...')) {
        root.innerHTML = `
            <div class="min-h-screen flex items-center justify-center" style="background:var(--bg-page)">
                <div class="text-center max-w-md p-6" style="color:var(--text-primary)">
                    <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                    <h1 class="text-2xl font-bold mb-4">Erreur de chargement</h1>
                    <p class="mb-6" style="color:var(--text-muted)">L'application n'a pas pu se charger correctement.</p>
                    <div class="p-4 rounded-lg text-left text-sm mb-4" style="background:var(--bg-secondary)">
                        <p class="mb-2">Causes possibles:</p>
                        <ul class="list-disc list-inside space-y-1" style="color:var(--text-muted)">
                            <li>Les CDN (React, Babel) ne sont pas accessibles</li>
                            <li>Une erreur JavaScript bloque l'ex√©cution</li>
                            <li>Le navigateur bloque le chargement</li>
                        </ul>
                    </div>
                    <button onclick="location.reload()" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold">
                        üîÑ Recharger la page
                    </button>
                    <p class="text-xs mt-4" style="color:var(--text-muted)">Ouvrez la console (F12) pour plus d'informations</p>
                </div>
            </div>
        `;
    }
}, 3000);
</script>
</body>
</html>
